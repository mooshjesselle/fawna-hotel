{% extends "base.html" %}
{% block title %}Rooms{% endblock %}
{% block content %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/rooms.css') }}">
{% endblock %}
<div class="container">
    <br><h2 class="mb-4">Our Rooms</h2>

    <!-- Search and Filter -->
    <div class="card mb-4 search-card">
        <div class="card-body">
            <form id="searchForm" method="GET" class="row g-3 align-items-end">
                <div class="col-12 col-md-8">
                    <label for="search" class="form-label">Search Rooms</label>
                    <input type="text" class="form-control" id="search" name="search" 
                           placeholder="Search by room type, number, or amenities..."
                           value="{{ request.args.get('search', '') }}">
                </div>
                <div class="col-12 col-md-4">
                    <label for="room_type" class="form-label">Room Type</label>
                    <select class="form-control" id="room_type" name="room_type">
                        <option value="">All Types</option>
                        {% for type in room_types %}
                        <option value="{{ type.id }}" 
                                {% if request.args.get('room_type')|int == type.id %}selected{% endif %}>
                            {{ type.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-12 text-end">
                    <button type="submit" class="btn-search-avail">Search</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Searching for rooms...</p>
    </div>

    <!-- Promo Banner -->
    {% if promo %}
    <div class="alert alert-warning text-center mb-4" style="font-size: 1.2rem;">
        <strong>{{ promo.title }}</strong>: {{ promo.description }}<br>
        <span style="color: #d9534f; font-weight: bold;">{{ promo.discount_percentage|round(2) }}% OFF</span> &nbsp;|&nbsp; Valid: {{ promo.start_date.strftime('%b %d, %Y') }} – {{ promo.end_date.strftime('%b %d, %Y') }}
    </div>
    {% endif %}

    <!-- Room Listings -->
    <div class="rooms-fade-in-out">
        <div id="roomsContainer" class="row">
            {% for room in rooms %}
            <div class="col-md-4 mb-4 room-card">
                <div class="card h-100">
                    {% if room.image %}
                        <img src="{{ url_for('static', filename=room.image) }}" 
                             class="card-img-top" alt="{{ room.room_type.name }}">
                    {% else %}
                        <div class="default-room-image">
                            <i class="fas fa-bed"></i>
                        </div>
                    {% endif %}
                    <div class="card-body p-4">
                        <h5 class="card-title">{{ room.room_type.name }} - Room {{ room.room_number }}</h5>
                        <p class="card-text mb-2" style="height: 50px; overflow: hidden;">{{ room.room_type.description }}</p>
                        
                        <!-- Amenities Section -->
                        <div class="amenities-list">
                            {% if room.amenities %}
                                {% set amenity_count = room.amenities|length %}
                                {% for amenity in room.amenities[:3] %}
                                    <span class="amenity-badge">
                                        <i class="fas fa-{{ amenity.icon }}"></i> {{ amenity.name }}
                                    </span>
                                {% endfor %}
                                {% if amenity_count > 3 %}
                                    <span class="amenity-badge more-amenities" title="{% for amenity in room.amenities[3:] %}{{ amenity.name }}{% if not loop.last %}, {% endif %}{% endfor %}">
                                        +{{ amenity_count - 3 }} more
                                    </span>
                                {% endif %}
                            {% endif %}
                        </div>
                        
                        <!-- Rating Display -->
                        <div class="rating-display mb-2">
                            {% set room_rating = room_ratings[room.id] %}
                            {% if room_rating.review_count > 0 %}
                                <div class="d-flex align-items-center">
                                    <div class="stars">
                                        {% for i in range(1, 6) %}
                                            {% if i <= room_rating.avg_rating %}
                                                <i class="fas fa-star text-warning"></i>
                                            {% elif i <= room_rating.avg_rating + 0.5 %}
                                                <i class="fas fa-star-half-alt text-warning"></i>
                                            {% else %}
                                                <i class="far fa-star text-warning"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                    <span class="rating-value">{{ room_rating.avg_rating }}</span>
                                    <span class="rating-count">({{ room_rating.review_count }} {% if room_rating.review_count == 1 %}review{% else %}reviews{% endif %})</span>
                                </div>
                            {% else %}
                                <div class="d-flex align-items-center">
                                    <div class="stars">
                                        {% for i in range(5) %}
                                            <i class="far fa-star text-warning"></i>
                                        {% endfor %}
                                    </div>
                                    <span class="rating-empty">No reviews yet</span>
                                </div>
                            {% endif %}
                        </div>

                        <div class="d-flex justify-content-between align-items-center">
                            <div class="price-tag">
                                {% if promo and promo.discount_percentage > 0 %}
                                    {% set discounted_price = room.room_type.price_per_night * (1 - promo.discount_percentage / 100) %}
                                    <span class="fs-5 fw-bold text-primary">₱{{ "{:,.2f}".format(discounted_price) }}</span> <span class="text-decoration-line-through text-muted" style="font-size: 1rem;">₱{{ "{:,.2f}".format(room.room_type.price_per_night) }}</span> / night
                                {% else %}
                                <span class="fs-5 fw-bold text-primary">₱{{ "{:,.2f}".format(room.room_type.price_per_night) }}</span> / night
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mt-3 d-flex justify-content-between">
                            <a href="{{ url_for('room_detail', room_id=room.id) }}" class="rooms-list" style="margin-top:15px;">
                                <i class="fas fa-calendar-check me-2"></i>Book Now
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- No Results Message -->
    <div id="noResultsMessage" class="alert alert-info text-center" style="display: {% if rooms %}none{% else %}block{% endif %};">
        <i class="fas fa-info-circle fa-2x mb-3"></i>
        <h4>No Rooms Available</h4>
        <p>Sorry, there are no rooms matching your search criteria. Please try different dates or room types.</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get the CSRF token from meta tag
    const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;
    
    const searchForm = document.getElementById('searchForm');
    const searchInput = document.getElementById('search');
    const roomTypeSelect = document.getElementById('room_type');
    const roomsContainer = document.getElementById('roomsContainer');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const noResultsMessage = document.getElementById('noResultsMessage');
    
    // Initialize tooltips for more amenities badges
    const initializeTooltips = () => {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('.more-amenities'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    };
    
    // Run tooltip initialization on page load
    initializeTooltips();
    
    // Function to handle search with AJAX
    function performSearch() {
        // Show loading spinner
        roomsContainer.classList.add('fade-out');
        setTimeout(() => {
            roomsContainer.style.display = 'none';
            loadingSpinner.style.display = 'block';
        }, 300);
        
        // Get search parameters
        const searchValue = searchInput.value;
        const roomTypeValue = roomTypeSelect.value;
        
        // Create URL with query parameters
        const url = new URL(window.location.origin + '/rooms');
        if (searchValue) url.searchParams.append('search', searchValue);
        if (roomTypeValue) url.searchParams.append('room_type', roomTypeValue);
        url.searchParams.append('ajax', 'true');
        
        // Make AJAX request
        fetch(url.toString(), {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json',
                'X-CSRF-Token': csrfToken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Hide loading spinner
            loadingSpinner.style.display = 'none';
            
            // Update URL without reloading page
            const newUrl = new URL(window.location.href);
            if (searchValue) {
                newUrl.searchParams.set('search', searchValue);
            } else {
                newUrl.searchParams.delete('search');
            }
            
            if (roomTypeValue) {
                newUrl.searchParams.set('room_type', roomTypeValue);
            } else {
                newUrl.searchParams.delete('room_type');
            }
            
            window.history.pushState({}, '', newUrl);
            
            // Handle results
            if (data.html) {
                roomsContainer.innerHTML = data.html;
                roomsContainer.style.display = 'flex';
                roomsContainer.classList.remove('fade-out');
                roomsContainer.classList.add('fade-in');
                noResultsMessage.style.display = 'none';
                
                // Reinitialize tooltips after new content is loaded
                initializeTooltips();
            } else {
                roomsContainer.innerHTML = '';
                roomsContainer.style.display = 'none';
                noResultsMessage.style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Hide loading spinner and show error message
            loadingSpinner.style.display = 'none';
            roomsContainer.style.display = 'flex';
            roomsContainer.classList.remove('fade-out');
            
            // If there's an error, just reload the page normally
            searchForm.submit();
        });
    }
    
    // Add event listeners for search form
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        performSearch();
    });
    
    // Optional: Add debounced search as user types
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 500);
    });
    
    // Optional: Search when room type changes
    roomTypeSelect.addEventListener('change', performSearch);
});
</script>
{% endblock %} 