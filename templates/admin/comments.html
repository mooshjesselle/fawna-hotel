{% extends "admin/base_admin.html" %}

{% block title %}Comments Management - FAWNA Hotel{% endblock %}

{% block admin_content %}
<div class="admin-card">
    <div class="admin-card-header">
        <h2>Comments Management</h2>
        <div class="search-section">
            <div class="input-group search-input">
                <input type="text" class="form-control" id="searchComment" placeholder="Search comments...">
                <button class="btn btn-admin-primary" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category if category != 'message' else 'info' }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Visitor</th>
                    <th>Room</th>
                    <th>Rating</th>
                    <th>Comment</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for comment in comments %}
                <tr id="comment-row-{{ comment.id }}">
                    <td>{{ comment.author.name }}</td>
                    <td>{{ comment.booking.room.room_type.name }} {{ comment.booking.room.room_number }}</td>
                    <td>
                        <div class="rating">
                            {% for i in range(5) %}
                                {% if i < comment.rating %}
                                    <span class="text-warning">★</span>
                                {% else %}
                                    <span class="text-muted">☆</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </td>
                    <td>
                        {% if comment.content|length > 100 %}
                            {{ comment.content[:100] }}...
                        {% else %}
                            {{ comment.content }}
                        {% endif %}
                    </td>
                    <td>{{ format_datetime(comment.created_at, '%Y-%m-%d %I:%M %p') }}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-view btn-sm read-comment-btn"
                                data-id="{{ comment.id }}"
                                data-user="{{ comment.author.name }}"
                                data-room="{{ comment.booking.room.room_type.name }} {{ comment.booking.room.room_number }}"
                                data-rating="{{ comment.rating }}"
                                data-content="{{ comment.content }}"
                                data-date="{{ format_datetime(comment.created_at, '%Y-%m-%d %I:%M %p') }}"
                                title="View">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-delete btn-sm" onclick="confirmDeleteComment({{ comment.id }})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfirmationModalLabel">Delete Comment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this comment? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteComment()">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Read Comment Modal -->
<div class="modal fade" id="readCommentModal" tabindex="-1" aria-labelledby="readCommentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="readCommentModalLabel">Comment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="comment-details">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Visitor:</strong>
                            <p id="commentUser"></p>
                        </div>
                        <div class="col-md-6">
                            <strong>Room:</strong>
                            <p id="commentRoom"></p>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Rating:</strong>
                            <p id="commentRating"></p>
                        </div>
                        <div class="col-md-6">
                            <strong>Date:</strong>
                            <p id="commentDate"></p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <strong>Comment:</strong>
                            <p id="commentContent" class="mt-2 p-3 bg-light rounded"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let commentIdToDelete = null;

// Initialize event listeners for comment actions
document.addEventListener('DOMContentLoaded', function() {
    // Initialize all modals on the page
    const deleteModal = document.getElementById('deleteConfirmationModal');
    if (deleteModal) {
        console.log('Found delete modal, initializing...');
        new bootstrap.Modal(deleteModal);
    }
    
    // Read comment buttons
    document.querySelectorAll('.read-comment-btn').forEach(button => {
        button.addEventListener('click', function() {
            const data = this.dataset;
            readComment(
                data.id,
                data.user,
                data.room,
                parseInt(data.rating),
                data.content,
                data.date
            );
        });
    });

    // Delete comment buttons
    document.querySelectorAll('.delete-comment-btn').forEach(button => {
        button.addEventListener('click', function() {
            confirmDeleteComment(this.dataset.id);
        });
    });
    
    // Auto-fade existing flash messages
    autoFadeAlerts();
});

// Function to auto-fade alerts
function autoFadeAlerts() {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
        setTimeout(function() {
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 5000); // Fade after 5 seconds
    });
}

function confirmDeleteComment(commentId) {
    commentIdToDelete = commentId;
    console.log('Showing delete confirmation for comment ID:', commentId);
    
    // Get the modal element
    const modalElement = document.getElementById('deleteConfirmationModal');
    
    // Try to get an existing modal instance
    let modal = bootstrap.Modal.getInstance(modalElement);
    
    // If no instance exists, create a new one
    if (!modal) {
        console.log('Creating new modal instance');
        modal = new bootstrap.Modal(modalElement);
    } else {
        console.log('Using existing modal instance');
    }
    
    // Show the modal
    modal.show();
}

function deleteComment() {
    if (!commentIdToDelete) return;
    
    fetch(`/admin/comments/${commentIdToDelete}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('Response from server:', data);
        
        // Always close the modal first
        closeDeleteModal();
        
        if (data.success) {
            // Remove the comment row from the table
            const commentRow = document.getElementById(`comment-row-${commentIdToDelete}`);
            if (commentRow) {
                commentRow.remove();
            }
            
            // Show success message - but first check if there's already a flash message
            const existingFlashMessages = document.querySelectorAll('.flash-messages .alert-success');
            if (existingFlashMessages.length === 0) {
                // Create a new alert only if there isn't one already
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show';
                alert.innerHTML = `
                    ${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // Find where to append the alert
                const flashMessages = document.querySelector('.flash-messages');
                if (flashMessages) {
                    flashMessages.appendChild(alert);
                } else {
                    // If flash-messages doesn't exist, create it
                    const adminCard = document.querySelector('.admin-card');
                    const cardHeader = document.querySelector('.admin-card-header');
                    
                    if (adminCard && cardHeader) {
                        const newFlashMessages = document.createElement('div');
                        newFlashMessages.className = 'flash-messages';
                        newFlashMessages.appendChild(alert);
                        
                        // Insert after the card header
                        adminCard.insertBefore(newFlashMessages, cardHeader.nextSibling);
                    } else {
                        console.log('Could not find a place to show the alert');
                    }
                }
                
                // Auto-fade the alert after 5 seconds
                setTimeout(function() {
                    if (alert) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, 5000);
            }
        } else {
            // Show error message
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show';
            alert.innerHTML = `
                ${data.message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Find where to append the alert
            const flashMessages = document.querySelector('.flash-messages');
            if (flashMessages) {
                flashMessages.appendChild(alert);
                
                // Auto-fade the alert after 5 seconds
                setTimeout(function() {
                    if (alert) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, 5000);
            } else {
                console.log('Could not find .flash-messages to show error alert');
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        
        // Always close the modal even on error
        closeDeleteModal();
        
        // Show error message
        const alert = document.createElement('div');
        alert.className = 'alert alert-danger alert-dismissible fade show';
        alert.innerHTML = `
            An error occurred while deleting the comment.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Find where to append the alert
        const flashMessages = document.querySelector('.flash-messages');
        if (flashMessages) {
            flashMessages.appendChild(alert);
            
            // Auto-fade the alert after 5 seconds
            setTimeout(function() {
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 5000);
        } else {
            console.log('Could not find .flash-messages to show error alert');
        }
    });
}

// Helper function to close the delete confirmation modal
function closeDeleteModal() {
    console.log('Attempting to close modal...');
    const modal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmationModal'));
    console.log('Modal instance:', modal);
    
    if (modal) {
        modal.hide();
        console.log('Modal hide() called');
    } else {
        console.error('Modal instance not found');
        // Fallback method to close modal
        const modalElement = document.getElementById('deleteConfirmationModal');
        if (modalElement) {
            modalElement.classList.remove('show');
            modalElement.style.display = 'none';
            document.body.classList.remove('modal-open');
            
            // Remove backdrop
            const modalBackdrops = document.getElementsByClassName('modal-backdrop');
            while(modalBackdrops.length > 0) {
                modalBackdrops[0].parentNode.removeChild(modalBackdrops[0]);
            }
        }
    }
}

// Search functionality
document.getElementById('searchComment').addEventListener('input', function(e) {
    const searchText = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchText) ? '' : 'none';
    });
});

function readComment(id, user, room, rating, content, date) {
    // Set the comment details in the modal
    document.getElementById('commentUser').textContent = user;
    document.getElementById('commentRoom').textContent = room;
    
    // Create rating stars
    const ratingHtml = Array(5).fill(0).map((_, i) => 
        i < rating ? '<span class="text-warning">★</span>' : '<span class="text-muted">☆</span>'
    ).join('');
    document.getElementById('commentRating').innerHTML = ratingHtml;
    
    document.getElementById('commentDate').textContent = date;
    document.getElementById('commentContent').textContent = content;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('readCommentModal'));
    modal.show();
}
</script>

<style>
.action-buttons {
    display: flex;
    gap: 4px;
}

.light-button {
    background: linear-gradient(135deg, #42A5F5, #64B5F6);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-view,
.btn-edit,
.btn-delete {
    width: 36px;
    height: 36px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
}

.btn-view {
    background: linear-gradient(135deg, #42A5F5, #64B5F6);
    color: white;
}

.btn-view:hover {
    background: linear-gradient(135deg, #2196F3, #42A5F5);
    color: white;
}

.btn-edit {
    background-color: #ffc107;
    color: white;
    border: none;
}

.btn-edit:hover {
    background-color: #e0a800;
    color: white;
}

.btn-delete {
    background-color: #dc3545;
    color: white;
    border: none;
}

.btn-delete:hover {
    background-color: #c82333;
    color: white;
}

.action-buttons .btn i {
    font-size: 14px;
}

.comment-details p {
    margin-bottom: 0.5rem;
    font-size: 1rem;
}

.comment-details strong {
    color: var(--primary-color);
    display: block;
    margin-bottom: 0.25rem;
}

#commentContent {
    white-space: pre-wrap;
    font-size: 1rem;
    line-height: 1.5;
}

.modal-lg {
    max-width: 800px;
}

.bg-light {
    background-color: #f8f9fa;
}

/* Add auto-fade animation for alerts */
.alert {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>
{% endblock %} 