{% extends "admin/base_admin.html" %}

{% block title %}Manage Amenities - FAWNA Hotel{% endblock %}

{% block admin_content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Amenities Management</h2>
        <button class="light-button" data-bs-toggle="modal" data-bs-target="#addAmenityModal">
            <i class="fas fa-plus"></i> Add New Amenity
        </button>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Icon</th>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Additional Cost</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for amenity in amenities %}
                        <tr>
                            <td><i class="fas fa-{{ amenity.icon }} fa-lg"></i></td>
                            <td>{{ amenity.name }}</td>
                            <td>{{ amenity.description }}</td>
                            <td>
                                {% if amenity.additional_cost > 0 %}
                               ₱{{ "{:,.2f}".format(amenity.additional_cost) }}
                                {% else %}
                                Included
                                {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-view btn-sm" onclick="viewAmenity({{ amenity.id }})" title="View">
                                    <i class="fas fa-eye"></i>
                                </button>
                                    <button class="btn btn-edit btn-sm" onclick="editAmenity({{ amenity.id }})" title="Edit">
                                    <i class="fas fa-edit"></i>
                                </button>
                                    <button class="btn btn-delete btn-sm" onclick="deleteAmenity({{ amenity.id }})" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Amenity Modal -->
<div class="modal fade" id="addAmenityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Amenity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addAmenityForm" method="POST" action="{{ url_for('add_amenity') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="amenityName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="amenityName" name="name" required>
                        <div class="invalid-feedback" id="nameInvalidFeedback">
                            Please enter a valid name (2-50 characters)
                        </div>
                        <div class="word-count" id="nameWordCount">0/20 words</div>
                    </div>
                    <div class="mb-3">
                        <label for="amenityDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="amenityDescription" name="description" rows="3" required></textarea>
                        <div class="invalid-feedback" id="descriptionInvalidFeedback">
                            Please enter a valid description (10-500 characters)
                        </div>
                        <div class="word-count" id="descWordCount">0/100 words</div>
                    </div>
                    <div class="mb-3">
                        <label for="amenityIcon" class="form-label">Icon</label>
                        <div class="icon-selector-container">
                            <div class="input-group mb-2">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="iconSearch" placeholder="Search icons...">
                        </div>
                            <div class="icon-grid" id="iconGrid">
                                <!-- Icons will be populated here -->
                    </div>
                            <input type="hidden" id="selectedIcon" name="icon" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="additionalCost" class="form-label">Additional Cost per Night</label>
                        <div class="input-group">
                            <span class="input-group-text">₱</span>
                            <input type="number" class="form-control" id="additionalCost" 
                                   name="additional_cost" step="0.01" min="0" max="20000" value="0">
                            <div class="invalid-feedback" id="costInvalidFeedback">
                                Additional cost must be between 0 and ₱20,000
                            </div>
                        </div>
                        <div class="form-text">Leave as 0 if included in room price. Maximum limit: ₱20,000</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="light-button">Add Amenity</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Amenity Modal -->
<div class="modal fade" id="editAmenityModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Amenity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editAmenityForm" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editAmenityName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="editAmenityName" name="name" required>
                        <div class="invalid-feedback" id="editNameInvalidFeedback">
                            Please enter a valid name (2-50 characters)
                        </div>
                        <div class="word-count" id="editNameWordCount">0/20 words</div>
                    </div>
                    <div class="mb-3">
                        <label for="editAmenityDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editAmenityDescription" name="description" rows="3" required></textarea>
                        <div class="invalid-feedback" id="editDescriptionInvalidFeedback">
                            Please enter a valid description (10-500 characters)
                        </div>
                        <div class="word-count" id="editDescWordCount">0/100 words</div>
                    </div>
                    <div class="mb-3">
                        <label for="editAmenityIcon" class="form-label">Icon</label>
                        <div class="icon-selector-container">
                            <div class="input-group mb-2">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="editIconSearch" placeholder="Search icons...">
                            </div>
                            <div class="icon-grid" id="editIconGrid">
                                <!-- Icons will be populated here -->
                            </div>
                            <input type="hidden" id="editSelectedIcon" name="icon" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editAdditionalCost" class="form-label">Additional Cost per Night</label>
                        <div class="input-group">
                            <span class="input-group-text">₱</span>
                            <input type="text" class="form-control" id="editAdditionalCostFormatted" autocomplete="off" inputmode="decimal" pattern="[0-9,\.]*" required>
                            <input type="hidden" id="editAdditionalCost" name="additional_cost">
                            <div class="invalid-feedback" id="editCostInvalidFeedback">
                                Additional cost must be between 0 and ₱20,000
                            </div>
                        </div>
                        <div class="form-text">Leave as 0 if included in room price. Maximum limit: ₱20,000</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="light-button">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Delete Confirmation Modal -->
<div class="modal fade" id="deleteAmenityModal" tabindex="-1" aria-labelledby="deleteAmenityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteAmenityModalLabel">Delete Amenity</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this amenity?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteAmenity()">Delete</button>
            </div>
        </div>
    </div>
</div>

<style>
.icon-selector-container {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    max-height: 300px;
    overflow-y: auto;
}

.icon-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
    gap: 0.5rem;
    margin-top: 1rem;
}

.icon-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.5rem;
    border: 1px solid transparent;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: all 0.2s;
}

.icon-item:hover {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

.icon-item.selected {
    background-color: #e9ecef;
    border-color: #0d6efd;
}

.icon-item i {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
}

.icon-item span {
    font-size: 0.75rem;
    text-align: center;
    word-break: break-word;
}

.action-buttons {
    display: flex;
    gap: 4px;
}

.available-badge {
    background-color: #66BB6A !important;
    color: white;
}

.occupied-badge {
    background-color: #dc3545 !important;
    color: white;
}

.word-count {
    font-size: 0.85rem;
    color: #6c757d;
    text-align: right;
    margin-top: 0.25rem;
}

.word-count.exceeded {
    color: #dc3545;
    font-weight: bold;
}

.btn-view {
    background: linear-gradient(135deg, #42A5F5, #64B5F6);
    color: white;
    border: none;
}

.btn-view:hover {
    background: linear-gradient(135deg, #2196F3, #42A5F5);
    color: white;
}

.light-button {
    background: linear-gradient(135deg, #42A5F5, #64B5F6);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-view,
.btn-edit,
.btn-delete {
    width: 36px;
    height: 36px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
}

.btn-view {
    background-color: #17a2b8;
    color: white;
}

.btn-view:hover {
    background-color: #138496;
    color: white;
}

.btn-edit {
    background-color: #ffc107;
    color: white;
}

.btn-edit:hover {
    background-color: #e0a800;
    color: white;
}

.btn-delete {
    background-color: #dc3545;
    color: white;
}

.btn-delete:hover {
    background-color: #c82333;
    color: white;
}

.action-buttons .btn i {
    font-size: 14px;
}

/* Styles for the icon picker */
.icon-selector-container {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    max-height: 300px;
    overflow-y: auto;
}

.icon-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
    gap: 0.5rem;
    margin-top: 1rem;
}

.icon-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 0.5rem;
    border: 1px solid transparent;
    border-radius: 0.25rem;
    cursor: pointer;
    transition: all 0.2s;
}

.icon-item:hover {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

.icon-item.selected {
    background-color: #e9ecef;
    border-color: #0d6efd;
}

.icon-item i {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
}

.icon-item span {
    font-size: 0.75rem;
    text-align: center;
    word-break: break-word;
}
</style>

<script>
let editModal = null;
let addAmenityModal = null;
let deleteModal = null;
let allIcons = [];
let amenityIdToDelete = null;

// Common icons for hotel amenities
const commonIcons = [
    // Room Features
    'bed', 'bath', 'shower', 'toilet', 'door-closed', 'door-open', 'window-maximize', 'couch',
    'chair', 'table', 'desktop', 'lightbulb', 'fan', 'snowflake', 'tv',
    'wifi', 'plug', 'battery-full', 'key', 'lock', 'unlock',
    
    // Hotel Services
    'swimming-pool', 'spa', 'dumbbell', 'utensils', 'coffee', 'wine-glass-alt',
    'concierge-bell', 'business-time', 'parking', 'shuttle-van', 'taxi',
    'luggage-cart', 'bell', 'clock', 'calendar-alt',
    
    // Safety & Accessibility
    'first-aid', 'fire-extinguisher', 'exclamation-triangle', 'info-circle',
    'wheelchair', 'child', 'paw', 'smoking-ban', 'shield-alt',
    
    // Entertainment & Business
    'laptop', 'headphones', 'video', 'camera', 'phone', 'mobile-alt',
    'print', 'fax', 'envelope', 'newspaper',
    
    // Additional Amenities
    'umbrella-beach', 'hot-tub', 'temperature-high', 'broom', 'tint', 'wind', 'sun', 'moon', 'star'
];

// Word count validation functions
function countWords(text) {
    return text.trim().split(/\s+/).filter(word => word.length > 0).length;
}

function hasRepeatedCharacters(text, limit = 5) {
    const repeatedCharRegex = new RegExp(`(.)\\1{${limit-1},}`, 'g');
    return repeatedCharRegex.test(text);
}

function updateWordCount(element, countElement, limit) {
    const words = countWords(element.value);
    countElement.textContent = `${words}/${limit} words`;
    
    if (words > limit) {
        countElement.classList.add('exceeded');
    } else {
        countElement.classList.remove('exceeded');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    editModal = new bootstrap.Modal(document.getElementById('editAmenityModal'));
    addAmenityModal = new bootstrap.Modal(document.getElementById('addAmenityModal'));
    deleteModal = new bootstrap.Modal(document.getElementById('deleteAmenityModal'));
    
    // Initialize icon grids
    initializeIconGrid('iconGrid', 'iconSearch', 'selectedIcon');
    initializeIconGrid('editIconGrid', 'editIconSearch', 'editSelectedIcon');
    
    // Initialize word count for add form
    const nameInput = document.getElementById('amenityName');
    const descInput = document.getElementById('amenityDescription');
    
    if (nameInput && document.getElementById('nameWordCount')) {
        nameInput.addEventListener('input', function() {
            updateWordCount(this, document.getElementById('nameWordCount'), 20);
        });
    }
    
    if (descInput && document.getElementById('descWordCount')) {
        descInput.addEventListener('input', function() {
            updateWordCount(this, document.getElementById('descWordCount'), 100);
        });
    }
    
    // Initialize word count for edit form
    const editNameInput = document.getElementById('editAmenityName');
    const editDescInput = document.getElementById('editAmenityDescription');
    
    if (editNameInput && document.getElementById('editNameWordCount')) {
        editNameInput.addEventListener('input', function() {
            updateWordCount(this, document.getElementById('editNameWordCount'), 20);
        });
    }
    
    if (editDescInput && document.getElementById('editDescWordCount')) {
        editDescInput.addEventListener('input', function() {
            updateWordCount(this, document.getElementById('editDescWordCount'), 100);
        });
    }

    const editAdditionalCostFormattedInput = document.getElementById('editAdditionalCostFormatted');
    const editAdditionalCostHiddenInput = document.getElementById('editAdditionalCost');
    if (editAdditionalCostFormattedInput && editAdditionalCostHiddenInput) {
        // Format initial value if present
        if (editAdditionalCostFormattedInput.value) {
            let raw = editAdditionalCostFormattedInput.value.replace(/,/g, '');
            let floatVal = parseFloat(raw);
            if (!isNaN(floatVal)) {
                editAdditionalCostFormattedInput.value = floatVal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                editAdditionalCostHiddenInput.value = floatVal.toFixed(2);
            }
        }
        editAdditionalCostFormattedInput.addEventListener('input', function() {
            let raw = this.value.replace(/,/g, '');
            raw = raw.replace(/[^0-9.]/g, '');
            const parts = raw.split('.');
            let intPart = parts[0];
            let decPart = parts[1] ? parts[1].slice(0,2) : '';
            intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            let formatted = intPart;
            if (decPart.length > 0) {
                formatted += '.' + decPart;
            }
            this.value = formatted;
            let floatVal = parseFloat(raw);
            if (!isNaN(floatVal)) {
                editAdditionalCostHiddenInput.value = floatVal.toFixed(2);
            } else {
                editAdditionalCostHiddenInput.value = '';
            }
        });
        editAdditionalCostFormattedInput.addEventListener('blur', function() {
            let raw = this.value.replace(/,/g, '');
            let floatVal = parseFloat(raw);
            if (!isNaN(floatVal)) {
                let formatted = floatVal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                this.value = formatted;
                editAdditionalCostHiddenInput.value = floatVal.toFixed(2);
            }
        });
    }
});

function initializeIconGrid(gridId, searchId, selectedIconId) {
    const grid = document.getElementById(gridId);
    const search = document.getElementById(searchId);
    const selectedIcon = document.getElementById(selectedIconId);
    
    // Populate icons
    commonIcons.forEach(icon => {
        const iconItem = document.createElement('div');
        iconItem.className = 'icon-item';
        iconItem.innerHTML = `
            <i class="fas fa-${icon}"></i>
            <span>${icon}</span>
        `;
        
        iconItem.addEventListener('click', () => {
            // Remove selected class from all items
            grid.querySelectorAll('.icon-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selected class to clicked item
            iconItem.classList.add('selected');
            
            // Update hidden input
            selectedIcon.value = icon;
        });
        
        grid.appendChild(iconItem);
    });
    
    // Add search functionality
    search.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        grid.querySelectorAll('.icon-item').forEach(item => {
            const iconName = item.querySelector('span').textContent;
            if (iconName.includes(searchTerm)) {
                item.style.display = '';
            } else {
                item.style.display = 'none';
            }
        });
    });
}

function viewAmenity(amenityId) {
    fetch(`/admin/amenities/${amenityId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch amenity details');
            }
            return response.json();
        })
        .then(data => {
            alert(`Amenity Details:\nName: ${data.name}\nDescription: ${data.description}\nIcon: ${data.icon}\nAdditional Cost: ₱${data.additional_cost}`);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to fetch amenity details');
        });
}

function editAmenity(amenityId) {
    fetch(`/admin/amenities/${amenityId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch amenity details');
            }
            return response.json();
        })
        .then(data => {
            // Populate the edit form
            document.getElementById('editAmenityName').value = data.name;
            document.getElementById('editAmenityDescription').value = data.description;
            document.getElementById('editSelectedIcon').value = data.icon;
            document.getElementById('editAdditionalCostFormatted').value = data.additional_cost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('editAdditionalCost').value = parseFloat(data.additional_cost).toFixed(2);
            
            // Select the current icon in the grid
            const grid = document.getElementById('editIconGrid');
            grid.querySelectorAll('.icon-item').forEach(item => {
                if (item.querySelector('span').textContent === data.icon) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
            
            // Update form action and add event listener
            const form = document.getElementById('editAmenityForm');
            form.setAttribute('data-amenity-id', amenityId);
            
            // Show the modal
            editModal.show();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to fetch amenity details for editing');
        });
}

// Form validation
document.getElementById('addAmenityForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const nameInput = document.getElementById('amenityName');
    const descInput = document.getElementById('amenityDescription');
    const costInput = document.getElementById('additionalCost');
    const iconInput = document.getElementById('selectedIcon');
    let isValid = true;
    
    // Reset validation states
    nameInput.classList.remove('is-invalid');
    descInput.classList.remove('is-invalid');
    costInput.classList.remove('is-invalid');
    
    // Validate name
    if (nameInput.value.length < 2 || nameInput.value.length > 50) {
        nameInput.classList.add('is-invalid');
        document.getElementById('nameInvalidFeedback').textContent = 'Name must be between 2 and 50 characters.';
        isValid = false;
    } else if (countWords(nameInput.value) > 20) {
        nameInput.classList.add('is-invalid');
        document.getElementById('nameInvalidFeedback').textContent = 'Name cannot exceed 20 words.';
        isValid = false;
    } else if (hasRepeatedCharacters(nameInput.value, 5)) {
        nameInput.classList.add('is-invalid');
        document.getElementById('nameInvalidFeedback').textContent = 'Name contains too many repeated characters.';
        isValid = false;
    }
    
    // Validate description
    if (descInput.value.length < 10 || descInput.value.length > 500) {
        descInput.classList.add('is-invalid');
        document.getElementById('descriptionInvalidFeedback').textContent = 'Description must be between 10 and 500 characters.';
        isValid = false;
    } else if (countWords(descInput.value) > 100) {
        descInput.classList.add('is-invalid');
        document.getElementById('descriptionInvalidFeedback').textContent = 'Description cannot exceed 100 words.';
        isValid = false;
    } else if (hasRepeatedCharacters(descInput.value, 5)) {
        descInput.classList.add('is-invalid');
        document.getElementById('descriptionInvalidFeedback').textContent = 'Description contains too many repeated characters.';
        isValid = false;
    }
    
    // Validate additional cost
    const additionalCost = parseFloat(costInput.value);
    if (isNaN(additionalCost) || additionalCost < 0 || additionalCost > 20000) {
        costInput.classList.add('is-invalid');
        document.getElementById('costInvalidFeedback').textContent = 'Additional cost must be between 0 and ₱20,000.';
        isValid = false;
    }
    
    // Validate icon selection
    if (!iconInput.value) {
        isValid = false;
        alert('Please select an icon.');
    }
    
    if (!isValid) {
        return;
    }
    
    fetch(this.action, {
        method: 'POST',
        body: new FormData(this),
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Hide the add amenity modal
            addAmenityModal.hide();
            
            // Show success alert
            alert(data.message);
            
            // Reset form and reload page
            this.reset();
            window.location.reload();
        } else {
            throw new Error(data.message || 'Failed to add amenity');
        }
    })
    .catch(error => {
        // Hide the add amenity modal
        addAmenityModal.hide();
        
        // Show error alert
        alert(error.message);
    });
});

// Update the edit form submission validation
document.getElementById('editAmenityForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const nameInput = document.getElementById('editAmenityName');
    const descInput = document.getElementById('editAmenityDescription');
    const editAdditionalCostFormattedInput = document.getElementById('editAdditionalCostFormatted');
    const editAdditionalCostHiddenInput = document.getElementById('editAdditionalCost');
    let isValid = true;
    
    // Reset validation states
    nameInput.classList.remove('is-invalid');
    descInput.classList.remove('is-invalid');
    
    // Validate name
    if (nameInput.value.length < 2 || nameInput.value.length > 50) {
        nameInput.classList.add('is-invalid');
        document.getElementById('editNameInvalidFeedback').textContent = 'Name must be between 2 and 50 characters.';
        isValid = false;
    } else if (countWords(nameInput.value) > 20) {
        nameInput.classList.add('is-invalid');
        document.getElementById('editNameInvalidFeedback').textContent = 'Name cannot exceed 20 words.';
        isValid = false;
    } else if (hasRepeatedCharacters(nameInput.value, 5)) {
        nameInput.classList.add('is-invalid');
        document.getElementById('editNameInvalidFeedback').textContent = 'Name contains too many repeated characters.';
        isValid = false;
    }
    
    // Validate description
    if (descInput.value.length < 10 || descInput.value.length > 500) {
        descInput.classList.add('is-invalid');
        document.getElementById('editDescriptionInvalidFeedback').textContent = 'Description must be between 10 and 500 characters.';
        isValid = false;
    } else if (countWords(descInput.value) > 100) {
        descInput.classList.add('is-invalid');
        document.getElementById('editDescriptionInvalidFeedback').textContent = 'Description cannot exceed 100 words.';
        isValid = false;
    } else if (hasRepeatedCharacters(descInput.value, 5)) {
        descInput.classList.add('is-invalid');
        document.getElementById('editDescriptionInvalidFeedback').textContent = 'Description contains too many repeated characters.';
        isValid = false;
    }
    
    // Validate additional cost
    const additionalCost = parseFloat(editAdditionalCostHiddenInput.value);
    if (isNaN(additionalCost) || additionalCost < 0 || additionalCost > 20000) {
        editAdditionalCostFormattedInput.classList.add('is-invalid');
        document.getElementById('editCostInvalidFeedback').textContent = 'Additional cost must be between 0 and ₱20,000.';
        isValid = false;
    } else {
        editAdditionalCostFormattedInput.classList.remove('is-invalid');
    }
    
    // Validate icon selection
    if (!document.getElementById('editSelectedIcon').value) {
        isValid = false;
        alert('Please select an icon.');
    }
    
    if (!isValid) {
        return;
    }
    
    const amenityId = this.getAttribute('data-amenity-id');
    const formData = new FormData(this);
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    
    fetch(`/admin/amenities/${amenityId}/edit`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || 'Failed to update amenity');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Close the modal and show success message
            editModal.hide();
            alert('Amenity updated successfully');
            // Reload the page to show updated data
            window.location.reload();
        } else {
            throw new Error(data.message || 'Failed to update amenity');
        }
    })
    .catch(error => {
        alert(error.message);
    });
});

function deleteAmenity(amenityId) {
    amenityIdToDelete = amenityId;
    deleteModal.show();
}

function confirmDeleteAmenity() {
    if (!amenityIdToDelete) return;
    
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    const row = document.querySelector(`button[onclick="deleteAmenity(${amenityIdToDelete})"]`).closest('tr');
    
    fetch(`/admin/amenities/${amenityIdToDelete}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || 'Failed to delete amenity');
            });
        }
        return response.json();
    })
    .then(data => {
        // Close the modal first
        deleteModal.hide();
        
        if (data.success) {
            row.remove();
            
            // Show success message
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success alert-dismissible fade show mt-3';
            successAlert.innerHTML = `
                ${data.message || 'Amenity deleted successfully'}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Insert alert at the top of the table container
            const tableContainer = document.querySelector('.card-body');
            tableContainer.insertBefore(successAlert, tableContainer.firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                const bsAlert = new bootstrap.Alert(successAlert);
                bsAlert.close();
            }, 5000);
            
            // If there are no more amenities, refresh the page
            const remainingRows = document.querySelectorAll('table tbody tr').length;
            if (remainingRows === 0) {
                setTimeout(() => {
                    window.location.href = window.location.pathname;
                }, 500);
            }
        } else {
            // Show error message
            alert(data.message || 'Failed to delete amenity');
        }
    })
    .catch(error => {
        deleteModal.hide();
        console.error('Error:', error);
        alert(error.message || 'An error occurred while deleting the amenity');
    });
}
</script>
{% endblock %} 