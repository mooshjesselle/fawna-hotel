{% extends "admin/base_admin.html" %}

{% block title %}Manage Rooms - FAWNA Hotel{% endblock %}

{% block admin_content %}
<!-- Add CSRF Token meta tag -->
<meta name="csrf-token" content="{{ csrf_token() }}">

<!-- Add Cropper.js CSS and JS in the head -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Room Management</h2>
        <button class="light-button" data-bs-toggle="modal" data-bs-target="#addRoomModal">
            <i class="fas fa-plus"></i> Add New Room
        </button>
    </div>

    <div class="mb-3">
        <input type="text" id="roomSearchInput" class="form-control" placeholder="Search by room number, type, or floor...">
    </div>

    <!-- Room Type Management -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4>Room Types</h4>
            <button class="green-button" data-bs-toggle="modal" data-bs-target="#addRoomTypeModal">
                <i class="fas fa-plus"></i> Add Room Type
            </button>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Description</th>
                            <th>Price per Night</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for room_type in room_types %}
                        <tr>
                            <td>{{ room_type.name }}</td>
                            <td>{{ room_type.description }}</td>
                          <td>₱{{ "{:,.2f}".format(room_type.price_per_night) }}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-view btn-sm" onclick="viewRoomType({{ room_type.id }})" title="View">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-edit btn-sm" onclick="editRoomType({{ room_type.id }})" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-delete btn-sm" onclick="deleteRoomType({{ room_type.id }})" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Rooms List -->
    <div class="card">
        <div class="card-header">
            <h4>Rooms</h4>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Room Number</th>
                            <th>Type</th>
                            <th>Floor</th>
                            <th>Status</th>
                            <th>Amenities</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for room in rooms %}
                        <tr>
                            <td>
                                {% if room.image %}
                                <img src="{{ url_for('static', filename=room.image) }}" 
                                     alt="Room {{ room.room_number }}" 
                                     class="img-thumbnail" 
                                     style="max-width: 100px; height: 75px; object-fit: cover;">
                                {% else %}
                                <div class="text-center p-3 bg-light rounded" style="max-width: 100px; height: 75px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-bed fa-2x text-secondary"></i>
                                </div>
                                {% endif %}
                            </td>
                            <td>{{ room.room_number }}</td>
                            <td>{{ room.room_type.name }}</td>
                            <td>{{ room.floor }}</td>
                            <td>
                                <span class="badge {% if room.is_available %}available-badge{% else %}occupied-badge{% endif %}">{{ 'Available' if room.is_available else 'Unavailable' }}</span>
                            </td>
                            <td>
                                {% for amenity in room.amenities %}
                                <span class="badge bg-info me-1">{{ amenity.name }}</span>
                                {% endfor %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-view btn-sm" onclick="viewRoom({{ room.id }})" title="View">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-edit btn-sm" onclick="editRoom({{ room.id }})" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-delete btn-sm" onclick="deleteRoom({{ room.id }})" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add Room Modal -->
<div class="modal fade" id="addRoomModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Room</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addRoomForm" method="POST" action="{{ url_for('admin_rooms') }}" 
                  enctype="multipart/form-data" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="cropped_image" id="cropped_image">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="roomNumber" class="form-label">Room Number</label>
                        <input type="text" class="form-control" id="roomNumber" name="room_number" 
                               pattern="^\d+[A-Za-z]?$" 
                               title="Room number must be a number optionally followed by a letter"
                               required
                               minlength="2"
                               maxlength="10">
                        <div class="invalid-feedback">
                            Please enter a valid room number (e.g., 101 or 101A)
                        </div>
                        <div class="form-text">Example: 101 or 101A</div>
                    </div>
                    <div class="mb-3">
                        <label for="roomType" class="form-label">Room Type</label>
                        <select class="form-select" id="roomType" name="room_type_id" required>
                            <option value="">Select a room type</option>
                            {% for room_type in room_types %}
                            <option value="{{ room_type.id }}">
                                {{ room_type.name }} - ₱{{ "%.2f"|format(room_type.price_per_night) }}/night
                            </option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">
                            Please select a room type
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="floor" class="form-label">Floor</label>
                        <input type="number" class="form-control" id="floor" name="floor" 
                               min="1" max="100" required>
                        <div class="invalid-feedback">
                            Floor number must be between 1 and 100
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="occupancyLimit" class="form-label">Occupancy Limit</label>
                        <input type="number" class="form-control" id="occupancyLimit" 
                               name="occupancy_limit" min="1" max="10" value="2" required>
                        <div class="invalid-feedback">
                            Occupancy limit must be between 1 and 10 guests
                        </div>
                        <div class="form-text">Maximum number of guests allowed in this room</div>
                    </div>
                    <div class="mb-3">
                        <label for="roomImage" class="form-label">Room Image</label>
                        <input type="file" class="form-control" id="roomImage" name="image" 
                               accept="image/*" onchange="validateAndLoadImage(this)">
                        <div class="invalid-feedback">
                            Please select a valid image file (JPG, PNG, or GIF)
                        </div>
                        <div id="previewContainer" class="mt-2 d-none">
                            <img id="previewImage" class="img-thumbnail" style="max-height: 200px;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amenities</label>
                        <div class="amenities-list row">
                            {% if amenities %}
                                {% for amenity in amenities %}
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               name="amenities" value="{{ amenity.id }}" 
                                               id="amenity{{ amenity.id }}">
                                        <label class="form-check-label" for="amenity{{ amenity.id }}">
                                            <i class="fas {{ amenity.icon }}"></i> {{ amenity.name }}
                                            {% if amenity.additional_cost > 0 %}
                                            <span class="text-muted">
                                                (+₱{{ "%.2f"|format(amenity.additional_cost) }}/night)
                                            </span>
                                            {% endif %}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="col-12">
                                    <div class="alert alert-info d-flex align-items-center" role="alert">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <div>
                                            No amenities available. Please add amenities first.
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="light-button">Add Room</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Room Type Modal -->
<div class="modal fade" id="addRoomTypeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Room Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addRoomTypeForm" method="POST" action="{{ url_for('admin_add_room_type') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="typeName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="typeName" name="name" required
                               minlength="3" maxlength="50">
                        <div class="invalid-feedback" id="typeNameFeedback">
                            Room type name must be between 3 and 50 characters.
                        </div>
                        <div class="word-count" id="typeNameWordCount">0/20 words</div>
                    </div>
                    <div class="mb-3">
                        <label for="typeDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="typeDescription" name="description" 
                                  rows="3" required minlength="10" maxlength="500"></textarea>
                        <div class="invalid-feedback" id="typeDescriptionFeedback">
                            Description must be between 10 and 500 characters.
                        </div>
                        <div class="word-count" id="typeDescWordCount">0/100 words</div>
                    </div>
                    <div class="mb-3">
                        <label for="basePrice" class="form-label">Base Price</label>
                        <div class="input-group">
                            <span class="input-group-text">₱</span>
                            <input type="text" class="form-control" id="basePriceFormatted" autocomplete="off" inputmode="decimal" pattern="[0-9,\.]*" required>
                            <input type="hidden" id="basePrice" name="price_per_night">
                            <div class="invalid-feedback" id="basePriceFeedback">
                                Price must be between 0 and ₱50,000.
                            </div>
                        </div>
                        <div class="form-text">Maximum price limit: ₱50,000</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="light-button">Add Room Type</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Cropping Modal -->
<div class="modal fade" id="imageCropModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crop Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="img-container" style="height: 400px;">
                    <img id="cropperImage" src="" style="display: block; max-width: 100%;">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="cropImage()">
                    <i class="fas fa-crop"></i> Crop & Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Room Modal -->
<div class="modal fade" id="deleteRoomModal" tabindex="-1" aria-labelledby="deleteRoomModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteRoomModalLabel">Delete Room</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this room?</p>
                <p>This action cannot be undone. Any associated bookings or data will be lost.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteRoom()">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Room Type Modal -->
<div class="modal fade" id="deleteRoomTypeModal" tabindex="-1" aria-labelledby="deleteRoomTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteRoomTypeModalLabel">Delete Room Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this room type?</p>
                <p>This will also delete all rooms of this type and cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteRoomType()">Delete</button>
            </div>
        </div>
    </div>
</div>

<script>
let cropper = null;
let cropModal = null;
let deleteRoomModal = null;
let deleteRoomTypeModal = null;
let roomIdToDelete = null;
let roomTypeIdToDelete = null;
let addRoomTypeModal = null;
let addRoomModal = null;

// Add helper functions for word count and repeated character detection
function countWords(text) {
    return text.trim().split(/\s+/).filter(word => word.length > 0).length;
}

function hasRepeatedCharacters(text, limit = 5) {
    const repeatedCharRegex = new RegExp(`(.)\\1{${limit-1},}`, 'g');
    return repeatedCharRegex.test(text);
}

function updateWordCount(element, countElement, limit) {
    const words = countWords(element.value);
    countElement.textContent = `${words}/${limit} words`;
    
    if (words > limit) {
        countElement.classList.add('exceeded');
    } else {
        countElement.classList.remove('exceeded');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize modals with static backdrop
    cropModal = new bootstrap.Modal(document.getElementById('imageCropModal'), {
        backdrop: 'static',
        keyboard: false
    });
    
    // Initialize modals
    addRoomTypeModal = new bootstrap.Modal(document.getElementById('addRoomTypeModal'));
    addRoomModal = new bootstrap.Modal(document.getElementById('addRoomModal'), {
        backdrop: 'static',
        keyboard: false
    });
    deleteRoomModal = new bootstrap.Modal(document.getElementById('deleteRoomModal'));
    deleteRoomTypeModal = new bootstrap.Modal(document.getElementById('deleteRoomTypeModal'));
    
    // Add event listener for modal close
    document.getElementById('imageCropModal').addEventListener('hidden.bs.modal', function() {
        cleanupCropper();
    });
    
    // Reset form and image when add room modal is closed
    document.getElementById('addRoomModal').addEventListener('hidden.bs.modal', function() {
        // Reset the room image input
        const roomImageInput = document.getElementById('roomImage');
        if (roomImageInput) {
            roomImageInput.value = '';
        }
        
        // Hide preview container
        const previewContainer = document.getElementById('previewContainer');
        if (previewContainer) {
            previewContainer.classList.add('d-none');
        }
        
        // Reset cropped image hidden input
        const croppedImageInput = document.getElementById('cropped_image');
        if (croppedImageInput) {
            croppedImageInput.value = '';
        }
        
        // Remove any success message
        const successMessage = document.querySelector('.alert-success');
        if (successMessage) {
            successMessage.remove();
        }
    });

    // Initialize word count for room type inputs
    const typeNameInput = document.getElementById('typeName');
    const typeDescInput = document.getElementById('typeDescription');
    const basePriceInput = document.getElementById('basePrice');
    
    // Initialize room inputs
    const roomNumberInput = document.getElementById('roomNumber');
    const floorInput = document.getElementById('floor');
    const occupancyLimitInput = document.getElementById('occupancyLimit');
    const roomTypeSelect = document.getElementById('roomType');
    
    // Add real-time validation for room type inputs
    if (typeNameInput) {
        typeNameInput.addEventListener('input', function() {
            updateWordCount(this, document.getElementById('typeNameWordCount'), 20);
            
            // Real-time validation
            if (this.value.length < 3 || this.value.length > 50) {
                this.classList.add('is-invalid');
                document.getElementById('typeNameFeedback').textContent = 'Room type name must be between 3 and 50 characters.';
            } else if (countWords(this.value) > 20) {
                this.classList.add('is-invalid');
                document.getElementById('typeNameFeedback').textContent = 'Name cannot exceed 20 words.';
            } else if (hasRepeatedCharacters(this.value, 5)) {
                this.classList.add('is-invalid');
                document.getElementById('typeNameFeedback').textContent = 'Name contains too many repeated characters.';
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }
    
    if (typeDescInput) {
        typeDescInput.addEventListener('input', function() {
            updateWordCount(this, document.getElementById('typeDescWordCount'), 100);
            
            // Real-time validation
            if (this.value.length < 10 || this.value.length > 500) {
                this.classList.add('is-invalid');
                document.getElementById('typeDescriptionFeedback').textContent = 'Description must be between 10 and 500 characters.';
            } else if (countWords(this.value) > 100) {
                this.classList.add('is-invalid');
                document.getElementById('typeDescriptionFeedback').textContent = 'Description cannot exceed 100 words.';
            } else if (hasRepeatedCharacters(this.value, 5)) {
                this.classList.add('is-invalid');
                document.getElementById('typeDescriptionFeedback').textContent = 'Description contains too many repeated characters.';
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }
    
    const basePriceFormattedInput = document.getElementById('basePriceFormatted');
    const basePriceHiddenInput = document.getElementById('basePrice');
    if (basePriceFormattedInput && basePriceHiddenInput) {
        basePriceFormattedInput.addEventListener('input', function() {
            // Remove all non-numeric except dot
            let raw = this.value.replace(/,/g, '');
            // Only allow numbers and one dot
            raw = raw.replace(/[^0-9.]/g, '');
            const parts = raw.split('.');
            let intPart = parts[0];
            let decPart = parts[1] ? parts[1].slice(0,2) : '';
            // Format integer part with commas
            intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            let formatted = intPart;
            if (decPart.length > 0) {
                formatted += '.' + decPart;
            }
            this.value = formatted;
            // Set hidden input to raw float value
            let floatVal = parseFloat(raw);
            if (!isNaN(floatVal)) {
                basePriceHiddenInput.value = floatVal.toFixed(2);
            } else {
                basePriceHiddenInput.value = '';
            }
        });
        // On blur, force two decimals
        basePriceFormattedInput.addEventListener('blur', function() {
            let raw = this.value.replace(/,/g, '');
            let floatVal = parseFloat(raw);
            if (!isNaN(floatVal)) {
                let formatted = floatVal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                this.value = formatted;
                basePriceHiddenInput.value = floatVal.toFixed(2);
            }
        });
    }
    
    // Add real-time validation for room inputs
    if (roomNumberInput) {
        roomNumberInput.addEventListener('input', function() {
            if (!/^\d+[A-Za-z]?$/.test(this.value)) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }
    
    if (floorInput) {
        floorInput.addEventListener('input', function() {
            const floorNum = parseInt(this.value);
            if (isNaN(floorNum) || floorNum < 1 || floorNum > 100) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }
    
    if (occupancyLimitInput) {
        occupancyLimitInput.addEventListener('input', function() {
            const occupancyNum = parseInt(this.value);
            if (isNaN(occupancyNum) || occupancyNum < 1 || occupancyNum > 10) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }
    
    if (roomTypeSelect) {
        roomTypeSelect.addEventListener('change', function() {
            if (!this.value) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }

    const searchInput = document.getElementById('roomSearchInput');
    const tables = document.querySelectorAll('.table.table-hover');
    if (!searchInput || !tables.length) return;

    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        tables.forEach(table => {
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                let rowText = '';
                row.querySelectorAll('td').forEach((cell, idx) => {
                    // Exclude the last cell (Actions column)
                    if (idx === row.cells.length - 1) return;
                    rowText += cell.textContent.toLowerCase() + ' ';
                });
                row.style.display = rowText.includes(searchTerm) ? '' : 'none';
            });
        });
    });
});

function cleanupCropper() {
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
}

function initCropper(image) {
    if (cropper) {
        cropper.destroy();
    }
    
    cropper = new Cropper(image, {
        aspectRatio: 491/392,
                        viewMode: 2,
                        dragMode: 'move',
                        autoCropArea: 0.8,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: true,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false
    });
}

function loadImageForCropping(input) {
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            const cropperImage = document.getElementById('cropperImage');
            cropperImage.src = e.target.result;
            
            // Show modal and initialize cropper
            cropModal.show();
            document.getElementById('imageCropModal').addEventListener('shown.bs.modal', function() {
                initCropper(cropperImage);
            }, { once: true });
        };
        
        reader.readAsDataURL(input.files[0]);
    }
}

function cropImage() {
    if (cropper) {
        const canvas = cropper.getCroppedCanvas({
            width: 491,
            height: 392,
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high'
        });
        
        const croppedImageUrl = canvas.toDataURL('image/jpeg', 0.9);
        document.getElementById('cropped_image').value = croppedImageUrl;
        
        // Show preview
        const previewImage = document.getElementById('previewImage');
        previewImage.src = croppedImageUrl;
        document.getElementById('previewContainer').classList.remove('d-none');
        
        // Keep the file input visible and show a success message
        const fileInputContainer = document.getElementById('roomImage').parentElement;
        
        // Add success message below the file input if it doesn't exist
        let successMessage = fileInputContainer.querySelector('.alert-success');
        if (!successMessage) {
            successMessage = document.createElement('div');
            successMessage.className = 'alert alert-success mt-2 mb-0';
            successMessage.innerHTML = '<i class="fas fa-check-circle me-2"></i> Image uploaded successfully';
            fileInputContainer.appendChild(successMessage);
            
            // Make the success message disappear after 3 seconds
            setTimeout(() => {
                if (successMessage.parentNode) {
                    successMessage.style.transition = 'opacity 0.5s ease';
                    successMessage.style.opacity = '0';
                    setTimeout(() => {
                        if (successMessage.parentNode) {
                            successMessage.remove();
                        }
                    }, 500);
                }
            }, 3000);
        }
        
        // Hide cropper modal and cleanup
        cropModal.hide();
        cleanupCropper();
    }
}

// Function to reset the image upload
function resetImageUpload() {
    // Find the container by looking for elements with previewContainer
    const fileInputContainers = document.querySelectorAll('.mb-3');
    let fileInputContainer = null;
    
    // Find the container that has the preview
    for (const container of fileInputContainers) {
        if (container.querySelector('#previewContainer')) {
            fileInputContainer = container;
            break;
        }
    }
    
    if (fileInputContainer) {
        fileInputContainer.innerHTML = `
            <label for="roomImage" class="form-label">Room Image</label>
            <input type="file" class="form-control" id="roomImage" name="image" 
                   accept="image/*" onchange="validateAndLoadImage(this)">
            <div class="invalid-feedback">
                Please select a valid image file (JPG, PNG, or GIF)
            </div>
            <div id="previewContainer" class="mt-2 d-none">
                <img id="previewImage" class="img-thumbnail" style="max-height: 200px;">
            </div>
        `;
        
        // Reset the cropped image value
        document.getElementById('cropped_image').value = '';
        
        // Re-attach event listener
document.getElementById('roomImage').addEventListener('change', function() {
    document.getElementById('cropped_image').value = '';
    document.getElementById('previewContainer').classList.add('d-none');
    loadImageForCropping(this);
});
    }
}

function viewRoomType(roomTypeId) {
    window.location.href = `/admin/room-types/${roomTypeId}`;
}

function viewRoom(roomId) {
    window.location.href = `/admin/rooms/${roomId}`;
}

function editRoom(roomId) {
    window.location.href = `/admin/rooms/${roomId}/edit`;
}

function deleteRoom(roomId) {
    roomIdToDelete = roomId;
    deleteRoomModal.show();
}

function confirmDeleteRoom() {
    if (!roomIdToDelete) return;
    
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    const row = document.querySelector(`button[onclick="deleteRoom(${roomIdToDelete})"]`).closest('tr');
    
    fetch(`/admin/rooms/${roomIdToDelete}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || 'Failed to delete room');
            });
        }
        return response.json();
    })
    .then(data => {
        // Close the modal first
        deleteRoomModal.hide();
        
        if (data.success) {
            // Remove the row from the table
            if (row) {
            row.remove();
            }
            
            // Show success message
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success alert-dismissible fade show mt-3';
            successAlert.innerHTML = `
                ${data.message || 'Room deleted successfully'}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Find the card-body container safely
            const tableContainer = document.querySelector('.card:nth-of-type(2) .card-body');
            
            // Only insert if the container exists
            if (tableContainer) {
            tableContainer.insertBefore(successAlert, tableContainer.firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                    try {
                const bsAlert = new bootstrap.Alert(successAlert);
                bsAlert.close();
                    } catch (e) {
                        // If bootstrap Alert isn't available, remove manually
                        if (successAlert.parentNode) {
                            successAlert.remove();
                        }
                    }
            }, 5000);
            } else {
                // Fallback - show an alert if we can't find the container
                alert(data.message || 'Room deleted successfully');
            }
            
            // If there are no more rooms, refresh the page after a short delay
            const remainingRows = document.querySelectorAll('.card:nth-of-type(2) table tbody tr').length;
            if (remainingRows === 0) {
                setTimeout(() => {
                    window.location.href = window.location.pathname;
                }, 500);
            }
        } else {
            // Show error message
            alert(data.message || 'Failed to delete room');
        }
    })
    .catch(error => {
        deleteRoomModal.hide();
        console.error('Error:', error);
        alert(error.message || 'An error occurred while deleting the room');
    });
}

function editRoomType(roomTypeId) {
    window.location.href = `/admin/room-types/${roomTypeId}/edit`;
}

function deleteRoomType(roomTypeId) {
    roomTypeIdToDelete = roomTypeId;
    deleteRoomTypeModal.show();
}

function confirmDeleteRoomType() {
    if (!roomTypeIdToDelete) return;
    
    const csrfToken = document.querySelector('input[name="csrf_token"]').value;
    const row = document.querySelector(`button[onclick="deleteRoomType(${roomTypeIdToDelete})"]`).closest('tr');
    
    fetch(`/admin/room-types/${roomTypeIdToDelete}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.message || 'Failed to delete room type');
            });
        }
        return response.json();
    })
    .then(data => {
        // Close the modal first
        deleteRoomTypeModal.hide();
        
        if (data.success) {
            // Remove the row from the table
            if (row) {
            row.remove();
            }
            
            // Show success message
            const successAlert = document.createElement('div');
            successAlert.className = 'alert alert-success alert-dismissible fade show mt-3';
            successAlert.innerHTML = `
                ${data.message || 'Room type deleted successfully'}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Insert alert at the top of the room types table container
            const tableContainer = document.querySelector('.card:nth-of-type(1) .card-body');
            
            // Check if the tableContainer exists before inserting
            if (tableContainer) {
            tableContainer.insertBefore(successAlert, tableContainer.firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                    if (successAlert.parentNode) {
                const bsAlert = new bootstrap.Alert(successAlert);
                bsAlert.close();
                    }
            }, 5000);
            } else {
                // If container not found, show a standard alert instead
                alert(data.message || 'Room type deleted successfully');
            }
            
            // If there are no more room types, refresh the page after a short delay
            const remainingRows = document.querySelectorAll('.card:nth-of-type(1) table tbody tr').length;
            if (remainingRows === 0) {
                setTimeout(() => {
                    window.location.href = window.location.pathname;
                }, 500);
            }
        } else {
            // Show error message
            alert(data.message || 'Failed to delete room type');
        }
    })
    .catch(error => {
        deleteRoomTypeModal.hide();
        console.error('Error:', error);
        alert(error.message || 'An error occurred while deleting the room type');
    });
}

// Enhanced form validation
document.getElementById('addRoomForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = this;
    const roomNumber = document.getElementById('roomNumber');
    const floor = document.getElementById('floor');
    const occupancyLimit = document.getElementById('occupancyLimit');
    const roomType = document.getElementById('roomType');
    let isValid = true;
    
    // Reset previous validation states
    form.classList.remove('was-validated');
    [roomNumber, floor, occupancyLimit, roomType].forEach(input => {
        input.classList.remove('is-invalid');
    });
    
    // Validate room number format
    if (!/^\d+[A-Za-z]?$/.test(roomNumber.value)) {
        roomNumber.classList.add('is-invalid');
        isValid = false;
    }
    
    // Validate floor number
    const floorNum = parseInt(floor.value);
    if (isNaN(floorNum) || floorNum < 1 || floorNum > 100) {
        floor.classList.add('is-invalid');
        isValid = false;
    }
    
    // Validate occupancy limit
    const occupancyNum = parseInt(occupancyLimit.value);
    if (isNaN(occupancyNum) || occupancyNum < 1 || occupancyNum > 10) {
        occupancyLimit.classList.add('is-invalid');
        isValid = false;
    }
    
    // Validate room type selection
    if (!roomType.value) {
        roomType.classList.add('is-invalid');
        isValid = false;
    }
    
    if (isValid) {
        form.submit();
    } else {
        form.classList.add('was-validated');
    }
});

// Image validation and loading
function validateAndLoadImage(input) {
    const file = input.files[0];
    const validTypes = ['image/jpeg', 'image/png', 'image/gif'];
    const maxSize = 5 * 1024 * 1024; // 5MB
    
    if (file) {
        if (!validTypes.includes(file.type)) {
            input.classList.add('is-invalid');
            input.value = '';
            return;
        }
        
        if (file.size > maxSize) {
            input.classList.add('is-invalid');
            input.value = '';
            return;
        }
        
        input.classList.remove('is-invalid');
        loadImageForCropping(input);
    }
}

// Add Room Type Form Validation
document.getElementById('addRoomTypeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = this;
    const typeName = document.getElementById('typeName');
    const typeDescription = document.getElementById('typeDescription');
    const basePriceFormattedInput = document.getElementById('basePriceFormatted');
    const basePriceHiddenInput = document.getElementById('basePrice');
    let isValid = true;
    
    // Reset previous validation states
    form.classList.remove('was-validated');
    [typeName, typeDescription, basePriceFormattedInput].forEach(input => {
        input.classList.remove('is-invalid');
    });
    
    // Validate name
    if (typeName.value.length < 3 || typeName.value.length > 50) {
        typeName.classList.add('is-invalid');
        document.getElementById('typeNameFeedback').textContent = 'Room type name must be between 3 and 50 characters.';
        isValid = false;
    } else if (countWords(typeName.value) > 20) {
        typeName.classList.add('is-invalid');
        document.getElementById('typeNameFeedback').textContent = 'Name cannot exceed 20 words.';
        isValid = false;
    } else if (hasRepeatedCharacters(typeName.value, 5)) {
        typeName.classList.add('is-invalid');
        document.getElementById('typeNameFeedback').textContent = 'Name contains too many repeated characters.';
        isValid = false;
    }
    
    // Validate description
    if (typeDescription.value.length < 10 || typeDescription.value.length > 500) {
        typeDescription.classList.add('is-invalid');
        document.getElementById('typeDescriptionFeedback').textContent = 'Description must be between 10 and 500 characters.';
        isValid = false;
    } else if (countWords(typeDescription.value) > 100) {
        typeDescription.classList.add('is-invalid');
        document.getElementById('typeDescriptionFeedback').textContent = `Description cannot exceed 100 words.`;
        isValid = false;
    } else if (hasRepeatedCharacters(typeDescription.value, 5)) {
        typeDescription.classList.add('is-invalid');
        document.getElementById('typeDescriptionFeedback').textContent = 'Description contains too many repeated characters.';
        isValid = false;
    }
    
    // Validate price
    const price = parseFloat(basePriceHiddenInput.value);
    if (isNaN(price) || price < 0 || price > 50000) {
        basePriceFormattedInput.classList.add('is-invalid');
        document.getElementById('basePriceFeedback').textContent = 'Price must be between 0 and ₱50,000.';
        isValid = false;
    } else {
        basePriceFormattedInput.classList.remove('is-invalid');
    }
    
    if (isValid) {
        form.submit();
    } else {
        form.classList.add('was-validated');
    }
});
</script>

<style>
.action-buttons {
    display: flex;
    gap: 4px;
}

.available-badge {
    background-color: #28a745 !important;
    color: white;
}

.occupied-badge {
    background-color: #dc3545 !important;
    color: white;
}

.word-count {
    font-size: 0.85rem;
    color: #6c757d;
    text-align: right;
    margin-top: 0.25rem;
}

.word-count.exceeded {
    color: #dc3545;
    font-weight: bold;
}

.btn-view {
    background: linear-gradient(135deg, #42A5F5, #64B5F6);
    color: white;
    border: none;
}

.btn-view:hover {
    background: linear-gradient(135deg, #2196F3, #42A5F5);
    color: white;
}

.light-button {
    background: linear-gradient(135deg, #42A5F5, #64B5F6);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
}

.green-button {
    background: #66BB6A;
    color: white;
    border: none;
    font-size: 14px;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-view,
.btn-edit,
.btn-delete {
    width: 36px;
    height: 36px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    border: none;
}

.btn-view {
    background-color: #17a2b8;
    color: white;
}

.btn-view:hover {
    background-color: #138496;
    color: white;
}

.btn-edit {
    background-color: #ffc107;
    color: white;
}

.btn-edit:hover {
    background-color: #e0a800;
    color: white;
}

.btn-delete {
    background-color: #dc3545;
    color: white;
}

.btn-delete:hover {
    background-color: #c82333;
    color: white;
}

.action-buttons .btn i {
    font-size: 14px;
}
</style>
{% endblock %} 