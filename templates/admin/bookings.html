{% extends "admin/base_admin.html" %}

{% block title %}Manage Bookings - FAWNA Hotel{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-dark: #4b342a; /* Darker shade of the primary brown color for hover states */
    }

    .action-form {
        display: inline-block;
        margin: 0 4px;
    }
    
.action-btn {
    border: none;
    padding: 8px 16px;
    font-size: 0.9rem;
    border-radius: 6px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: var(--transition);
    font-weight: 500;
    vertical-align: middle;
    min-width: 120px; /* added: sets a consistent minimum width */
    text-align: center; /* makes text centered if button grows */
}

    
    .action-btn i {
        font-size: 0.9rem;
    }
    
    .btn-confirm {
        background-color: var(--success-color);
        color: white;
        margin-bottom: 10px;
    }
    
    .btn-confirm:hover {
        background-color: #1b5e20;
        transform: translateY(-1px);
        box-shadow: var(--card-shadow);
    }
    
    .btn-reject {
        background-color: var(--danger-color);
        color: white;
    }
    
    .btn-reject:hover {
        background-color: #b71c1c;
        transform: translateY(-1px);
        box-shadow: var(--card-shadow);
    }
    
    .search-container {
        background: white;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        padding: 25px;
        margin-bottom: 25px;
    }
    
    .nav-tabs {
        border: none;
        margin-bottom: 25px;
        background: white;
        padding: 0 15px;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
    }
    
    .nav-tabs .nav-link {
        color: var(--text-dark);
        border: none;
        padding: 15px 25px;
        font-weight: 500;
        position: relative;
        transition: var(--transition);
    }
    
    .nav-tabs .nav-link:hover {
        color: var(--primary-color);
        background: none;
        border: none;
    }
    
    .nav-tabs .nav-link.active {
        color: var(--primary-color);
        background: none;
        border: none;
    }
    
    .nav-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background-color: var(--primary-color);
    }
    
    .tab-badge {
        margin-left: 8px;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .badge-pending { 
        background-color: #fff3e0; 
        color: #e65100; 
    }
    
    .badge-confirmed { 
        background-color: #e8f5e9; 
        color: #2e7d32; 
    }
    
    .badge-rejected { 
        background-color: #ffebee; 
        color: #c62828; 
    }
    
    .badge-completed { 
        background-color: #e3f2fd; 
        color: #1565c0; 
    }
    
    .badge-cancelled { 
        background-color: #ffebee; 
        color: #c62828; 
    }
    
    .table-container {
        background: white;
        border-radius: 12px;
        box-shadow: var(--card-shadow);
        padding: 25px;
        margin-bottom: 25px;
        overflow: hidden;
    }
    
    .table {
        margin-bottom: 0;
    }
    
    .table th {
        background-color: var(--primary-color);
        color: var(--text-light);
        font-weight: 500;
        border: none;
        padding: 15px 20px;
        white-space: nowrap;
    }
    
    .table thead {
        position: sticky;
        top: 0;
        z-index: 1;
    }
    
    .table thead tr {
        background-color: var(--primary-color);
    }
    
    .table td {
        padding: 15px 20px;
        vertical-align: middle;
        color: var(--text-dark);
    }
    
    .table tbody tr {
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .table tbody tr:hover {
        background-color: rgba(109, 76, 65, 0.05);
    }
    
    .table tbody tr:last-child {
        border-bottom: none;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-muted);
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 15px;
        color: var(--accent-color);
    }
    
    .empty-state p {
        font-size: 1.1rem;
        margin: 0;
    }
    
    .table-responsive {
        margin: -1px;  /* Fix border radius issue */
    }

    .form-select, .form-control {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 8px 12px;
    }

    .form-select:focus, .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(93, 64, 55, 0.1);
    }

    .transaction-id {
        font-family: monospace;
        color: var(--primary-color);
        font-weight: 500;
    }

    .view-reason {
        color: #6D4C41;
        text-decoration: none;
        padding: 0;
    }

    .view-reason:hover {
        color: #5D4037;
        text-decoration: underline;
    }

    #reasonModal .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    #reasonModal .modal-header {
        background-color: #6D4C41;
        color: white;
        border-bottom: none;
        border-radius: 12px 12px 0 0;
        padding: 1rem 1.5rem;
    }

    #reasonModal .modal-body {
        padding: 1.5rem;
    }

    #reasonModal #reasonText {
        font-size: 1rem;
        line-height: 1.5;
        margin-bottom: 1rem;
        white-space: pre-wrap;
    }

    #reasonModal #cancelledAt {
        display: block;
        margin-top: 1rem;
        color: #6c757d;
    }

    .btn-view-reason {
        background-color: #17a2b8;
        color: white;
        border: none;
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .btn-view-reason:hover {
        background-color: #138496;
        color: white;
    }

    .btn-view-reason i {
        font-size: 14px;
    }

    #reasonModal .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    #reasonModal .modal-header {
        background-color: #6D4C41;
        color: white;
        border-bottom: none;
        border-radius: 12px 12px 0 0;
        padding: 1rem 1.5rem;
    }

    #reasonModal .modal-body {
        padding: 1.5rem;
    }

    #reasonModal .reason-content {
        background-color: white;
        border-radius: 8px;
    }

    #reasonModal .form-label {
        color: #6D4C41;
        margin-bottom: 0.5rem;
    }

    #reasonModal .cancelled-at {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #dee2e6;
    }

    .action-buttons {
        display: flex;
        gap: 4px;
    }

    /* Stacked buttons (Confirm over Reject) for Pending tab */
    .action-buttons-stacked {
        display: flex;
        flex-direction: column;
        gap: 6px;
        align-items: flex-end; /* right-align inside Actions cell */
        width: 150px; /* lock container width for consistent stacking */
        margin-left: auto; /* push to right edge of cell */
    }

    /* Make stacked buttons consistent width and alignment */
    .action-buttons-stacked .action-btn {
        width: 100%;
        display: inline-flex;
        justify-content: center;
    }

    /* Normalize form spacing and width inside stacked container */
    .action-buttons-stacked .action-form {
        margin: 0;
        width: 100%;
    }
    .action-buttons-stacked .action-form .action-btn {
        width: 100%;
    }

    /* Ensure Actions column has enough space */
    #pending .table td:last-child, #pending .table th:last-child,
    #confirmed .table td:last-child, #confirmed .table th:last-child,
    .table-container .table td:last-child, .table-container .table th:last-child {
        width: 160px;
        white-space: nowrap;
    }

    .btn-view,
    .btn-delete {
        width: 32px;
        height: 32px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
    }

    .btn-view {
        background: linear-gradient(135deg, #42A5F5, #64B5F6);
        color: white;
    }

    .btn-view:hover {
        background: linear-gradient(135deg, #2196F3, #42A5F5);
        color: white;
    }

    .btn-delete {
        background-color: #dc3545;
        color: white;
    }

    .btn-delete:hover {
        background-color: #c82333;
        color: white;
    }

    .action-buttons .btn i {
        font-size: 14px;
    }

    /* Add this CSS rule for the GCash payment view button */
    .btn-view-payment {
        background-color: var(--primary-color);
        color: white;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s ease;
        border-radius: 6px;
        padding: 8px 16px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    /* Use a more specific selector to override any other hover styles */
    .table-container .table .btn-view-payment:hover,
    .btn-view-payment:hover {
        background-color: var(--primary-dark);
        color: white !important;
        transform: translateY(-1px);
        box-shadow: var(--card-shadow);
    }
    
    .payment-method-badge .badge {
        font-size: 0.9rem;
        padding: 8px 12px;
        border-radius: 6px;
    }
    
    .badge-paymaya {
        background: linear-gradient(135deg, #5a0ca5, #7928ca) !important;
        color: white;
        box-shadow: 0 2px 5px rgba(90, 12, 165, 0.3);
    }
    
    #paymentReference {
        font-family: monospace;
        font-size: 1.1rem;
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        display: inline-block;
    }

    .btn-view-receipt {
        background-color: var(--primary-color);
        color: white;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: all 0.3s ease;
        border-radius: 6px;
        padding: 8px 16px;
        font-size: 0.9rem;
        font-weight: 500;
    }

    .btn-view-receipt:hover {
        background-color: var(--primary-dark);
        color: white !important;
        transform: translateY(-1px);
        box-shadow: var(--card-shadow);
    }
</style>
{% endblock %}

{% block admin_content %}
<div class="container-fluid">
    <!-- Search Container -->
    <div class="search-container">
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by guest name, room number, or room type...">
                    <span class="input-group-text">
                        <i class="fas fa-search"></i>
                    </span>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3">
                <select class="form-select" id="roomFilter">
                    <option value="">All Rooms</option>
                    {% for room in rooms %}
                    <option value="{{ room.room_number }}">{{ room.room_number }} ({{ room.room_type.name }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="priceFilter">
                    <option value="">All Prices</option>
                    <option value="0-1000">₱0 - ₱1,000</option>
                    <option value="1000-2000">₱1,000 - ₱2,000</option>
                    <option value="2000-3000">₱2,000 - ₱3,000</option>
                    <option value="3000+">₱3,000+</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="date" class="form-control" id="dateFilter" placeholder="Filter by date">
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs" id="bookingTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                <i class="fas fa-clock me-2"></i>Pending
                <span class="tab-badge badge-pending">{{ pending_bookings|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="confirmed-tab" data-bs-toggle="tab" data-bs-target="#confirmed" type="button" role="tab">
                <i class="fas fa-check-circle me-2"></i>Approved
                <span class="tab-badge badge-confirmed">{{ approved_bookings|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="rejected-tab" data-bs-toggle="tab" data-bs-target="#rejected" type="button" role="tab">
                <i class="fas fa-times-circle me-2"></i>Rejected
                <span class="tab-badge badge-rejected">{{ rejected_bookings|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="cancelled-tab" data-bs-toggle="tab" data-bs-target="#cancelled" type="button" role="tab">
                <i class="fas fa-ban me-2"></i>Cancelled
                <span class="tab-badge badge-cancelled">{{ cancelled_bookings|length }}</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed" type="button" role="tab">
                <i class="fas fa-flag-checkered me-2"></i>Completed
                <span class="tab-badge badge-completed">{{ completed_bookings|length }}</span>
            </button>
        </li>
    </ul>

    <!-- Tabs Content -->
    <div class="tab-content" id="bookingTabsContent">
        <!-- Pending Bookings Tab -->
        <div class="tab-pane fade show active" id="pending" role="tabpanel">
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Guest</th>
                                <th>Room</th>
                                <th>Persons</th>
                                <th>Check In</th>
                                <th>Check Out</th>
                                <th>Total Price</th>
                                <th>Status</th>
                                <th>Payment</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if pending_bookings %}
                            {% for booking in pending_bookings %}
                            <tr class="booking-row" data-search="{{ booking.user.name.lower() }} {{ booking.room.room_number.lower() }} {{ booking.room.room_type.name.lower() }}">
                                <td class="transaction-id">{{ booking.id }}</td>
                                <td>{{ booking.user.name }}</td>
                                <td>{{ booking.room.room_number }} ({{ booking.room.room_type.name }})</td>
                                <td>{{ booking.num_guests }}</td>
                                <td>{{ booking.check_in_date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ booking.check_out_date.strftime('%Y-%m-%d') }}</td>
                                <td>₱{{ "{:,.2f}".format(booking.total_price) }}</td>
                                <td><span class="badge bg-warning">Pending</span></td>
                                <td>
                                    {% if booking.payment_method == 'gcash' %}
                                        <button type="button" class="btn btn-view-payment btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#paymentModal"
                                                data-reference="{{ booking.payment_reference }}"
                                                data-payment-method="GCash"
                                                data-screenshot="{{ url_for('static', filename=booking.payment_screenshot) if booking.payment_screenshot }}">
                                            View Payment
                                        </button>
                                    {% elif booking.payment_method == 'paymaya' or booking.payment_method == 'qr_payment' %}
                                        <button type="button" class="btn btn-view-payment btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#paymentModal"
                                                data-reference="{{ booking.payment_reference }}"
                                                data-payment-method="PayMaya"
                                                data-screenshot="{{ url_for('static', filename=booking.payment_screenshot) if booking.payment_screenshot }}">
                                            View Payment
                                        </button>
                                    {% else %}
                                        <span class="badge bg-secondary">Pay on Site</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons action-buttons-stacked">
                                    <form action="{{ url_for('approve_booking', booking_id=booking.id) }}" method="post" class="action-form" onsubmit="return confirm('Are you sure you want to confirm this booking?')">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="action-btn btn-confirm">
                                            <i class="fas fa-check"></i> Confirm
                                        </button>
                                    </form>
                                        <button type="button" class="action-btn btn-reject open-reject-modal" data-booking-id="{{ booking.id }}">
                                            <i class="fas fa-times"></i> Reject
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="10" class="empty-state text-center">
                                    <i class="fas fa-calendar-times"></i>
                                    <p>No pending bookings</p>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Confirmed Bookings Tab -->
        <div class="tab-pane fade" id="confirmed" role="tabpanel">
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Guest</th>
                                <th>Room</th>
                                <th>Persons</th>
                                <th>Check In</th>
                                <th>Check Out</th>
                                <th>Total Price</th>
                                <th>Status</th>
                                <th>Payment</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if approved_bookings %}
                            {% for booking in approved_bookings %}
                            <tr class="booking-row" data-search="{{ booking.user.name.lower() }} {{ booking.room.room_number.lower() }} {{ booking.room.room_type.name.lower() }}">
                                    <td class="transaction-id">{{ booking.id }}</td>
                                <td>{{ booking.user.name }}</td>
                                <td>{{ booking.room.room_number }} ({{ booking.room.room_type.name }})</td>
                                <td>{{ booking.num_guests }}</td>
                                <td>{{ booking.check_in_date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ booking.check_out_date.strftime('%Y-%m-%d') }}</td>
                                <td>₱{{ "{:,.2f}".format(booking.total_price) }}</td>
                                <td><span class="badge" style="background-color: #28a745;">Approved</span></td>
                                <td>
                                    {% if booking.payment_method == 'gcash' %}
                                        <button type="button" class="btn btn-view-payment btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#paymentModal"
                                                data-reference="{{ booking.payment_reference }}"
                                                data-payment-method="GCash"
                                                data-screenshot="{{ url_for('static', filename=booking.payment_screenshot) if booking.payment_screenshot }}">
                                            View Payment
                                        </button>
                                    {% elif booking.payment_method == 'paymaya' or booking.payment_method == 'qr_payment' %}
                                        <button type="button" class="btn btn-view-payment btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#paymentModal"
                                                data-reference="{{ booking.payment_reference }}"
                                                data-payment-method="PayMaya"
                                                data-screenshot="{{ url_for('static', filename=booking.payment_screenshot) if booking.payment_screenshot }}">
                                            View Payment
                                        </button>
                                    {% else %}
                                        <span class="badge bg-secondary">Pay on Site</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button type="button" class="btn btn-view btn-sm view-booking-btn" 
                                                data-id="{{ booking.id }}"
                                                title="View">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if booking.rejection_reason %}
                                        <button type="button" class="btn btn-view-reason btn-sm" 
                                                data-reason="{{ booking.rejection_reason }}"
                                                data-cancelled-at="{{ booking.rejected_at.strftime('%Y-%m-%d %H:%M:%S') if booking.rejected_at }}"
                                                title="View Reason">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                        {% endif %}
                                        <button type="button" class="btn btn-delete btn-sm delete-booking-btn" 
                                                data-id="{{ booking.id }}"
                                                title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                    <td colspan="10" class="empty-state text-center">
                                    <i class="fas fa-calendar-check"></i>
                                    <p>No approved bookings</p>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Rejected Bookings Tab -->
        <div class="tab-pane fade" id="rejected" role="tabpanel">
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Guest</th>
                                <th>Room</th>
                                <th>Persons</th>
                                <th>Check In</th>
                                <th>Check Out</th>
                                <th>Total Price</th>
                                <th>Status</th>
                                <th>Payment</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if rejected_bookings %}
                            {% for booking in rejected_bookings %}
                            <tr class="booking-row" data-search="{{ booking.user.name.lower() }} {{ booking.room.room_number.lower() }} {{ booking.room.room_type.name.lower() }}">
                                    <td class="transaction-id">{{ booking.id }}</td>
                                <td>{{ booking.user.name }}</td>
                                <td>{{ booking.room.room_number }} ({{ booking.room.room_type.name }})</td>
                                <td>{{ booking.num_guests }}</td>
                                <td>{{ booking.check_in_date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ booking.check_out_date.strftime('%Y-%m-%d') }}</td>
                                <td>₱{{ "{:,.2f}".format(booking.total_price) }}</td>
                                <td><span class="badge bg-danger">Rejected</span></td>
                                <td>
                                    {% if booking.payment_method == 'gcash' %}
                                        <button type="button" class="btn btn-view-payment btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#paymentModal"
                                                data-reference="{{ booking.payment_reference }}"
                                                data-payment-method="GCash"
                                                data-screenshot="{{ url_for('static', filename=booking.payment_screenshot) if booking.payment_screenshot }}">
                                            View Payment
                                        </button>
                                    {% elif booking.payment_method == 'paymaya' or booking.payment_method == 'qr_payment' %}
                                        <button type="button" class="btn btn-view-payment btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#paymentModal"
                                                data-reference="{{ booking.payment_reference }}"
                                                data-payment-method="PayMaya"
                                                data-screenshot="{{ url_for('static', filename=booking.payment_screenshot) if booking.payment_screenshot }}">
                                            View Payment
                                        </button>
                                    {% else %}
                                        <span class="badge bg-secondary">Pay on Site</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button type="button" class="btn btn-view btn-sm view-booking-btn" 
                                                data-id="{{ booking.id }}"
                                                title="View">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-delete btn-sm delete-booking-btn" 
                                                data-id="{{ booking.id }}"
                                                title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                    <td colspan="10" class="empty-state text-center">
                                    <i class="fas fa-calendar-times"></i>
                                    <p>No rejected bookings</p>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Cancelled Bookings Tab -->
        <div class="tab-pane fade" id="cancelled" role="tabpanel">
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Guest</th>
                                <th>Room</th>
                                <th>Persons</th>
                                <th>Check In</th>
                                <th>Check Out</th>
                                <th>Total Price</th>
                                <th>Status</th>
                                <th>Payment</th>
                                <th>Reason</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if cancelled_bookings %}
                            {% for booking in cancelled_bookings %}
                            <tr class="booking-row" data-search="{{ booking.user.name.lower() }} {{ booking.room.room_number.lower() }} {{ booking.room.room_type.name.lower() }}">
                                <td class="transaction-id">{{ booking.id }}</td>
                                <td>{{ booking.user.name }}</td>
                                <td>{{ booking.room.room_number }} ({{ booking.room.room_type.name }})</td>
                                <td>{{ booking.num_guests }}</td>
                                <td>{{ booking.check_in_date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ booking.check_out_date.strftime('%Y-%m-%d') }}</td>
                                <td>₱{{ "{:,.2f}".format(booking.total_price) }}</td>
                                <td><span class="badge bg-danger">Cancelled</span></td>
                                <td>
                                    {% if booking.payment_method == 'gcash' %}
                                        <button type="button" class="btn btn-view-payment btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#paymentModal"
                                                data-reference="{{ booking.payment_reference }}"
                                                data-payment-method="GCash"
                                                data-screenshot="{{ url_for('static', filename=booking.payment_screenshot) if booking.payment_screenshot }}">
                                            View Payment
                                        </button>
                                    {% elif booking.payment_method == 'paymaya' or booking.payment_method == 'qr_payment' %}
                                        <button type="button" class="btn btn-view-payment btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#paymentModal"
                                                data-reference="{{ booking.payment_reference }}"
                                                data-payment-method="PayMaya"
                                                data-screenshot="{{ url_for('static', filename=booking.payment_screenshot) if booking.payment_screenshot }}">
                                            View Payment
                                        </button>
                                    {% else %}
                                        <span class="badge bg-secondary">Pay on Site</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if booking.cancellation_reason %}
                                        <button type="button" class="action-btn btn-view-reason" 
                                                data-reason="{{ booking.cancellation_reason }}"
                                                data-cancelled-at="{{ booking.cancelled_at.strftime('%Y-%m-%d %H:%M:%S') if booking.cancelled_at }}">
                                            <i class="fas fa-info-circle"></i> View Reason
                                        </button>
                                    {% else %}
                                        <span class="text-muted">No reason provided</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button type="button" class="btn btn-view btn-sm view-booking-btn" 
                                                data-id="{{ booking.id }}"
                                                title="View">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-delete btn-sm delete-booking-btn" 
                                                data-id="{{ booking.id }}"
                                                title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="11" class="empty-state text-center">
                                    <i class="fas fa-calendar-times"></i>
                                    <p>No cancelled bookings</p>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Completed Bookings Tab -->
        <div class="tab-pane fade" id="completed" role="tabpanel">
            <div class="table-container">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Guest</th>
                                <th>Room</th>
                                <th>Persons</th>
                                <th>Check In</th>
                                <th>Check Out</th>
                                <th>Total Price</th>
                                <th>Status</th>
                                <th>Payment</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if completed_bookings %}
                            {% for booking in completed_bookings %}
                            <tr class="booking-row" data-search="{{ booking.user.name.lower() }} {{ booking.room.room_number.lower() }} {{ booking.room.room_type.name.lower() }}">
                                    <td class="transaction-id">{{ booking.id }}</td>
                                <td>{{ booking.user.name }}</td>
                                <td>{{ booking.room.room_number }} ({{ booking.room.room_type.name }})</td>
                                <td>{{ booking.num_guests }}</td>
                                <td>{{ booking.check_in_date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ booking.check_out_date.strftime('%Y-%m-%d') }}</td>
                                <td>₱{{ "{:,.2f}".format(booking.total_price) }}</td>
                                <td><span class="badge bg-info">Completed</span></td>
                                <td>
                                    {% if booking.payment_method == 'gcash' %}
                                        <button type="button" class="btn btn-view-payment btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#paymentModal"
                                                data-reference="{{ booking.payment_reference }}"
                                                data-payment-method="GCash"
                                                data-screenshot="{{ url_for('static', filename=booking.payment_screenshot) if booking.payment_screenshot }}">
                                            View Payment
                                        </button>
                                    {% elif booking.payment_method == 'paymaya' or booking.payment_method == 'qr_payment' %}
                                        <button type="button" class="btn btn-view-payment btn-sm" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#paymentModal"
                                                data-reference="{{ booking.payment_reference }}"
                                                data-payment-method="PayMaya"
                                                data-screenshot="{{ url_for('static', filename=booking.payment_screenshot) if booking.payment_screenshot }}">
                                            View Payment
                                        </button>
                                    {% else %}
                                        <span class="badge bg-secondary">Pay on Site</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button type="button" class="btn btn-view btn-sm view-booking-btn" 
                                                data-id="{{ booking.id }}"
                                                title="View">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button type="button" class="btn btn-delete btn-sm delete-booking-btn" 
                                                data-id="{{ booking.id }}"
                                                title="Delete">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                                {% endfor %}
                            {% else %}
                            <tr>
                                    <td colspan="10" class="empty-state text-center">
                                    <i class="fas fa-flag-checkered"></i>
                                    <p>No completed bookings</p>
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add this after the existing modals -->
<div class="modal fade" id="cancelReasonModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cancel Booking</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="cancelReasonForm" method="post">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="cancelReason" class="form-label">Reason for Cancellation</label>
                        <textarea class="form-control" id="cancelReason" name="reason" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-danger">Confirm Cancellation</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Reason Modal -->
<div class="modal fade" id="reasonModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cancel Reason</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="reason-content">
                    <div class="reason-text mb-3">
                        <label class="form-label fw-bold">Reason:</label>
                        <p id="reasonText" class="p-3 bg-light rounded"></p>
                        <div id="otherReasonText" style="display:none;">
                            <label class="form-label fw-bold">Comment:</label>
                            <p id="otherReasonValue" class="p-3 bg-light rounded"></p>
                        </div>
                    </div>
                    <div class="cancelled-at">
                        <label class="form-label fw-bold">Cancelled On:</label>
                        <p id="cancelledAt" class="text-muted"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Receipt Modal -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: var(--primary-color); color: white;">
                <h5 class="modal-title" id="receiptModalLabel">
                    <i class="fas fa-receipt me-2"></i>Booking Receipt
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="receiptFrame" src="" style="width: 100%; height: 600px; border: none;"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" style="background-color: var(--primary-color); color: white;" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-view-receipt" id="printReceiptBtn">
                    <i class="fas fa-print"></i> Print
                </button>
                <button type="button" class="btn btn-view-receipt" id="downloadReceiptBtn">
                    <i class="fas fa-download"></i> Download PDF
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Reject Reason Modal -->
<div class="modal fade" id="rejectReasonModal" tabindex="-1" aria-labelledby="rejectReasonModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #dc3545; color: white;">
                <h5 class="modal-title" id="rejectReasonModalLabel">Reject Booking</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="rejectReasonForm" method="post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="rejectReason" class="form-label">Reason for rejection</label>
                        <textarea class="form-control" id="rejectReason" name="reason" rows="3" required placeholder="Please provide a brief reason..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Reject</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Payment Details Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-md">
        <div class="modal-content">
            <div class="modal-header" style="background-color: var(--primary-color); color: white;">
                <h5 class="modal-title" id="paymentModalLabel">Payment Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="payment-method-badge mb-3">
                    <span class="badge bg-primary" id="paymentMethodBadge">GCash</span>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <h6>Reference Number:</h6>
                        <div class="bg-light p-3 rounded mb-4">
                            <p id="paymentReference" class="mb-0 fs-5 font-monospace user-select-all">Not provided</p>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <h6>Payment Screenshot:</h6>
                        <div id="imageContainer" class="d-flex justify-content-center align-items-center position-relative mb-3" style="min-height: 200px; overflow: hidden; border: 1px solid #eee; border-radius: 8px; background-color: #f9f9f9;">
                            <img id="paymentScreenshot" src="" alt="Payment Screenshot" class="img-fluid rounded" style="max-width: 100%; max-height: 400px; object-fit: contain; transform-origin: center; transition: transform 0.3s ease; user-select: none; cursor: grab;">
                            <div class="position-absolute bottom-0 end-0 m-2">
                                <button type="button" class="btn btn-light btn-sm rounded-circle shadow-sm" id="zoomInBtn" title="Zoom In">
                                    <i class="fas fa-search-plus"></i>
                                </button>
                                <button type="button" class="btn btn-light btn-sm rounded-circle shadow-sm" id="zoomOutBtn" title="Zoom Out">
                                    <i class="fas fa-search-minus"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" style="background-color: var(--primary-color); color: white;" data-bs-dismiss="modal">Close</button>
                <a href="#" id="adminViewReceiptBtn" class="btn btn-view-receipt d-none">
                    <i class="fas fa-receipt"></i> View Receipt
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Delete Booking Modal -->
<div class="modal fade" id="deleteBookingModal" tabindex="-1" aria-labelledby="deleteBookingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteBookingModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this booking? This action cannot be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBooking">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Booking Details Modal -->
<div class="modal fade" id="viewBookingModal" tabindex="-1" aria-labelledby="viewBookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewBookingModalLabel">
                    <i class="fas fa-info-circle me-2"></i>Booking Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-header" style="background: linear-gradient(135deg, #6D4C41, #8D6E63); color: white;">
                                <h5 class="card-title mb-0"><i class="fas fa-user me-2"></i>Guest Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="fw-bold text-muted">Guest Name:</label>
                                    <p id="modal-guest-name" class="mb-0 fs-5"></p>
                                </div>
                                <div class="mb-0">
                                    <label class="fw-bold text-muted">Number of Guests:</label>
                                    <p id="modal-guest-count" class="mb-0 fs-5"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-header" style="background: linear-gradient(135deg, #6D4C41, #8D6E63); color: white;">
                                <h5 class="card-title mb-0"><i class="fas fa-bed me-2"></i>Room Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="fw-bold text-muted">Room Number:</label>
                                    <p id="modal-room-number" class="mb-0 fs-5"></p>
                                </div>
                                <div class="mb-0">
                                    <label class="fw-bold text-muted">Room Type:</label>
                                    <p id="modal-room-type" class="mb-0 fs-5"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-header" style="background: linear-gradient(135deg, #6D4C41, #8D6E63); color: white;">
                                <h5 class="card-title mb-0"><i class="fas fa-calendar-alt me-2"></i>Reservation Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="fw-bold text-muted">Check-in Date:</label>
                                    <p id="modal-checkin" class="mb-0 fs-5"></p>
                                </div>
                                <div class="mb-0">
                                    <label class="fw-bold text-muted">Check-out Date:</label>
                                    <p id="modal-checkout" class="mb-0 fs-5"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-header" style="background: linear-gradient(135deg, #6D4C41, #8D6E63); color: white;">
                                <h5 class="card-title mb-0"><i class="fas fa-money-bill-wave me-2"></i>Payment Information</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="fw-bold text-muted">Total Amount:</label>
                                    <p id="modal-total" class="mb-0 fs-5 text-success fw-bold"></p>
                                </div>
                                <div class="mb-0">
                                    <label class="fw-bold text-muted">Payment Method:</label>
                                    <p id="modal-payment-method" class="mb-0 fs-5"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" style="background-color: #6D4C41; color: white;" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const bookingRows = document.querySelectorAll('.booking-row');
    let searchTimeout;

    // Tab persistence functionality
    const bookingTabs = document.querySelectorAll('#bookingTabs .nav-link');
    
    // Restore active tab from localStorage on page load
    const activeTabId = localStorage.getItem('activeBookingTab');
    if (activeTabId) {
        const tabToActivate = document.getElementById(activeTabId);
        if (tabToActivate) {
            const tabInstance = new bootstrap.Tab(tabToActivate);
            tabInstance.show();
        }
    }
    
    // Save active tab to localStorage when a tab is clicked
    bookingTabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            localStorage.setItem('activeBookingTab', event.target.id);
        });
    });

    function filterBookings() {
        const searchTerm = searchInput.value.toLowerCase().trim();
        let hasResults = false;

        bookingRows.forEach(row => {
            // Get all cell values for searching (except the last column with actions)
            const cells = Array.from(row.querySelectorAll('td:not(:last-child)'));
            const cellValues = cells.map(cell => cell.textContent.toLowerCase());
            const rowText = cellValues.join(' ');
            
            // Check if any cell contains the search term
            const match = rowText.includes(searchTerm);
            
            if (match) {
                row.style.display = '';
                hasResults = true;
            } else {
                row.style.display = 'none';
            }
        });

        // Show/hide no results message in each tab
        document.querySelectorAll('.tab-pane').forEach(tab => {
            const visibleRows = tab.querySelectorAll('.booking-row:not([style*="display: none"])').length;
            const noResultsRow = tab.querySelector('tr.no-results');
            const emptyRowsCount = tab.querySelectorAll('tr:not(.booking-row):not(.no-results)').length;
            
            if (searchTerm && !visibleRows) {
                if (!noResultsRow) {
                    const tbody = tab.querySelector('tbody');
                    const cols = tab.querySelector('thead tr').children.length;
                    const tr = document.createElement('tr');
                    tr.className = 'no-results';
                    tr.innerHTML = `<td colspan="${cols}" class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>No matching bookings found</p>
                    </td>`;
                    tbody.appendChild(tr);
                }
            } else if (noResultsRow && (visibleRows || emptyRowsCount)) {
                noResultsRow.remove();
            }
        });
    }

    // Add event listener for real-time search
    searchInput.addEventListener('input', function() {
        // Clear previous timeout
        clearTimeout(searchTimeout);
        
        // Set new timeout to prevent too many rapid searches
        searchTimeout = setTimeout(filterBookings, 300);
    });

    // Filter functionality
    const roomFilter = document.getElementById('roomFilter');
    const priceFilter = document.getElementById('priceFilter');
    const dateFilter = document.getElementById('dateFilter');

    function applyFilters() {
        const roomValue = roomFilter.value.toLowerCase();
        const priceValue = priceFilter.value;
        const dateValue = dateFilter.value;

        document.querySelectorAll('.booking-row').forEach(row => {
            const roomCell = row.querySelector('td:nth-child(3)');
            const priceCell = row.querySelector('td:nth-child(7)');
            const checkInCell = row.querySelector('td:nth-child(5)');
            
            const roomText = roomCell ? roomCell.textContent.toLowerCase() : '';
            const priceText = priceCell ? priceCell.textContent.replace('₱', '').replace(',', '') : '0';
            const price = parseFloat(priceText);
            const checkIn = checkInCell ? checkInCell.textContent.trim() : '';

            let showRow = true;

            if (roomValue) {
                // Check both room number and room type
                const roomNumber = roomText.split(' ')[0];  // Gets the room number part
                const roomType = roomText.includes('(') ? roomText.split('(')[1].replace(')', '') : '';  // Gets the room type in parentheses
                
                // Show row if either room number or room type contains the filter value
                if (!roomNumber.includes(roomValue) && !roomType.includes(roomValue)) {
                showRow = false;
                }
            }

            if (priceValue) {
                const [min, max] = priceValue.split('-').map(v => v === '+' ? Infinity : parseFloat(v));
                if (price < min || (max !== Infinity && price > max)) {
                    showRow = false;
                }
            }

            if (dateValue && checkIn !== dateValue) {
                showRow = false;
            }

            row.style.display = showRow ? '' : 'none';
        });
        
        // Update no results messages
        document.querySelectorAll('.tab-pane').forEach(tab => {
            const activeTab = tab.classList.contains('active');
            if (!activeTab) return;
            
            const visibleRows = tab.querySelectorAll('.booking-row:not([style*="display: none"])').length;
            const emptyRowsCount = tab.querySelectorAll('tr:not(.booking-row):not(.no-results)').length;
            const noResultsRow = tab.querySelector('tr.no-results');
            
            if (!visibleRows && !emptyRowsCount) {
                if (!noResultsRow) {
                    const tbody = tab.querySelector('tbody');
                    const cols = tab.querySelector('thead tr').children.length;
                    const tr = document.createElement('tr');
                    tr.className = 'no-results';
                    tr.innerHTML = `<td colspan="${cols}" class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>No matching bookings found</p>
                    </td>`;
                    tbody.appendChild(tr);
                }
            } else if (noResultsRow && (visibleRows || emptyRowsCount)) {
                noResultsRow.remove();
            }
        });
    }

    roomFilter.addEventListener('change', applyFilters);
    priceFilter.addEventListener('change', applyFilters);
    dateFilter.addEventListener('change', applyFilters);

    // Update search placeholder text
    searchInput.placeholder = "Search in any column (booking ID, guest, room, etc.)...";
    
    // Remove data-search attributes as they're no longer needed
    bookingRows.forEach(row => {
        if (row.hasAttribute('data-search')) {
            row.removeAttribute('data-search');
        }
    });

    // Cancel booking with reason
    document.querySelectorAll('.cancel-booking-btn').forEach(button => {
        button.addEventListener('click', function() {
            const bookingId = this.getAttribute('data-booking-id');
            const form = document.getElementById('cancelReasonForm');
            form.action = `/bookings/${bookingId}/cancel`;
            new bootstrap.Modal(document.getElementById('cancelReasonModal')).show();
        });
    });

    // View reason buttons
    document.querySelectorAll('.btn-view-reason').forEach(button => {
        button.addEventListener('click', function() {
            const reason = this.getAttribute('data-reason');
            const cancelledAt = this.getAttribute('data-cancelled-at');
            
            document.getElementById('reasonText').textContent = reason;
            document.getElementById('cancelledAt').textContent = cancelledAt;
            
            const modal = new bootstrap.Modal(document.getElementById('reasonModal'));
            modal.show();
        });
    });

    // Handle payment modal
    const paymentModal = document.getElementById('paymentModal');
    if (paymentModal) {
        let currentZoom = 1;
        const maxZoom = 3;
        const minZoom = 0.5;
        let isDragging = false;
        let startX, startY, translateX = 0, translateY = 0;
        let lastX, lastY;

        function zoomImage(factor) {
            const img = document.getElementById('paymentScreenshot');
            currentZoom = Math.min(Math.max(currentZoom * factor, minZoom), maxZoom);
            updateImageTransform();
        }

        function updateImageTransform() {
            const img = document.getElementById('paymentScreenshot');
            img.style.transform = `scale(${currentZoom}) translate(${translateX}px, ${translateY}px)`;
        }

        // Add zoom button event listeners
        document.getElementById('zoomInBtn').addEventListener('click', function() {
            zoomImage(1.2);
        });

        document.getElementById('zoomOutBtn').addEventListener('click', function() {
            zoomImage(0.8);
        });

        // Add drag functionality
        const imageContainer = document.getElementById('imageContainer');
        const img = document.getElementById('paymentScreenshot');

        img.addEventListener('mousedown', function(e) {
            if (currentZoom > 1) {
                isDragging = true;
                img.style.cursor = 'grabbing';
                startX = e.clientX;
                startY = e.clientY;
                lastX = translateX;
                lastY = translateY;
                e.preventDefault();
            }
        });

        document.addEventListener('mousemove', function(e) {
            if (isDragging && currentZoom > 1) {
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                translateX = lastX + deltaX;
                translateY = lastY + deltaY;
                updateImageTransform();
                e.preventDefault();
            }
        });

        document.addEventListener('mouseup', function() {
            if (isDragging) {
                isDragging = false;
                img.style.cursor = 'grab';
            }
        });

        // Reset zoom and position when modal is closed
        paymentModal.addEventListener('hidden.bs.modal', function() {
            const img = document.getElementById('paymentScreenshot');
            currentZoom = 1;
            translateX = 0;
            translateY = 0;
            img.style.transform = 'scale(1) translate(0, 0)';
            img.style.cursor = 'grab';
        });

        paymentModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const reference = button.getAttribute('data-reference');
            const screenshot = button.getAttribute('data-screenshot');
            const paymentMethod = button.getAttribute('data-payment-method') || 'GCash';
            
            // Update payment method badge
            const badge = document.getElementById('paymentMethodBadge');
            if (badge) {
                badge.textContent = paymentMethod;
                
                // Set badge color based on payment method
                if (paymentMethod === 'GCash') {
                    badge.className = 'badge bg-primary';
                } else if (paymentMethod === 'PayMaya') {
                    badge.className = 'badge badge-paymaya';
                }
            }
            
            // Update payment reference and screenshot
            const referenceElement = document.getElementById('paymentReference');
            if (referenceElement) {
                referenceElement.textContent = reference || 'Not provided';
            }
            
            // Get image container
            const container = document.getElementById('imageContainer');
            if (container) {
                // Show loading state
                container.innerHTML = `<div class="text-center py-4">
                    <div class="spinner-border text-primary mb-2" role="status"></div>
                    <p class="mb-0">Loading payment screenshot...</p>
                </div>`;
                container.style.display = 'flex';
                
                // First check if the screenshot path exists
                if (screenshot && screenshot !== "None") {
                    // Preload the image
                    const preloadImg = new Image();
                    preloadImg.onload = function() {
                        // Reset the container to its original state with the image and zoom controls
                        container.innerHTML = `
                            <img id="paymentScreenshot" src="${screenshot}" alt="Payment Screenshot" class="img-fluid rounded" 
                                 style="max-width: 100%; max-height: 400px; object-fit: contain; transform-origin: center; 
                                 transition: transform 0.3s ease; user-select: none; cursor: grab;">
                            <div class="position-absolute bottom-0 end-0 m-2">
                                <button type="button" class="btn btn-light btn-sm rounded-circle shadow-sm" id="zoomInBtn" title="Zoom In">
                                    <i class="fas fa-search-plus"></i>
                                </button>
                                <button type="button" class="btn btn-light btn-sm rounded-circle shadow-sm" id="zoomOutBtn" title="Zoom Out">
                                    <i class="fas fa-search-minus"></i>
                                </button>
                            </div>
                        `;
                        
                        // Reset zoom and position for new image
                        currentZoom = 1;
                        translateX = 0;
                        translateY = 0;
                        
                        // Reattach event listeners to new elements
                        document.getElementById('zoomInBtn').addEventListener('click', function() {
                            zoomImage(1.2);
                        });
                        
                        document.getElementById('zoomOutBtn').addEventListener('click', function() {
                            zoomImage(0.8);
                        });
                        
                        const img = document.getElementById('paymentScreenshot');
                        if (img) {
                            img.style.transform = 'scale(1) translate(0, 0)';
                            img.style.cursor = 'grab';
                            
                            // Add mousedown event listener for dragging
                            img.addEventListener('mousedown', function(e) {
                                if (currentZoom > 1) {
                                    isDragging = true;
                                    img.style.cursor = 'grabbing';
                                    startX = e.clientX;
                                    startY = e.clientY;
                                    lastX = translateX;
                                    lastY = translateY;
                                    e.preventDefault();
                                }
                            });
                        }
                    };
                    
                    preloadImg.onerror = function() {
                        container.innerHTML = `<div class="alert alert-warning m-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>Could not load payment screenshot.
                            <p class="small mt-2 mb-0">Please ensure the payment screenshot was uploaded correctly.</p>
                        </div>`;
                    };
                    
                    // Start loading the image
                    preloadImg.src = screenshot;
                } else {
                    // No screenshot provided
                    container.innerHTML = `<div class="alert alert-info m-0">
                        <i class="fas fa-info-circle me-2"></i>No payment screenshot provided.
                        <p class="small mt-2 mb-0">The user did not upload a screenshot or the file was not saved properly.</p>
                    </div>`;
                }
            }

            // --- Receipt Button Logic ---
            // Find the booking row (tr) and get booking id and status
            let bookingRow = button.closest('tr');
            let bookingId = null;
            let bookingStatus = null;
            if (bookingRow) {
                // Booking ID is usually in the first td with class 'transaction-id'
                const idCell = bookingRow.querySelector('.transaction-id');
                if (idCell) bookingId = idCell.textContent.trim();
                // Status is in the 8th td (index 7)
                const statusCell = bookingRow.querySelectorAll('td')[7];
                if (statusCell) bookingStatus = statusCell.textContent.trim().toLowerCase();
            }
            // Set up the View Receipt button
            const receiptBtn = document.getElementById('adminViewReceiptBtn');
            if (bookingId && (bookingStatus === 'approved' || bookingStatus === 'completed')) {
                receiptBtn.href = `/bookings/${bookingId}/receipt?modal=1`;
                receiptBtn.classList.remove('d-none');
            } else {
                receiptBtn.href = '#';
                receiptBtn.classList.add('d-none');
            }
        });
    }

    let bookingIdToDelete = null;
    const deleteBookingModal = new bootstrap.Modal(document.getElementById('deleteBookingModal'));
    
    function deleteBooking(bookingId) {
        bookingIdToDelete = bookingId;
        deleteBookingModal.show();
    }
    
    document.getElementById('confirmDeleteBooking').addEventListener('click', function() {
        if (!bookingIdToDelete) return;
        
        const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
        
        // Find which tab contains the booking being deleted
        const button = document.querySelector(`.delete-booking-btn[data-id="${bookingIdToDelete}"]`);
        if (!button) {
            console.error('Delete button not found');
            showAlert('danger', 'Error finding booking to delete from the UI', 'completed');
            return;
        }
        
        // Determine which tab the booking is in
        const tabId = button.closest('.tab-pane').id;
        
        fetch(`/admin/bookings/${bookingIdToDelete}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => response.json())
        .then(data => {
            deleteBookingModal.hide();
            
            if (data.success) {
                // Get the booking row and remove it
                const row = button.closest('tr');
                
                // Fade out and remove the row
                row.style.transition = 'opacity 0.5s';
                row.style.opacity = '0';
                
                // Remove the row after fade out animation completes
                setTimeout(() => {
                    // Remove the row from the DOM
                    if (row.parentNode) {
                        row.parentNode.removeChild(row);
                    }
                    
                    // Update booking count badge if applicable
                    const badgeElement = document.querySelector(`#${tabId}-tab .tab-badge`);
                    if (badgeElement) {
                        let count = parseInt(badgeElement.textContent);
                        badgeElement.textContent = Math.max(0, count - 1);
                    }
                    
                    // Show success message
                    showAlert('success', data.message || 'Booking deleted successfully', tabId);
                    
                    // Check if there are any booking rows left
                    const remainingRows = document.querySelectorAll(`#${tabId} tbody tr.booking-row`).length;
                    console.log(`Remaining rows after deletion in ${tabId}:`, remainingRows);
                    
                    // If no more bookings in this tab, show empty state
                    if (remainingRows === 0) {
                        const tbody = document.querySelector(`#${tabId} tbody`);
                        const cols = document.querySelector(`#${tabId} thead tr`).children.length;
                        const emptyRow = document.createElement('tr');
                        
                        // Set appropriate message based on tab
                        let emptyMessage = 'No bookings';
                        let emptyIcon = 'fas fa-calendar-times';
                        
                        if (tabId === 'completed') {
                            emptyMessage = 'No completed bookings';
                            emptyIcon = 'fas fa-flag-checkered';
                        } else if (tabId === 'approved') {
                            emptyMessage = 'No approved bookings';
                            emptyIcon = 'fas fa-calendar-check';
                        } else if (tabId === 'rejected') {
                            emptyMessage = 'No rejected bookings';
                            emptyIcon = 'fas fa-calendar-times';
                        } else if (tabId === 'cancelled') {
                            emptyMessage = 'No cancelled bookings';
                            emptyIcon = 'fas fa-calendar-times';
                        }
                        
                        emptyRow.innerHTML = `
                            <td colspan="${cols}" class="empty-state text-center">
                                <i class="${emptyIcon}"></i>
                                <p>${emptyMessage}</p>
                            </td>
                        `;
                        tbody.appendChild(emptyRow);
                    }
                }, 500);
            } else {
                // Show error message
                showAlert('danger', data.message || 'Error deleting booking', tabId);
            }
        })
        .catch(error => {
            deleteBookingModal.hide();
            
            // Show error message
            console.error('Error:', error);
            showAlert('danger', 'An error occurred while deleting the booking', tabId);
        });
    });
    
    function showAlert(type, message, tabId = 'completed') {
        const alertContainer = document.createElement('div');
        alertContainer.className = `alert alert-${type} alert-dismissible fade show mt-3`;
        alertContainer.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        
        // Insert at the top of the specified tab's table container
        const tableContainer = document.querySelector(`#${tabId} .table-container`);
        if (tableContainer) {
            tableContainer.insertBefore(alertContainer, tableContainer.firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alertContainer.parentNode) {
                    const bsAlert = new bootstrap.Alert(alertContainer);
                    bsAlert.close();
                }
            }, 5000);
        } else {
            console.error(`Table container for tab ${tabId} not found`);
        }
    }

    // Add the viewBooking function to handle viewing booking details
    function viewBooking(bookingId) {
        // Fetch booking details via AJAX
        fetch(`/admin/bookings/${bookingId}/details`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const booking = data.booking;
                    
                    // Populate modal with booking information
                    document.getElementById('modal-guest-name').textContent = booking.guest_name;
                    document.getElementById('modal-guest-count').textContent = booking.num_guests;
                    document.getElementById('modal-room-number').textContent = booking.room_number;
                    document.getElementById('modal-room-type').textContent = booking.room_type;
                    document.getElementById('modal-checkin').textContent = booking.check_in_date;
                    document.getElementById('modal-checkout').textContent = booking.check_out_date;
                    document.getElementById('modal-total').textContent = '₱' + parseFloat(booking.total_price).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    
                    // Format payment method display
                    if (booking.payment_method === 'gcash') {
                        document.getElementById('modal-payment-method').textContent = 'GCash';
                    } else if (booking.payment_method === 'pay_on_site') {
                        document.getElementById('modal-payment-method').textContent = 'Pay on Site';
                    } else {
                        document.getElementById('modal-payment-method').textContent = booking.payment_method;
                    }
                    
                    // Show the modal
                    const viewModal = new bootstrap.Modal(document.getElementById('viewBookingModal'));
                    viewModal.show();
                } else {
                    alert('Error loading booking details');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error loading booking details');
            });
    }

    // View booking buttons
    document.querySelectorAll('.view-booking-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const bookingId = this.getAttribute('data-id');
            viewBooking(bookingId);
        });
    });
    
    // Delete booking buttons
    document.querySelectorAll('.delete-booking-btn').forEach(function(button) {
        button.addEventListener('click', function() {
            const bookingId = this.getAttribute('data-id');
            deleteBooking(bookingId);
        });
    });

    // Handle receipt modal functionality
    document.getElementById('adminViewReceiptBtn').addEventListener('click', function(e) {
        e.preventDefault();
        const url = this.getAttribute('href');
        if (url === '#') return;
        
        // Close the payment modal
        const paymentModal = bootstrap.Modal.getInstance(document.getElementById('paymentModal'));
        if (paymentModal) {
            paymentModal.hide();
        }
        
        // Set iframe source to the receipt URL
        document.getElementById('receiptFrame').src = url;
        
        // Show the modal
        const receiptModal = new bootstrap.Modal(document.getElementById('receiptModal'));
        receiptModal.show();
    });

    // Handle print button click
    document.getElementById('printReceiptBtn').addEventListener('click', function() {
        const iframe = document.getElementById('receiptFrame');
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
    });

    // Handle download button click
    document.getElementById('downloadReceiptBtn').addEventListener('click', function() {
        const iframe = document.getElementById('receiptFrame');
        
        // Create a PDF from the iframe content using html2pdf library
        if (!window.html2pdf) {
            // If html2pdf is not loaded, show an alert and load the library
            alert('Preparing PDF download...');
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
            script.onload = function() {
                // After library loads, call function again to generate PDF
                document.getElementById('downloadReceiptBtn').click();
            };
            document.body.appendChild(script);
            return;
        }
        
        // Set options for PDF generation
        const options = {
            margin: 10,
            filename: 'booking_receipt.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        
        // Get the iframe document
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        const receiptContent = iframeDoc.querySelector('.receipt-main');
        
        // Generate the PDF
        html2pdf().from(receiptContent).set(options).save();
    });

    // --- Live updates: poll for new pending bookings and prepend to the Pending tab ---
    (function setupLivePendingUpdates(){
        const pendingTbody = document.querySelector('#pending tbody');
        if (!pendingTbody) return;

        function getHighestPendingId() {
            let maxId = 0;
            pendingTbody.querySelectorAll('tr.booking-row .transaction-id').forEach(function(cell){
                const id = parseInt(cell.textContent.trim());
                if (!isNaN(id)) maxId = Math.max(maxId, id);
            });
            return maxId;
        }

        function createPendingRow(b) {
            const tr = document.createElement('tr');
            tr.className = 'booking-row';
            tr.innerHTML = `
                <td class="transaction-id">${b.id}</td>
                <td>${b.guest_name || ''}</td>
                <td>${b.room_number} (${b.room_type})</td>
                <td>${b.num_guests}</td>
                <td>${b.check_in_date}</td>
                <td>${b.check_out_date}</td>
                <td>₱${(b.total_price || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                <td><span class="badge bg-warning">Pending</span></td>
                <td>
                    ${b.payment_method === 'gcash' || b.payment_method === 'paymaya' || b.payment_method === 'qr_payment' ? `
                        <button type="button" class="btn btn-view-payment btn-sm" 
                                data-bs-toggle="modal" 
                                data-bs-target="#paymentModal"
                                data-reference="${b.payment_reference || ''}"
                                data-payment-method="${(b.payment_method || '').toUpperCase()}"
                                data-screenshot="${b.payment_screenshot ? ('/static/' + b.payment_screenshot) : ''}">
                            View Payment
                        </button>` : '<span class="badge bg-secondary">Pay on Site</span>'}
                </td>
                <td>
                    <div class="action-buttons action-buttons-stacked">
                        <form action="/admin/bookings/${b.id}/approve" method="post" class="action-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="action-btn btn-confirm">
                                <i class="fas fa-check"></i> Confirm
                            </button>
                        </form>
                        <button type="button" class="action-btn btn-reject open-reject-modal" data-booking-id="${b.id}">
                            <i class="fas fa-times"></i> Reject
                        </button>
                    </div>
                </td>
            `;
            return tr;
        }

        function prependNewBookings(bookings) {
            if (!Array.isArray(bookings) || bookings.length === 0) return;

            // Remove empty state row if present
            const empty = pendingTbody.querySelector('tr:not(.booking-row)');
            if (empty) empty.remove();

            // Append to bottom to match Confirmed tab visual order
            bookings.sort((a,b) => a.id - b.id).forEach(function(b){
                const row = createPendingRow(b);
                row.style.transition = 'background-color 800ms ease';
                row.style.backgroundColor = 'rgba(76, 175, 80, 0.10)';
                pendingTbody.appendChild(row);
                setTimeout(function(){ row.style.backgroundColor = ''; }, 900);
            });

            // Update Pending tab badge count
            const badge = document.querySelector('#pending-tab .tab-badge');
            if (badge) {
                const current = parseInt(badge.textContent) || 0;
                badge.textContent = current + bookings.length;
            }
        }

        let lastId = getHighestPendingId();
        setInterval(function(){
            fetch(`/api/admin/bookings/updates?status=pending&after_id=${lastId}`)
                .then(r => r.json())
                .then(data => {
                    if (!data || !data.success || !Array.isArray(data.bookings)) return;
                    const newOnes = data.bookings.filter(b => b.id > lastId);
                    if (newOnes.length) {
                        prependNewBookings(newOnes);
                        lastId = Math.max(lastId, ...newOnes.map(b => b.id));
                    }
                })
                .catch(() => {});
        }, 5000);
    })();

    // Reject with reason flow
    (function setupRejectReason(){
        const modalEl = document.getElementById('rejectReasonModal');
        if (!modalEl) return;
        const rejectModal = new bootstrap.Modal(modalEl);
        let rejectBookingId = null;
        // Delegated handler so dynamically added rows work without refresh
        document.addEventListener('click', function(e){
            const trigger = e.target.closest('.open-reject-modal');
            if (!trigger) return;
            rejectBookingId = trigger.getAttribute('data-booking-id');
            const form = document.getElementById('rejectReasonForm');
            form.action = `/admin/bookings/${rejectBookingId}/reject`;
            const textarea = document.getElementById('rejectReason');
            if (textarea) textarea.value = '';
            rejectModal.show();
        });
    })();
});
</script>
{% endblock %} 