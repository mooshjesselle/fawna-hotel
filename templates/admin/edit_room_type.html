{% extends "admin/base_admin.html" %}

{% block title %}Edit Room Type{% endblock %}

{% block extra_css %}
{{ super() }}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
{% endblock %}

{% block admin_content %}

<style>
    .light-button {
    background:#42A5F5;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    
}

.green-button {
    background:#66BB6A;
    color: white;
    border: none;
    font-size: 14px;
    padding: 5px 10px;
    border-radius: 4px;
    cursor: pointer;
    
}

.center-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 80vh;
}

.word-count {
    font-size: 0.85rem;
    color: #6c757d;
    text-align: right;
    margin-top: 0.25rem;
}

.word-count.exceeded {
    color: #dc3545;
    font-weight: bold;
}

</style>
<div class="container center-container">
    <div class="row w-100 justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header">
                    <h4>Edit Room Type</h4>
                </div>
                <div class="card-body">
                    <form method="POST" id="editRoomTypeForm" novalidate>
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" name="name" 
                                   value="{{ room_type.name }}" required
                                   minlength="2"
                                   maxlength="50">
                            <div class="invalid-feedback" id="nameInvalidFeedback">
                                Please enter a valid name (2-50 characters)
                            </div>
                            <div class="word-count" id="nameWordCount">0/20 words</div>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" name="description" 
                                      rows="3" required
                                      minlength="10"
                                      maxlength="500">{{ room_type.description }}</textarea>
                            <div class="invalid-feedback" id="descriptionInvalidFeedback">
                                Please enter a description (10-500 characters)
                            </div>
                            <div class="word-count" id="descriptionWordCount">0/100 words</div>
                        </div>
                        <div class="mb-3">
                            <label for="price_per_night" class="form-label">Price per Night</label>
                            <div class="input-group">
                                <span class="input-group-text">₱</span>
                                <input type="text" class="form-control" id="price_per_night_formatted" autocomplete="off" inputmode="decimal" pattern="[0-9,\.]*" required value="{{ '%.2f'|format(room_type.price_per_night) | replace(',', '') | replace('.', '.') }}">
                                <input type="hidden" id="price_per_night" name="price_per_night" value="{{ '%.2f'|format(room_type.price_per_night) }}">
                            </div>
                            <div class="invalid-feedback" id="priceInvalidFeedback">
                                Please enter a valid price between ₱0.00 and ₱50,000.00
                            </div>
                            <div class="form-text">Enter price with two decimal places (e.g., 1000.00). Maximum price: ₱50,000.00</div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('admin_rooms') }}" class="btn btn-secondary">Back</a>
                            <button type="submit" class="light-button">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Word count validation
function countWords(text) {
    return text.trim().split(/\s+/).filter(word => word.length > 0).length;
}

// Check for repeated characters (5 or more of the same character in a row)
function hasRepeatedCharacters(text, limit = 5) {
    const repeatedCharRegex = new RegExp(`(.)\\1{${limit-1},}`, 'g');
    return repeatedCharRegex.test(text);
}

// Update word counts on page load
document.addEventListener('DOMContentLoaded', function() {
    const nameInput = document.getElementById('name');
    const descriptionInput = document.getElementById('description');
    const priceFormattedInput = document.getElementById('price_per_night_formatted');
    const priceHiddenInput = document.getElementById('price_per_night');
    const nameWordCount = document.getElementById('nameWordCount');
    const descriptionWordCount = document.getElementById('descriptionWordCount');
    
    // Initialize word counts
    updateWordCount(nameInput, nameWordCount, 20);
    updateWordCount(descriptionInput, descriptionWordCount, 100);
    
    // Add event listeners for real-time validation
    nameInput.addEventListener('input', function() {
        updateWordCount(this, nameWordCount, 20);
        
        // Immediate validation
        if (this.value.length < 2 || this.value.length > 50) {
            this.classList.add('is-invalid');
            document.getElementById('nameInvalidFeedback').textContent = 'Please enter a valid name (2-50 characters)';
        } else if (countWords(this.value) > 20) {
            this.classList.add('is-invalid');
            document.getElementById('nameInvalidFeedback').textContent = 'Name cannot exceed 20 words';
        } else if (hasRepeatedCharacters(this.value, 5)) {
            this.classList.add('is-invalid');
            document.getElementById('nameInvalidFeedback').textContent = 'Name contains too many repeated characters';
        } else {
            this.classList.remove('is-invalid');
        }
    });
    
    descriptionInput.addEventListener('input', function() {
        updateWordCount(this, descriptionWordCount, 100);
        
        // Immediate validation
        if (this.value.length < 10 || this.value.length > 500) {
            this.classList.add('is-invalid');
            document.getElementById('descriptionInvalidFeedback').textContent = 'Please enter a description (10-500 characters)';
        } else if (countWords(this.value) > 100) {
            this.classList.add('is-invalid');
            document.getElementById('descriptionInvalidFeedback').textContent = 'Description cannot exceed 100 words';
        } else if (hasRepeatedCharacters(this.value, 5)) {
            this.classList.add('is-invalid');
            document.getElementById('descriptionInvalidFeedback').textContent = 'Description contains too many repeated characters';
        } else {
            this.classList.remove('is-invalid');
        }
    });
    
    if (priceFormattedInput && priceHiddenInput) {
        // Format initial value with commas and two decimals
        if (priceFormattedInput.value) {
            let raw = priceFormattedInput.value.replace(/,/g, '');
            let floatVal = parseFloat(raw);
            if (!isNaN(floatVal)) {
                priceFormattedInput.value = floatVal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                priceHiddenInput.value = floatVal.toFixed(2);
            }
        }
        priceFormattedInput.addEventListener('input', function() {
            let raw = this.value.replace(/,/g, '');
            raw = raw.replace(/[^0-9.]/g, '');
            const parts = raw.split('.');
            let intPart = parts[0];
            let decPart = parts[1] ? parts[1].slice(0,2) : '';
            intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            let formatted = intPart;
            if (decPart.length > 0) {
                formatted += '.' + decPart;
            }
            this.value = formatted;
            let floatVal = parseFloat(raw);
            if (!isNaN(floatVal)) {
                priceHiddenInput.value = floatVal.toFixed(2);
            } else {
                priceHiddenInput.value = '';
            }
        });
        priceFormattedInput.addEventListener('blur', function() {
            let raw = this.value.replace(/,/g, '');
            let floatVal = parseFloat(raw);
            if (!isNaN(floatVal)) {
                let formatted = floatVal.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                this.value = formatted;
                priceHiddenInput.value = floatVal.toFixed(2);
            }
        });
    }
});

function updateWordCount(element, countElement, limit) {
    const words = countWords(element.value);
    countElement.textContent = `${words}/${limit} words`;
    
    if (words > limit) {
        countElement.classList.add('exceeded');
    } else {
        countElement.classList.remove('exceeded');
    }
}

document.getElementById('editRoomTypeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const form = this;
    const name = document.getElementById('name');
    const description = document.getElementById('description');
    const priceFormattedInput = document.getElementById('price_per_night_formatted');
    const priceHiddenInput = document.getElementById('price_per_night');
    let isValid = true;
    
    // Reset previous validation states
    form.classList.remove('was-validated');
    [name, description, priceFormattedInput].forEach(input => {
        input.classList.remove('is-invalid');
    });
    
    // Validate name
    if (name.value.length < 2 || name.value.length > 50) {
        name.classList.add('is-invalid');
        document.getElementById('nameInvalidFeedback').textContent = 'Please enter a valid name (2-50 characters)';
        isValid = false;
    } else if (countWords(name.value) > 20) {
        name.classList.add('is-invalid');
        document.getElementById('nameInvalidFeedback').textContent = 'Name cannot exceed 20 words';
        isValid = false;
    } else if (hasRepeatedCharacters(name.value, 5)) {
        name.classList.add('is-invalid');
        document.getElementById('nameInvalidFeedback').textContent = 'Name contains too many repeated characters';
        isValid = false;
    }
    
    // Validate description
    if (description.value.length < 10 || description.value.length > 500) {
        description.classList.add('is-invalid');
        document.getElementById('descriptionInvalidFeedback').textContent = 'Please enter a description (10-500 characters)';
        isValid = false;
    } else if (countWords(description.value) > 100) {
        description.classList.add('is-invalid');
        document.getElementById('descriptionInvalidFeedback').textContent = 'Description cannot exceed 100 words';
        isValid = false;
    } else if (hasRepeatedCharacters(description.value, 5)) {
        description.classList.add('is-invalid');
        document.getElementById('descriptionInvalidFeedback').textContent = 'Description contains too many repeated characters';
        isValid = false;
    }
    
    // Validate price
    const priceValue = parseFloat(priceHiddenInput.value);
    if (isNaN(priceValue) || priceValue < 0 || priceValue > 50000) {
        priceFormattedInput.classList.add('is-invalid');
        document.getElementById('priceInvalidFeedback').textContent = 'Please enter a valid price between ₱0.00 and ₱50,000.00';
        isValid = false;
    } else {
        priceFormattedInput.classList.remove('is-invalid');
    }
    
    // Format price to always have two decimal places
    if (isValid) {
        priceHiddenInput.value = priceValue.toFixed(2);
        form.submit();
    } else {
        form.classList.add('was-validated');
    }
});

// Format price input to always show two decimal places
document.getElementById('price_per_night').addEventListener('blur', function() {
    const value = parseFloat(this.value);
    if (!isNaN(value)) {
        this.value = value.toFixed(2);
    }
});
</script>
{% endblock %} 