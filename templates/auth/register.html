{% extends "base.html" %}

{% block title %}Register{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
<style>
    .auth-container {
        padding: 12px 16px 16px; /* tighter top/bottom padding */
        min-height: auto; /* avoid forcing viewport height */
        display: flex;
        align-items: flex-start; /* keep content near top */
        justify-content: center;
        width: 100%;
    }

    .auth-card {
        background: white;
        padding: 28px; /* reduce internal padding */
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        width: 100%;
        max-width: 600px;
        margin-top: 8px; /* reduce top margin */
        min-height: auto; /* no forced min-height */
    }

    .auth-header {
        text-align: center;
        margin-bottom: 30px;
        position: relative;
    }

    .auth-header h2 {
        color: #8b5e3b;
        font-size: 24px;
        margin-bottom: 10px;
    }

    .back-button {
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #8b5e3b;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 16px;
        padding: 5px;
        transition: all 0.3s ease;
    }

    .back-button:hover {
        color: #6b4423;
    }

    .back-button i {
        font-size: 18px;
    }

    .edit-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        justify-content: center; /* Center the buttons horizontally */
        flex-wrap: wrap; /* Allow buttons to wrap on smaller screens */
    }

    .edit-button {
        background: none;
        border: 2px solid #8b5e3b;
        color: #8b5e3b;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        font-size: 14px;
        transition: all 0.3s ease;
        min-width: 150px; /* Set a minimum width for consistent button sizes */
        justify-content: center; /* Center the text and icon within each button */
    }

    .edit-button:hover {
        background-color: #f5e6d3;
        color: #6b4423;
        border-color: #6b4423;
    }

    .edit-button i {
        font-size: 14px;
    }

    /* Progress Bar Styles */
    .progress-container {
        margin: 20px 0 50px 0;
        padding: 0;
        position: relative;
    }

    .progress-steps {
        display: flex;
        justify-content: space-between;
        position: relative;
        margin-bottom: 60px;
        align-items: center;
        width: 100%;
    }

    .progress-steps::before {
        content: '';
        background-color: #e0e0e0;
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        transform: translateY(-50%);
        height: 3px;
        width: 100%;
        z-index: 1;
    }

    .progress-steps .progress-bar {
        background-color: #8b5e3b;
        position: absolute;
        top: 50%;
        left: 0;
        transform: translateY(-50%);
        height: 3px;
        width: 0%;
        z-index: 2;
        transition: width 0.3s ease;
    }

    .step-group {
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 3;
        position: relative;
        width: 35px;
    }

    .step {
        background-color: #fff;
        border: 3px solid #e0e0e0;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #999;
        position: relative;
        transition: all 0.3s ease;
        z-index: 3;
    }

    .step.active {
        border-color: #8b5e3b;
        color: #8b5e3b;
        background-color: #fff;
    }

    .step.completed {
        border-color: #8b5e3b;
        background-color: #8b5e3b;
        color: white;
    }

    .step-label {
        position: absolute;
        top: 45px;
        left: 50%;
        transform: translateX(-50%);
        white-space: nowrap;
        font-size: 14px;
        color: #666;
        font-weight: 500;
        width: max-content;  /* Ensures text doesn't wrap */
    }

    .step.active .step-label {
        color: #8b5e3b;
        font-weight: bold;
    }

    .step.completed .step-label {
        color: #8b5e3b;
    }

    /* Button group styles */
    .button-group {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }

    .button-group .register-button {
        flex: 1;
    }

    .register-button.secondary {
        background-color: #fff;
        border: 2px solid #8b5e3b;
        color: #8b5e3b;
    }

    .register-button.secondary:hover {
        background-color: #f5e6d3;
        color: #6b4423;
        border-color: #6b4423;
    }

    .form-group {
        margin-bottom: 20px;
        position: relative;
    }

    .form-label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
    }

    .form-control {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
    }

    .form-control:focus {
        border-color: #8b5e3b;
        outline: none;
        box-shadow: 0 0 0 2px rgba(139, 94, 59, 0.2);
    }

    .form-control.is-invalid {
        border-color: #dc3545;
    }

    .invalid-feedback {
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 5px;
        display: none;
    }

    .invalid-feedback.show {
        display: block !important;
    }

    /* Add this to ensure only one error message is shown */
    .alert-error {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid transparent;
        border-radius: 5px;
        text-align: center;
    }

    .loading-spinner {
        display: none;
        width: 30px;
        height: 30px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #8b5e3b;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 10px auto;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .register-button {
        background-color: #8b5e3b;
        border: none;
        color: white;
        padding: 12px 24px;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 20px;
        font-weight: 500;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
    }

    .register-button:hover {
        background-color: #6b4423;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
    }

    .register-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .register-button:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(139, 94, 59, 0.3);
    }

    .register-button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
        transform: none;
    }

    .text-center {
        text-align: center;
        margin-top: 20px;
    }

    .text-danger {
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 5px;
        display: block;
    }

    .verification-section {
        display: none;
    }

    .verification-section.active {
        display: block;
    }

    /* Registration form styles */
    .registration-form {
        display: none;
        max-height: none; /* Remove max height restriction */
        overflow-y: visible; /* Change from auto to visible */
        padding-bottom: 40px; /* Add bottom padding */
    }

    .registration-form.active {
        display: block;
    }

    /* Scrollbar styling */
    .registration-form::-webkit-scrollbar {
        width: 6px;
    }

    .registration-form::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .registration-form::-webkit-scrollbar-thumb {
        background: #8b5e3b;
        border-radius: 10px;
    }

    .registration-form::-webkit-scrollbar-thumb:hover {
        background: #6b4423;
    }

    .verification-code {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
    }

    .verification-code input {
        width: 50px;
        height: 50px;
        text-align: center;
        font-size: 24px;
        border: 2px solid #ddd;
        border-radius: 5px;
    }

    .verification-code input:focus {
        border-color: #8b5e3b;
        outline: none;
    }

    .resend-button {
        background: none;
        border: none;
        text-decoration: underline;
        cursor: pointer;
        margin-top: 10px;
    }

    .resend-button:disabled {
        color: #999;
        cursor: not-allowed;
    }

    #resendTimer {
        color: #666;
        font-size: 0.9em;
        margin-top: 5px;
    }

    /* Step Summary Styles */
    .step-summary {
        margin-top: 30px;
        padding: 0 20px;
    }

    .summary-item {
        display: none;
        background-color: #f5e6d3;
        border-radius: 8px;
        padding: 15px 20px;
        margin-bottom: 20px;
    }

    .summary-item.active {
        display: block;
    }

    .summary-item h3 {
        color: #8b5e3b;
        font-size: 18px;
        margin-bottom: 10px;
        font-weight: 600;
    }

    .summary-item ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .summary-item li {
        color: #6b4423;
        margin-bottom: 8px;
        padding-left: 20px;
        position: relative;
        font-size: 14px;
    }

    .summary-item li:before {
        content: "•";
        color: #8b5e3b;
        position: absolute;
        left: 0;
    }

    /* Add styles for summary section */
    .summary-content {
        background-color: #f9f3ee;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .summary-item {
        margin-bottom: 15px;
        display: flex;
        gap: 10px;
        align-items: flex-start; /* keep rows aligned at top */
        line-height: 1.35;       /* improve readability */
    }

    .summary-item label {
        font-weight: bold;
        color: #8b5e3b;
        min-width: 110px;
        flex: 0 0 110px;        /* stable label column */
    }

    .summary-item span {
        color: #333;
        word-break: break-word; /* wrap long content */
        overflow-wrap: anywhere; /* ensure wrapping on mobiles */
        flex: 1 1 auto;
    }

    /* Success message styles */
    .success-message {
        text-align: center;
        padding: 20px;
        background-color: #f5e6d3;
        border-radius: 8px;
        margin-top: 20px;
    }

    .success-message h3 {
        color: #8b5e3b;
        margin-bottom: 10px;
    }

    .success-message p {
        color: #6b4423;
        margin-bottom: 15px;
    }

    /* Dropdown styling */
    select.form-control {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23495057' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px;
        padding-right: 2.5rem;
        cursor: pointer;
        border: 1px solid #ced4da;
        border-radius: 4px;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }
    
    /* Ensure dropdown arrow shows in all browsers */
    select.form-control::-ms-expand {
        display: none;
    }
    
    /* Hover effect */
    select.form-control:hover {
        border-color: #80bdff;
    }
    
    /* Focus effect */
    select.form-control:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }
    
    /* Disabled state */
    select.form-control:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    /* Remove the old dropdown styling */
    .form-control {
        width: 100%;
        padding: 10px 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 16px;
    }

    /* ID Preview Styles */
    #idPreviewContainer {
        margin-top: 15px;
        display: none;
        position: relative;
    }
    
    .preview-wrapper {
        position: relative;
        display: inline-block;
        max-width: 150px; /* Smaller thumbnail size */
        cursor: pointer;
    }
    
    #idPreview {
        width: 150px; /* Fixed width for thumbnail */
        height: 100px; /* Fixed height for thumbnail */
        object-fit: cover; /* Maintain aspect ratio */
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: 2px solid #ddd;
        transition: transform 0.2s;
    }
    
    .preview-wrapper:hover #idPreview {
        transform: scale(1.05);
    }
    
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.8);
        backdrop-filter: blur(5px);
    }
    
    .modal-content {
        position: relative;
        margin: auto;
        padding: 20px;
        width: 90%;
        max-width: 800px;
        top: 35%;
        
    }
    
    .modal-image {
        width: 100%;
        max-height: 80vh;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .close-modal {
        position: absolute;
        top: -15px;
        right: -15px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 18px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 1001;
    }
    
    .close-modal:hover {
        background: #c82333;
    }
    
    .remove-preview {
        position: absolute;
        top: -10px;
        right: -10px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 14px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        z-index: 2;
    }
    
    .remove-preview:hover {
        background: #c82333;
    }
    
    .preview-label {
        margin-bottom: 10px;
        color: #666;
        font-size: 0.9em;
    }
    
    .click-to-enlarge {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
        text-align: center;
    }

    /* Terms and Conditions Modal Styling */
    .terms-content {
        line-height: 1.6;
        font-family: 'Roboto', sans-serif;
    }
    
    .terms-content h6 {
        color: #6D4C41 !important;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 8px;
        margin-bottom: 15px;
    }
    
    .terms-content ul {
        padding-left: 20px;
    }
    
    .terms-content li {
        margin-bottom: 8px;
        position: relative;
    }
    
    .terms-content li::marker {
        color: #8b5e3b;
        font-weight: bold;
    }
    
    .terms-content .alert-info {
        background-color: #e7f3ff;
        border-color: #b8daff;
        color: #004085;
        border-radius: 8px;
        padding: 15px;
    }
    
    .terms-content .text-primary {
        color: #6D4C41 !important;
        font-weight: 600;
    }
    
    .terms-content .text-muted {
        color: #6c757d !important;
    }
    
    .terms-content .small {
        font-size: 0.9rem;
    }
    
    .form-check-label {
        color: #333 !important;
        font-size: 0.95rem;
    }
    
    .form-check-input:checked {
        background-color: #8b5e3b;
        border-color: #8b5e3b;
    }
    
    .form-check-input:focus {
        box-shadow: 0 0 0 0.2rem rgba(139, 94, 59, 0.25);
    }
    
    /* Scrollbar styling for terms modal */
    .modal-body::-webkit-scrollbar {
        width: 8px;
    }
    
    .modal-body::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .modal-body::-webkit-scrollbar-thumb {
        background: #8b5e3b;
        border-radius: 10px;
    }
    
    .modal-body::-webkit-scrollbar-thumb:hover {
        background: #6b4423;
    }

    /* Mobile fixes to prevent overlapping text */
    @media (max-width: 576px) {
        .auth-card { padding: 20px; }
        .progress-steps { margin-bottom: 36px; }
        .progress-steps::before { height: 2px; }
        .step-group { width: 28px; }
        .step { width: 28px; height: 28px; border-width: 2px; }
        .step-number { width: 24px; height: 24px; }
        .step-label {
            top: 34px;
            font-size: 11px;
            line-height: 1.2;
            white-space: normal;      /* allow wrapping */
            max-width: 80px;          /* constrain width */
            text-align: center;
        }
        /* OTP alignment fix on mobile */
        .verification-code { gap: 8px; }
        .verification-code input {
            width: 42px;
            height: 42px;
            font-size: 20px;
        }
        .form-text, small { font-size: 12px; }
        /* Summary mobile fixes */
        .summary-content { padding: 16px; }
        .summary-item { gap: 8px; line-height: 1.3; }
        .summary-item label { min-width: 90px; flex: 0 0 90px; font-size: 13px; }
        .summary-item span { font-size: 13px; }
        /* Smaller buttons on mobile */
        .edit-button {
            padding: 6px 10px;
            font-size: 12px;
            min-width: auto;
        }
        .button-group { gap: 10px; }
        .register-button {
            padding: 10px 16px;
            font-size: 14px;
            margin-top: 14px;
        }
        
        /* Modal centering */
        .modal-dialog-centered {
            display: flex;
            align-items: center;
            min-height: calc(100% - 1rem);
        }
        
        @media (min-width: 576px) {
            .modal-dialog-centered {
                min-height: calc(100% - 3.5rem);
            }
        }
        
        /* Mobile terms modal adjustments */
        .modal-lg {
            max-width: 95%;
            margin: 10px auto;
        }
        
        .modal-body {
            padding: 20px !important;
            max-height: 50vh !important;
        }
        
        .terms-content h6 {
            font-size: 1rem;
            margin-bottom: 12px;
        }
        
        .terms-content .small {
            font-size: 0.85rem;
        }
        
        .form-check-label {
            font-size: 0.9rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <h2>User Registration</h2>
        </div>

        <!-- Progress Steps -->
        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-bar"></div>
                <div class="step-group">
                    <div class="step completed" data-step="1">
                        1
                        <span class="step-label">Email</span>
                    </div>
                </div>
                <div class="step-group">
                    <div class="step" data-step="2">
                        2
                        <span class="step-label">Personal Details</span>
                    </div>
                </div>
                <div class="step-group">
                    <div class="step" data-step="3">
                        3
                        <span class="step-label">ID Upload</span>
                    </div>
                </div>
                <div class="step-group">
                    <div class="step" data-step="4">
                        4
                        <span class="step-label">Summary</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Email Verification Section -->
        <div id="emailSection" class="verification-section active">
            <form id="emailForm" method="POST" action="{{ url_for('send_verification_email') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" name="email" class="form-control" id="email" 
                           placeholder="Enter your email address" 
                           pattern="[a-z0-9._%+-]{3,}@(gmail\.com|yahoo\.com|outlook\.com|hotmail\.com)$"
                           title="Email must have at least 3 characters before @ and use lowercase letters with allowed domains only"
                           oninput="this.value = this.value.toLowerCase()"
                           required>
                    <small class="form-text text-muted">Email must have at least 3 characters before @ and use only: @gmail.com, @yahoo.com, @outlook.com, @hotmail.com</small>
                    <div class="invalid-feedback" id="email-error"></div>
                </div>
                <div class="loading-spinner" id="emailLoadingSpinner"></div>
                <button type="submit" class="register-button" id="emailSubmitBtn">Send Verification Code</button>
            </form>
        </div>

        <!-- Verification Code Section -->
        <div id="verificationSection" class="verification-section">
            <form id="verificationForm" method="POST" action="{{ url_for('verify_email_code') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="email" id="verificationEmail">
                <div class="form-group text-center">
                    <p>Please enter the verification code sent to your email</p>
                    <div class="verification-code">
                        <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                        <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                        <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                        <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                        <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                        <input type="text" maxlength="1" pattern="[0-9]" inputmode="numeric" required>
                    </div>
                    <input type="hidden" name="verification_code" id="verificationCodeInput">
                    <div id="resendTimer"></div>
                    <button type="button" class="resend-button" id="resendButton" disabled>Resend Code</button>
                    <div class="invalid-feedback" id="verification-error"></div>
                </div>
                <button type="submit" class="register-button">Verify Code</button>
            </form>
        </div>

        <!-- Personal Details Section -->
        <div id="personalDetailsSection" class="registration-form">
            <div class="auth-header">
                <h2>Personal Details</h2>
            </div>
            <form id="personalDetailsForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="verified_email" id="verifiedEmail">
                
                <div class="name-fields">
                    <div class="form-group">
                        <label class="form-label">First Name</label>
                        <input type="text" name="first_name" class="form-control name-input" required 
                               pattern="[A-Za-z\s]+" title="Only letters and spaces allowed"
                               oninput="formatName(this)">
                        <div class="invalid-feedback" id="first-name-error"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Middle Name <span class="optional-label">(optional)</span></label>
                        <input type="text" name="middle_name" class="form-control name-input"
                               pattern="[A-Za-z\s]*" title="Only letters and spaces allowed"
                               oninput="formatName(this)">
                        <div class="invalid-feedback" id="middle-name-error"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Surname</label>
                        <input type="text" name="surname" class="form-control name-input" required
                               pattern="[A-Za-z\s]+" title="Only letters and spaces allowed"
                               oninput="formatName(this)">
                        <div class="invalid-feedback" id="surname-error"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Suffix <span class="optional-label">(optional)</span></label>
                        <select name="suffix" class="form-control">
                            <option value="">None</option>
                            <option value="Jr.">Jr.</option>
                            <option value="Sr.">Sr.</option>
                            <option value="III">III</option>
                            <option value="IV">IV</option>
                            <option value="V">V</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" name="phone" class="form-control" id="phoneNumber" 
                           value="+639" required pattern="\+639\d{9}"
                           title="Please enter a valid Philippine mobile number (+639XXXXXXXXX)">
                    <div class="invalid-feedback" id="phone-error"></div>
                    <small class="form-text text-muted">Format: +639XXXXXXXXX (Philippine format)</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <div class="input-group">
                        <input type="password" name="password" class="form-control" id="registerPassword" placeholder="Enter your password" required>
                        <div class="input-group-append">
                            <span class="input-group-text bg-white border-left-0" style="height:51px;">
                                <i class="fa fa-eye" id="toggleRegisterPassword" style="cursor: pointer;"></i>
                            </span>
                        </div>
                    </div>
                    <div class="invalid-feedback" id="password-error"></div>
                    <small class="form-text text-muted">Password must be at least 8 characters long and include uppercase, lowercase, number, and special character.</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Confirm Password</label>
                    <div class="input-group">
                        <input type="password" name="confirm_password" class="form-control" id="confirmRegisterPassword" placeholder="Confirm your password" required>
                        <div class="input-group-append">
                            <span class="input-group-text bg-white border-left-0" style="height:51px;">
                                <i class="fa fa-eye" id="toggleConfirmRegisterPassword" style="cursor: pointer;"></i>
                            </span>
                        </div>
                    </div>
                    <div class="invalid-feedback" id="confirm-password-error"></div>
                </div>

                <div class="button-group">
                    <button type="button" class="register-button secondary" onclick="backToEmail()">Back</button>
                <button type="submit" class="register-button">Continue to ID Upload</button>
                </div>
            </form>
        </div>

        <!-- ID Upload Section -->
        <div id="idUploadSection" class="registration-form" style="display: none;">
            <div class="auth-header">
                <h2>ID Upload</h2>
            </div>
            <form id="registrationForm" method="POST" action="{{ url_for('complete_registration') }}" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="verified_email" id="verifiedEmailFinal">
                <input type="hidden" name="first_name" id="finalFirstName">
                <input type="hidden" name="middle_name" id="finalMiddleName">
                <input type="hidden" name="surname" id="finalSurname">
                <input type="hidden" name="suffix" id="finalSuffix">
                <input type="hidden" name="phone" id="finalPhone">
                <input type="hidden" name="password" id="finalPassword">
                <input type="hidden" name="confirm_password" id="finalConfirmPassword">

                <div class="form-group">
                    <label class="form-label">Valid ID Type</label>
                    <select name="id_type" id="idType" class="form-control" required onchange="validateIdType(this)">
                        <option value="">Select ID Type</option>
                        <option value="passport">Passport</option>
                        <option value="drivers_license">Driver's License</option>
                        <option value="national_id">National ID (PhilSys)</option>
                        <option value="sss">SSS ID / UMID</option>
                        <option value="postal">Postal ID</option>
                        <option value="voters">Voter's ID</option>
                        <option value="prc">PRC ID</option>
                        <option value="philhealth">PhilHealth ID</option>
                        <option value="tin">TIN ID</option>
                        <option value="gsis">GSIS eCard</option>
                        <option value="pagibig">Pag-IBIG ID</option>
                        <option value="company">Company ID</option>
                        <option value="student">Student ID</option>
                        <option value="other">Other Government-issued ID</option>
                    </select>
                    <div class="invalid-feedback" id="id-type-error">Please select a valid ID type</div>
                </div>

                <div class="form-group">
                    <label class="form-label">Upload Valid ID</label>
                    <input type="file" name="id_picture" id="idPicture" class="form-control" accept="image/*" multiple required>
                    <div class="invalid-feedback" id="id-picture-error"></div>
                    <small class="form-text text-muted">Please upload a clear photo of your valid ID</small>
                    <div id="idPreviewContainer">
                        <div class="preview-label">ID Preview:</div>
                        <div id="idPreviewList" style="display:flex; gap:12px; flex-wrap:wrap;"></div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="register-button secondary" onclick="backToPersonalDetails()">Back</button>
                    <button type="button" class="register-button" id="continueToSummary">Continue to Summary</button>
                </div>
            </form>
        </div>
        
        <!-- Summary Section -->
        <div id="summarySection" style="display: none;">
            <div class="auth-header">
                <h2>Registration Summary</h2>
            </div>
            <div class="edit-buttons">
                <button type="button" class="edit-button" onclick="editEmail()">
                    <i class="fas fa-envelope"></i> Edit Email
                </button>
                <button type="button" class="edit-button" onclick="editPersonalDetails()">
                    <i class="fas fa-user"></i> Edit Personal Details
                </button>
                <button type="button" class="edit-button" onclick="editIdUpload()">
                    <i class="fas fa-id-card"></i> Edit ID Upload
                </button>
            </div>
            <div class="summary-content">
                <div class="summary-item">
                    <label>Full Name:</label>
                    <span id="summaryName"></span>
                </div>
                <div class="summary-item">
                    <label>Email:</label>
                    <span id="summaryEmail"></span>
                </div>
                <div class="summary-item">
                    <label>Phone:</label>
                    <span id="summaryPhone"></span>
                </div>
                <div class="summary-item">
                    <label>ID Type:</label>
                    <span id="summaryIdType"></span>
                </div>
            </div>
            <div class="button-group">
                <button type="button" class="register-button secondary" onclick="backToIdUpload()">Back</button>
                <button type="button" class="register-button" id="completeRegistrationBtn">Complete Registration</button>
            </div>
        </div>
        
        <div class="text-center mt-3">
            Already have an account? <a href="{{ url_for('login') }}" style="color: #8b5e3b;">Login here</a>
        </div>
    </div>
</div>

<!-- Add this right before the closing body tag -->
<div id="idPreviewModal" class="modal">
    <div class="modal-content">
        <button class="close-modal" onclick="closeModal()">×</button>
        <img id="modalImage" class="modal-image" src="" alt="ID Preview">
    </div>
</div>

<!-- ID Upload Consent Modal -->
<div id="idConsentModal" class="modal" style="display:none;">
    <div class="modal-content" style="max-width:520px; background:#fff; border-radius:8px;">
        <div style="margin-bottom:12px;">
            <h3 style="margin:0; color:#8b5e3b; font-size:18px;">Confirm ID Upload</h3>
        </div>
        <div style="display:flex; gap:16px; align-items:flex-start;">
            <img id="consentPreview" src="" alt="ID Preview" style="width:140px; height:90px; object-fit:cover; border-radius:6px; border:1px solid #ddd;">
            <div style="flex:1;">
                <p style="margin:0 0 8px 0; color:#333; font-size:14px;">You are about to upload a photo of a valid ID. This will be used for account verification.</p>
                <label style="display:flex; gap:8px; align-items:flex-start; font-size:14px; color:#333;">
                    <input type="checkbox" id="consentCheckbox" style="margin-top:3px;">
                    <span>I confirm I am the owner of this ID and I consent to FAWNA Hotel processing this image for identity verification in accordance with the Terms and Privacy Policy.</span>
                </label>
                <div style="margin-top:12px; display:flex; gap:10px; justify-content:flex-end;">
                    <button type="button" id="consentCancel" class="register-button secondary" style="width:auto;">Cancel</button>
                    <button type="button" id="consentProceed" class="register-button" style="width:auto;" disabled>Proceed</button>
                </div>
            </div>
        </div>
    </div>
  </div>

<script>
// Add formatName function at the top
function formatName(input) {
    // Remove any characters that aren't letters or spaces
    let value = input.value.replace(/[^A-Za-z\s]/g, '');
    
    // Convert to title case (capitalize first letter of each word)
    value = value.toLowerCase().split(' ').map(word => {
            return word.charAt(0).toUpperCase() + word.slice(1);
    }).join(' ');
    
    // Update input value
    input.value = value;
}

// Function to show error below specific input
function showError(inputId, errorMessage) {
    const input = document.querySelector(inputId);
    const errorElement = document.querySelector(inputId + '-error');
    
    if (input && errorElement) {
        input.classList.add('is-invalid');
        errorElement.textContent = errorMessage;
        errorElement.classList.add('show');
    } else {
        // If we can't find the specific error element, try to find it by ID directly
        let errorId = '';
        
        if (inputId === 'input[name="first_name"]') {
            errorId = 'first-name-error';
        } else if (inputId === 'input[name="middle_name"]') {
            errorId = 'middle-name-error';
        } else if (inputId === 'input[name="surname"]') {
            errorId = 'surname-error';
        } else if (inputId === '#phoneNumber') {
            errorId = 'phone-error';
        } else if (inputId === 'input[name="password"]') {
            errorId = 'password-error';
        } else if (inputId === 'input[name="confirm_password"]') {
            errorId = 'confirm-password-error';
        } else if (inputId === '#email') {
            errorId = 'email-error';
        } else if (inputId === '#verification-error') {
            errorId = 'verification-error';
        }
        
        if (errorId) {
            const element = document.getElementById(errorId);
            if (element) {
                if (inputId !== '#verification-error') {
                    const relatedInput = inputId.startsWith('#') 
                        ? document.querySelector(inputId)
                        : document.querySelector(inputId);
                    if (relatedInput) {
                        relatedInput.classList.add('is-invalid');
                    }
                }
                element.textContent = errorMessage;
                element.style.display = 'block';
                element.classList.add('show');
            }
        }
    }
    
    console.log(`Showing error for ${inputId}: ${errorMessage}`);
}

// Function to clear all errors
function clearErrors() {
    const errorElements = document.querySelectorAll('.invalid-feedback');
    const invalidInputs = document.querySelectorAll('.is-invalid');
    
    errorElements.forEach(element => {
        element.textContent = '';
        element.classList.remove('show');
    });
    
    invalidInputs.forEach(input => {
        input.classList.remove('is-invalid');
    });
}

// Update progress bar and steps - moved outside DOMContentLoaded
function updateProgress(currentStep) {
    const steps = document.querySelectorAll('.step');
    const progressBar = document.querySelector('.progress-bar');
    
    // Calculate progress width
    const progress = ((currentStep - 1) / (steps.length - 1)) * 100;
    progressBar.style.width = `${progress}%`;
    
    // Update step states
    steps.forEach((step, idx) => {
        const stepNum = idx + 1;
        if (stepNum < currentStep) {
            step.classList.add('completed');
            step.classList.remove('active');
        } else if (stepNum === currentStep) {
            step.classList.add('active');
            step.classList.remove('completed');
        } else {
            step.classList.remove('completed', 'active');
        }
    });
}

function clearVerificationInputs() {
    // Clear all verification code inputs
    const verificationInputs = document.querySelectorAll('.verification-code input');
    verificationInputs.forEach(input => {
        input.value = '';
        input.style.borderColor = ''; // Reset border color if it was showing error
    });
    // Clear any error messages
    const verificationError = document.getElementById('verification-error');
    if (verificationError) {
        verificationError.textContent = '';
        verificationError.style.display = 'none';
    }
    // Clear the hidden verification code input
    const verificationCodeInput = document.getElementById('verificationCodeInput');
    if (verificationCodeInput) {
        verificationCodeInput.value = '';
    }
}

function clearSensitiveData() {
    // Clear password fields and reset visibility icons
    const registerPassword = document.getElementById('registerPassword');
    const confirmRegisterPassword = document.getElementById('confirmRegisterPassword');
    const toggleRegisterPassword = document.getElementById('toggleRegisterPassword');
    const toggleConfirmRegisterPassword = document.getElementById('toggleConfirmRegisterPassword');
    
    registerPassword.value = '';
    confirmRegisterPassword.value = '';
    registerPassword.type = 'password';
    confirmRegisterPassword.type = 'password';
    toggleRegisterPassword.classList.remove('fa-eye-slash');
    toggleRegisterPassword.classList.add('fa-eye');
    toggleConfirmRegisterPassword.classList.remove('fa-eye-slash');
    toggleConfirmRegisterPassword.classList.add('fa-eye');
    
    // Also clear the hidden password fields
    document.getElementById('finalPassword').value = '';
    document.getElementById('finalConfirmPassword').value = '';
}

function backToEmail() {
    // Clear verification inputs and sensitive data
    clearVerificationInputs();
    clearSensitiveData();
    
    // Store only personal details
    const formData = {
        firstName: document.querySelector('input[name="first_name"]').value,
        middleName: document.querySelector('input[name="middle_name"]').value,
        surname: document.querySelector('input[name="surname"]').value,
        suffix: document.querySelector('select[name="suffix"]').value,
        phone: document.getElementById('phoneNumber').value
    };
    
    // Clear ID upload data
    document.querySelector('select[name="id_type"]').value = '';
    document.getElementById('idPicture').value = '';
    const previewListEl1 = document.getElementById('idPreviewList');
    if (previewListEl1) previewListEl1.innerHTML = '';
    document.getElementById('idPreviewContainer').style.display = 'none';
    
    // Hide all sections
    document.getElementById('personalDetailsSection').style.display = 'none';
    document.getElementById('idUploadSection').style.display = 'none';
    document.getElementById('summarySection').style.display = 'none';
    document.getElementById('verificationSection').style.display = 'none';
    
    // Show email section
    document.getElementById('emailSection').style.display = 'block';
    document.getElementById('emailSection').classList.add('active');
    
    // Update progress
    updateProgress(1);
    
    // Store form data in session storage
    sessionStorage.setItem('registrationFormData', JSON.stringify(formData));
}

function backToPersonalDetails() {
    // Hide all sections
    document.getElementById('idUploadSection').style.display = 'none';
    document.getElementById('summarySection').style.display = 'none';
    document.getElementById('emailSection').style.display = 'none';
    document.getElementById('verificationSection').style.display = 'none';
    
    // Show personal details section
    document.getElementById('personalDetailsSection').style.display = 'block';
    
    // Update progress
    updateProgress(2);
}

function backToIdUpload() {
    // Hide all sections
    document.getElementById('summarySection').style.display = 'none';
    document.getElementById('personalDetailsSection').style.display = 'none';
    document.getElementById('emailSection').style.display = 'none';
    document.getElementById('verificationSection').style.display = 'none';
    
    // Show ID upload section
    document.getElementById('idUploadSection').style.display = 'block';
    
    // Update progress to step 3
    updateProgress(3);
}

function editEmail() {
    // Store only personal details
    const formData = {
        firstName: document.querySelector('input[name="first_name"]').value,
        middleName: document.querySelector('input[name="middle_name"]').value,
        surname: document.querySelector('input[name="surname"]').value,
        suffix: document.querySelector('select[name="suffix"]').value,
        phone: document.getElementById('phoneNumber').value
    };
    
    // Clear verification inputs and sensitive data
    clearVerificationInputs();
    clearSensitiveData();
    
    // Clear ID upload data
    document.querySelector('select[name="id_type"]').value = '';
    document.getElementById('idPicture').value = '';
    const previewListEl2 = document.getElementById('idPreviewList');
    if (previewListEl2) previewListEl2.innerHTML = '';
    document.getElementById('idPreviewContainer').style.display = 'none';
    
    // Hide all sections
    document.getElementById('summarySection').style.display = 'none';
    document.getElementById('personalDetailsSection').style.display = 'none';
    document.getElementById('idUploadSection').style.display = 'none';
    document.getElementById('verificationSection').style.display = 'none';
    
    // Show email section
    document.getElementById('emailSection').style.display = 'block';
    
    // Update progress
    updateProgress(1);
    
    // Store form data in session storage
    sessionStorage.setItem('registrationFormData', JSON.stringify(formData));
    
    // Add event listener for successful verification
    document.getElementById('verificationForm').addEventListener('submit', function(e) {
        const storedData = JSON.parse(sessionStorage.getItem('registrationFormData'));
        if (storedData) {
            // Restore only personal details after verification
            document.querySelector('input[name="first_name"]').value = storedData.firstName;
            document.querySelector('input[name="middle_name"]').value = storedData.middleName;
            document.querySelector('input[name="surname"]').value = storedData.surname;
            document.querySelector('select[name="suffix"]').value = storedData.suffix;
            document.getElementById('phoneNumber').value = storedData.phone;
        }
    });
}

function editPersonalDetails() {
    // Clear verification inputs but preserve form data
    clearVerificationInputs();
    
    // Hide all sections
    document.getElementById('summarySection').style.display = 'none';
    document.getElementById('idUploadSection').style.display = 'none';
    document.getElementById('emailSection').style.display = 'none';
    document.getElementById('verificationSection').style.display = 'none';
    
    // Show personal details section
    document.getElementById('personalDetailsSection').style.display = 'block';
    
    // Update progress
    updateProgress(2);
}

function editIdUpload() {
    // Clear verification inputs but preserve form data
    clearVerificationInputs();
    
    // Hide all sections
    document.getElementById('summarySection').style.display = 'none';
    document.getElementById('personalDetailsSection').style.display = 'none';
    document.getElementById('emailSection').style.display = 'none';
    document.getElementById('verificationSection').style.display = 'none';
    
    // Show ID upload section
    document.getElementById('idUploadSection').style.display = 'block';
    
    // Update progress to step 3
    updateProgress(3);
}

document.addEventListener('DOMContentLoaded', function() {
    // Initialize section visibility
    document.getElementById('emailSection').style.display = 'block';
    document.getElementById('verificationSection').style.display = 'none';
    document.getElementById('personalDetailsSection').style.display = 'none';
    document.getElementById('idUploadSection').style.display = 'none';
    document.getElementById('summarySection').style.display = 'none';
    
    // Initialize progress bar
    updateProgress(1);
    
    const emailForm = document.getElementById('emailForm');
    const verificationSection = document.getElementById('verificationSection');
    const personalDetailsSection = document.getElementById('personalDetailsSection');
    const idUploadSection = document.getElementById('idUploadSection');
    const verificationInputs = document.querySelectorAll('.verification-code input');
    const resendButton = document.getElementById('resendButton');
    const timerDisplay = document.getElementById('resendTimer');
    let resendTimer = 60;

    // Phone number validation
    const phoneInput = document.getElementById('phoneNumber');
    phoneInput.addEventListener('input', function(e) {
        let value = e.target.value;
        
        // Ensure it starts with +639
        if (!value.startsWith('+639')) {
            value = '+639';
        }
        
        // Limit to +639 followed by 9 digits
        if (value.length > 13) {
            value = value.slice(0, 13);
        }
        
        // Only allow digits after +639
        value = '+639' + value.substring(4).replace(/\D/g, '');
        
        e.target.value = value;
    });

    // Registration form submission
    const registrationForm = document.getElementById('registrationForm');
    // Auto-open Terms & Conditions modal on registration page load
    (function showTermsOnLoad(){
        try {
            var existing = document.getElementById('registrationTermsModal');
            if (!existing) {
                var modalHtml = `
<div class="modal fade" id="registrationTermsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background-color:#6D4C41;color:#fff;">
        <h5 class="modal-title"><i class="fas fa-file-contract me-2"></i>Terms and Conditions & Privacy Policy</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="max-height:50vh; overflow-y:auto; padding:25px;">
        <div class="terms-content">
          <h6 class="text-primary mb-3"><i class="fas fa-hotel me-2"></i>FAWNA Hotel - Terms of Service & Privacy Policy</h6>
          
          <div class="mb-3">
            <h6 class="fw-bold text-dark">1. ACCEPTANCE OF TERMS</h6>
            <p class="text-muted small">By creating an account with FAWNA Hotel, you acknowledge that you have read, understood, and agree to be bound by these Terms of Service and our Privacy Policy. These terms constitute a legally binding agreement between you and FAWNA Hotel.</p>
          </div>

          <div class="mb-3">
            <h6 class="fw-bold text-dark">2. ACCOUNT REGISTRATION & VERIFICATION</h6>
            <p class="text-muted small">To create an account, you must provide accurate, complete, and current information. You must upload a valid government-issued ID for identity verification purposes. By submitting your ID, you confirm that:</p>
            <ul class="text-muted small">
              <li>The ID is genuine and belongs to you</li>
              <li>All information provided is accurate and current</li>
              <li>You consent to our verification process</li>
              <li>You understand that false information may result in account termination</li>
            </ul>
          </div>

          <div class="mb-3">
            <h6 class="fw-bold text-dark">3. PRIVACY & DATA PROTECTION</h6>
            <p class="text-muted small">We are committed to protecting your privacy and personal information. Your data will be:</p>
            <ul class="text-muted small">
              <li>Used solely for identity verification and service provision</li>
              <li>Stored securely using industry-standard encryption</li>
              <li>Never shared with third parties without your explicit consent</li>
              <li>Retained only as long as necessary for legitimate business purposes</li>
              <li>Processed in accordance with applicable data protection laws</li>
            </ul>
          </div>

          <div class="mb-3">
            <h6 class="fw-bold text-dark">4. BOOKING & PAYMENT TERMS</h6>
            <p class="text-muted small">All bookings are subject to availability and our cancellation policy. Payment must be made in full at the time of booking unless otherwise specified. We reserve the right to refuse service to anyone.</p>
          </div>

          <div class="mb-3">
            <h6 class="fw-bold text-dark">5. USER RESPONSIBILITIES</h6>
            <p class="text-muted small">You agree to:</p>
            <ul class="text-muted small">
              <li>Use the service only for lawful purposes</li>
              <li>Maintain the confidentiality of your account credentials</li>
              <li>Notify us immediately of any unauthorized account use</li>
              <li>Comply with all hotel policies and local laws</li>
              <li>Respect other guests and hotel property</li>
            </ul>
          </div>

          <div class="mb-3">
            <h6 class="fw-bold text-dark">6. LIMITATION OF LIABILITY</h6>
            <p class="text-muted small">FAWNA Hotel shall not be liable for any indirect, incidental, special, or consequential damages arising from your use of our services, including but not limited to loss of profits, data, or business opportunities.</p>
          </div>

          <div class="mb-3">
            <h6 class="fw-bold text-dark">7. MODIFICATIONS</h6>
            <p class="text-muted small">We reserve the right to modify these terms at any time. Continued use of our services after changes constitutes acceptance of the new terms. We will notify users of significant changes via email or website notification.</p>
          </div>

          <div class="mb-3">
            <h6 class="fw-bold text-dark">8. CONTACT INFORMATION</h6>
            <p class="text-muted small">For questions about these terms or our privacy practices, contact us at:</p>
            <ul class="text-muted small">
              <li>Email: fawnahotel@gmail.com</li>
              <li>Phone: +63 993 267 0873</li>
              <li>Address: Santa Cruz, Laguna, Philippines</li>
            </ul>
          </div>

          <div class="alert alert-info small">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Important:</strong> By proceeding with registration, you confirm that you have read, understood, and agree to all terms and conditions outlined above. This agreement is effective immediately upon account creation.
          </div>
        </div>
        
        <div class="form-check mt-4">
          <input class="form-check-input" type="checkbox" id="registrationTermsCheckbox" required>
          <label class="form-check-label fw-bold" for="registrationTermsCheckbox">
            I have read, understood, and agree to the Terms of Service and Privacy Policy
          </label>
        </div>
      </div>
      <div class="modal-footer justify-content-center border-0">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel Registration</button>
        <button type="button" class="btn btn-primary" id="registrationAcceptTerms" style="background:#6D4C41;border:none;" disabled>I Agree & Continue</button>
      </div>
    </div>
  </div>
</div>`;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            var modalEl = document.getElementById('registrationTermsModal');
            if (modalEl && typeof bootstrap !== 'undefined') {
                var m = new bootstrap.Modal(modalEl, {backdrop:'static', keyboard:false});
                m.show();
                var regChk = document.getElementById('registrationTermsCheckbox');
                var regBtn = document.getElementById('registrationAcceptTerms');
                if (regChk && regBtn) {
                    regChk.addEventListener('change', function(){ regBtn.disabled = !this.checked; });
                    regBtn.addEventListener('click', function(){ m.hide(); });
                }
            }
        } catch (e) { console.error('Terms modal error:', e); }
    })();
    registrationForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Clear all previous errors
        clearErrors();
        
        // Remove any existing alert messages
        const existingAlerts = document.querySelectorAll('.alert-error');
        existingAlerts.forEach(alert => alert.remove());
        
        const firstName = document.querySelector('input[name="first_name"]').value.trim();
        const middleName = document.querySelector('input[name="middle_name"]').value.trim();
        const surname = document.querySelector('input[name="surname"]').value.trim();
        
        // Check if all name fields are filled
        if (!firstName) {
            document.getElementById('first-name-error').textContent = 'First name is required.';
            document.getElementById('first-name-error').style.display = 'block';
            document.querySelector('input[name="first_name"]').classList.add('is-invalid');
            return;
        }
        
        if (!surname) {
            document.getElementById('surname-error').textContent = 'Surname is required.';
            document.getElementById('surname-error').style.display = 'block';
            document.querySelector('input[name="surname"]').classList.add('is-invalid');
            return;
        }
        
        // Check phone number format
        const phone = phoneInput.value;
        if (!phone.match(/^\+639\d{9}$/)) {
            document.getElementById('phone-error').textContent = 'Phone number must be in the format +639XXXXXXXXX (Philippine format).';
            document.getElementById('phone-error').style.display = 'block';
            document.getElementById('phoneNumber').classList.add('is-invalid');
            return;
        }
        
        // Submit form via AJAX
        const formData = new FormData(this);
        
        fetch(this.action, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Registration successful, redirect to login
                window.location.href = data.redirect;
            } else {
                console.log("Error response:", data);
                
                // Show specific error based on error type
                if (data.error_type === 'name_exists') {
                    // Create a single error message at the top of the form
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'alert-error';
                    errorDiv.textContent = 'This name is already registered. Please use a different name.';
                    registrationForm.prepend(errorDiv);
                    
                    // Also highlight the fields
                    document.querySelector('input[name="first_name"]').classList.add('is-invalid');
                    document.querySelector('input[name="surname"]').classList.add('is-invalid');
                } else if (data.error_type === 'phone_exists') {
                    // Create a single error message for phone
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'alert-error';
                    errorDiv.textContent = 'This phone number is already registered. Please use a different phone number.';
                    registrationForm.prepend(errorDiv);
                    
                    // Highlight the phone field
                    document.getElementById('phoneNumber').classList.add('is-invalid');
                } else if (data.error_type === 'validation') {
                    // Create a single error message for validation errors
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'alert-error';
                    errorDiv.textContent = data.message;
                    registrationForm.prepend(errorDiv);
                    
                    // Highlight relevant fields
                    if (data.message.includes('password')) {
                        document.querySelector('input[name="password"]').classList.add('is-invalid');
                        document.querySelector('input[name="confirm_password"]').classList.add('is-invalid');
                    } else if (data.message.includes('phone')) {
                        document.getElementById('phoneNumber').classList.add('is-invalid');
                    } else {
                        document.querySelector('input[name="first_name"]').classList.add('is-invalid');
                    }
                }
                
                // Keep the registration form visible
                document.getElementById('emailSection').classList.remove('active');
                verificationSection.classList.remove('active');
                personalDetailsSection.classList.add('active');
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert('An error occurred. Please try again.');
        });
    });

    // Email form submission
    emailForm.addEventListener('submit', function(e) {
        e.preventDefault();
        clearErrors();
        
        const email = document.getElementById('email').value;
        
        // Validate email format
        const emailPattern = /^[a-z0-9._%+-]{3,}@(gmail\.com|yahoo\.com|outlook\.com|hotmail\.com)$/;
        if (!emailPattern.test(email)) {
            document.getElementById('email-error').textContent = 'Please enter a valid email address with the correct format.';
            document.getElementById('email-error').style.display = 'block';
            document.getElementById('email').classList.add('is-invalid');
            return;
        }

        // Show loading spinner and disable button
        const emailLoadingSpinner = document.getElementById('emailLoadingSpinner');
        emailLoadingSpinner.style.display = 'block';
        const emailSubmitBtn = document.getElementById('emailSubmitBtn');
        emailSubmitBtn.disabled = true;
        emailSubmitBtn.textContent = 'Sending...';

        // Send verification email
        fetch(this.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf_token]').value
            },
            body: JSON.stringify({ email: email })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Hide all sections first
                document.getElementById('emailSection').style.display = 'none';
                document.getElementById('personalDetailsSection').style.display = 'none';
                document.getElementById('idUploadSection').style.display = 'none';
                document.getElementById('summarySection').style.display = 'none';
                
                // Show verification section
                document.getElementById('verificationSection').style.display = 'block';
                document.getElementById('verificationEmail').value = email;
                document.getElementById('verifiedEmail').value = email;
                document.getElementById('verifiedEmailFinal').value = email;
                startResendTimer();
            } else {
                document.getElementById('email-error').textContent = data.message;
                document.getElementById('email-error').style.display = 'block';
                document.getElementById('email').classList.add('is-invalid');
            }
        })
        .catch(error => {
            console.error("Error:", error);
            document.getElementById('email-error').textContent = 'An error occurred. Please try again.';
            document.getElementById('email-error').style.display = 'block';
            document.getElementById('email').classList.add('is-invalid');
        })
        .finally(() => {
            // Hide loading spinner and enable button
            emailLoadingSpinner.style.display = 'none';
            emailSubmitBtn.disabled = false;
            emailSubmitBtn.textContent = 'Send Verification Code';
        });
    });

    // Verification code input handling
    verificationInputs.forEach((input, index) => {
        input.addEventListener('input', function(e) {
            if (e.inputType !== 'deleteContentBackward') {
                if (index < verificationInputs.length - 1) {
                    verificationInputs[index + 1].focus();
                }
            }
        });

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && !this.value && index > 0) {
                verificationInputs[index - 1].focus();
            }
        });
    });

    // Verification form submission
    document.getElementById('verificationForm').addEventListener('submit', function(e) {
        e.preventDefault();
        clearErrors();
        
        const code = Array.from(verificationInputs).map(input => input.value).join('');
        document.getElementById('verificationCodeInput').value = code;

        fetch(this.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf_token]').value
            },
            body: JSON.stringify({
                email: document.getElementById('verificationEmail').value,
                code: code
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Hide all sections first
                document.getElementById('verificationSection').style.display = 'none';
                document.getElementById('emailSection').style.display = 'none';
                document.getElementById('idUploadSection').style.display = 'none';
                document.getElementById('summarySection').style.display = 'none';
                
                // Show personal details section
                document.getElementById('personalDetailsSection').style.display = 'block';
                document.getElementById('verifiedEmail').value = document.getElementById('verificationEmail').value;
                document.getElementById('verifiedEmailFinal').value = document.getElementById('verificationEmail').value;
                updateProgress(2);
                
                // Check if we have stored registration data from a previous attempt
                if (data.registration_data) {
                    // Fill in the form with the stored data
                    document.querySelector('input[name="first_name"]').value = data.registration_data.first_name || '';
                    document.querySelector('input[name="middle_name"]').value = data.registration_data.middle_name || '';
                    document.querySelector('input[name="surname"]').value = data.registration_data.surname || '';
                    document.querySelector('select[name="suffix"]').value = data.registration_data.suffix || '';
                    document.querySelector('input[name="phone"]').value = data.registration_data.phone || '+639';
                }
            } else {
                document.getElementById('verification-error').textContent = data.message;
                document.getElementById('verification-error').style.display = 'block';
                // Add red border to verification inputs
                verificationInputs.forEach(input => {
                    input.style.borderColor = '#dc3545';
                });
            }
        })
        .catch(error => {
            console.error("Error:", error);
            document.getElementById('verification-error').textContent = 'An error occurred. Please try again.';
            document.getElementById('verification-error').style.display = 'block';
        });
    });

    // Update the personal details form submission
    document.getElementById('personalDetailsForm').addEventListener('submit', function(e) {
        e.preventDefault();
        clearErrors();

        // Get form values
        const firstName = document.querySelector('input[name="first_name"]').value.trim();
        const surname = document.querySelector('input[name="surname"]').value.trim();
        const phone = document.getElementById('phoneNumber').value;
        const password = document.querySelector('input[name="password"]').value;
        const confirmPassword = document.querySelector('input[name="confirm_password"]').value;

        // Name validation - check for numbers and special characters
        const nameRegex = /^[A-Za-z\s]+$/;
        
        if (!firstName) {
            showError('input[name="first_name"]', 'First name is required.');
            return;
        }
        if (!nameRegex.test(firstName)) {
            showError('input[name="first_name"]', 'First name should only contain letters and spaces.');
            return;
        }
        
        if (!surname) {
            showError('input[name="surname"]', 'Surname is required.');
            return;
        }
        if (!nameRegex.test(surname)) {
            showError('input[name="surname"]', 'Surname should only contain letters and spaces.');
            return;
        }

        // Password validation
        if (!password) {
            showError('input[name="password"]', 'Password is required.');
            return;
        }
        // Enforce strong password: 8+ chars, 1 upper, 1 lower, 1 digit, 1 special
        const strongPwd = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,}$/;
        if (!strongPwd.test(password)) {
            const pwdInput = document.querySelector('input[name="password"]');
            const pwdErr = document.getElementById('password-error');
            if (pwdInput) pwdInput.classList.add('is-invalid');
            if (pwdErr) {
                pwdErr.textContent = 'Password must be at least 8 characters and include uppercase, lowercase, number, and special character.';
                pwdErr.classList.add('show');
                pwdErr.style.display = 'block';
            }
            return;
        }

        if (!confirmPassword) {
            showError('input[name="confirm_password"]', 'Please confirm your password.');
            return;
        }

        // Check if passwords match
        if (password !== confirmPassword) {
            const confirmPasswordInput = document.querySelector('input[name="confirm_password"]');
            const confirmPasswordError = document.getElementById('confirm-password-error');
            
            confirmPasswordInput.classList.add('is-invalid');
            confirmPasswordError.textContent = 'Passwords do not match.';
            confirmPasswordError.style.display = 'block';
            confirmPasswordError.classList.add('show');
            return;
        }

        // Rest of the validation
        if (!phone.match(/^\+639\d{9}$/)) {
            showError('#phoneNumber', 'Phone number must be in the format +639XXXXXXXXX (Philippine format).');
            return;
        }

        // Store values in hidden fields
        document.getElementById('finalFirstName').value = firstName;
        document.getElementById('finalMiddleName').value = document.querySelector('input[name="middle_name"]').value;
        document.getElementById('finalSurname').value = surname;
        document.getElementById('finalSuffix').value = document.querySelector('select[name="suffix"]').value;
        document.getElementById('finalPhone').value = phone;
        document.getElementById('finalPassword').value = password;
        document.getElementById('finalConfirmPassword').value = confirmPassword;
        document.getElementById('verifiedEmailFinal').value = document.getElementById('verifiedEmail').value;

        // Hide all sections
        document.getElementById('personalDetailsSection').style.display = 'none';
        document.getElementById('emailSection').style.display = 'none';
        document.getElementById('verificationSection').style.display = 'none';
        document.getElementById('summarySection').style.display = 'none';

        // Show ID upload section
        document.getElementById('idUploadSection').style.display = 'block';
        updateProgress(3);
    });

    // Function to show summary
    function showSummary() {
        const firstName = document.getElementById('finalFirstName').value;
        const middleName = document.getElementById('finalMiddleName').value;
        const surname = document.getElementById('finalSurname').value;
        const suffix = document.getElementById('finalSuffix').value;
        const email = document.getElementById('verifiedEmailFinal').value;
        const phone = document.getElementById('finalPhone').value;
        const idTypeSelect = document.querySelector('select[name="id_type"]');
        const idType = idTypeSelect.options[idTypeSelect.selectedIndex].text;

        // Construct full name
        let fullName = [firstName];
        if (middleName) fullName.push(middleName);
        fullName.push(surname);
        if (suffix) fullName.push(suffix);

        // Update summary content
        document.getElementById('summaryName').textContent = fullName.join(' ');
        document.getElementById('summaryEmail').textContent = email;
        document.getElementById('summaryPhone').textContent = phone;
        document.getElementById('summaryIdType').textContent = idType;
    }

    // Add this function for ID type validation
    function validateIdType(selectElement) {
        const errorElement = document.getElementById('id-type-error');
        if (!selectElement.value) {
            selectElement.classList.add('is-invalid');
            errorElement.style.display = 'block';
            
            // Hide the error message after 3 seconds
            setTimeout(() => {
                selectElement.classList.remove('is-invalid');
                errorElement.style.display = 'none';
            }, 3000); // 3000 milliseconds = 3 seconds
            
            return false;
        } else {
            selectElement.classList.remove('is-invalid');
            errorElement.style.display = 'none';
            return true;
        }
    }

    // Update the continue to summary button click handler
    document.getElementById('continueToSummary').addEventListener('click', function(e) {
        e.preventDefault();
        // Ensure terms have been accepted
        var accepted = document.getElementById('registrationTermsCheckbox');
        if (accepted && !accepted.checked) {
            var modalEl = document.getElementById('registrationTermsModal');
            if (modalEl && typeof bootstrap !== 'undefined') {
                var m = new bootstrap.Modal(modalEl, {backdrop:'static', keyboard:false});
                m.show();
            }
            return;
        }
        
        // Validate ID type
        const idTypeSelect = document.querySelector('select[name="id_type"]');
        const isIdTypeValid = validateIdType(idTypeSelect);
        
        // Validate ID upload fields
        const idPicture = document.querySelector('input[name="id_picture"]').files[0];
        
        if (!isIdTypeValid) {
            idTypeSelect.focus();
            return;
        }
        
        if (!idPicture) {
            showError('#id-picture-error', 'Please upload an ID picture');
            return;
        }
        
        // Hide all sections first
        document.getElementById('idUploadSection').style.display = 'none';
        document.getElementById('personalDetailsSection').classList.remove('active');
        document.getElementById('emailSection').classList.remove('active');
        document.getElementById('verificationSection').classList.remove('active');
        
        // Show summary section
        document.getElementById('summarySection').style.display = 'block';
        
        // Update progress to step 4
        updateProgress(4);
        
        // Update summary content
        showSummary();
    });

    // Add event listener for complete registration button
    document.getElementById('completeRegistrationBtn').addEventListener('click', async function(e) {
        e.preventDefault();
        // Ensure terms have been accepted
        var accepted = document.getElementById('registrationTermsCheckbox');
        if (accepted && !accepted.checked) {
            var modalEl = document.getElementById('registrationTermsModal');
            if (modalEl && typeof bootstrap !== 'undefined') {
                var m = new bootstrap.Modal(modalEl, {backdrop:'static', keyboard:false});
                m.show();
            }
            return;
        }
        await submitRegistration();
    });

    // Update the registration submission
    async function submitRegistration() {
        try {
            // Build form data manually to include up to 2 ID images
            const formElement = document.getElementById('registrationForm');
            const formData = new FormData();
            // Copy existing fields
            Array.from(formElement.elements).forEach(el => {
                if (!el.name) return;
                if (el.type === 'file') return; // skip file input; we append from selectedIdFiles
                formData.append(el.name, el.value);
            });
            // Append up to 2 images as id_picture[0], id_picture[1]
            selectedIdFiles.slice(0, 2).forEach((item, idx) => {
                formData.append('id_picture', item.file, item.file.name);
            });
            
            // Show loading state
            const submitButton = document.getElementById('completeRegistrationBtn');
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...';

            // Add any missing data
            formData.append('csrf_token', document.querySelector('[name=csrf_token]').value);
            formData.append('verified_email', document.getElementById('verifiedEmailFinal').value);
            formData.append('first_name', document.getElementById('finalFirstName').value);
            formData.append('middle_name', document.getElementById('finalMiddleName').value);
            formData.append('surname', document.getElementById('finalSurname').value);
            formData.append('suffix', document.getElementById('finalSuffix').value);
            formData.append('phone', document.getElementById('finalPhone').value);
            formData.append('password', document.getElementById('finalPassword').value);

            console.log('Submitting registration...'); // Debug log

            const response = await fetch('/complete-registration', {
                method: 'POST',
                body: formData
            });

            console.log('Response received:', response); // Debug log

            const result = await response.json();
            console.log('Result:', result); // Debug log

            if (result.success) {
                // Clear the header and progress bar
                document.querySelector('.auth-header').style.display = 'none';
                document.querySelector('.progress-container').style.display = 'none';

                // Clear the summary section
                const summarySection = document.getElementById('summarySection');
                summarySection.innerHTML = '';

                // Create and append the success message
                const successDiv = document.createElement('div');
                successDiv.className = 'success-message';
                successDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <p style="font-size: 28px; margin-bottom: 25px; font-weight: bold; color: #28a745;">Registration Successful!</p>
                        <p style="font-size: 16px; margin-bottom: 15px;">Thank you for registering. Your account is now pending approval.</p>
                        <p style="font-size: 16px; margin-bottom: 15px;">Please check your email <strong>${document.getElementById('verifiedEmailFinal').value}</strong> for the approval status.</p>
                        <p style="font-size: 16px; margin-bottom: 15px;">Once approved, you will receive an email notification and can proceed to login.</p>
                        <div style="margin-top: 30px;">
                            <a href="/user-login" class="register-button" style="text-decoration: none; display: inline-block; background-color: #8b5e3b; color: white; padding: 12px 24px; border-radius: 5px;">Return to Login Page</a>
                        </div>
                    </div>
                `;
                summarySection.appendChild(successDiv);

                // Hide any previous error messages
                const errorMessages = document.querySelectorAll('.alert-error');
                errorMessages.forEach(msg => msg.remove());
            } else {
                // If server returned a password validation error, show it inline
                if (result.field === 'password') {
                    const pwdInput = document.querySelector('input[name="password"]');
                    const pwdErr = document.getElementById('password-error');
                    if (pwdInput) pwdInput.classList.add('is-invalid');
                    if (pwdErr) {
                        pwdErr.textContent = result.message || 'Invalid password format.';
                        pwdErr.classList.add('show');
                        pwdErr.style.display = 'block';
                    }
                }
                // Show error message
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert-error';
                errorDiv.style.marginBottom = '20px';
                errorDiv.textContent = result.message || 'An error occurred during registration. Please try again.';
                document.getElementById('summarySection').prepend(errorDiv);
                
                // Re-enable the submit button
                submitButton.disabled = false;
                submitButton.textContent = 'Complete Registration';
            }
        } catch (error) {
            console.error('Registration error:', error);
            
            // Show error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert-error';
            errorDiv.style.marginBottom = '20px';
            errorDiv.textContent = 'An error occurred during registration. Please try again.';
            document.getElementById('summarySection').prepend(errorDiv);
            
            // Re-enable the submit button
            const submitButton = document.getElementById('completeRegistrationBtn');
            submitButton.disabled = false;
            submitButton.textContent = 'Complete Registration';
        }
    }

    // Resend timer functionality
    function startResendTimer() {
        resendTimer = 60;
        resendButton.disabled = true;
        
        const timerInterval = setInterval(() => {
            resendTimer--;
            timerDisplay.textContent = `Resend code in ${resendTimer} seconds`;
            
            if (resendTimer <= 0) {
                clearInterval(timerInterval);
                resendButton.disabled = false;
                timerDisplay.textContent = '';
            }
        }, 1000);
    }

    // Resend button click handler
    resendButton.addEventListener('click', function() {
        const email = document.getElementById('verificationEmail').value;
        
        fetch(emailForm.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrf_token]').value
            },
            body: JSON.stringify({ email: email })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                startResendTimer();
                alert('Verification code has been resent.');
            } else {
                document.getElementById('verification-error').textContent = data.message;
                document.getElementById('verification-error').style.display = 'block';
            }
        })
        .catch(error => {
            console.error("Error:", error);
            document.getElementById('verification-error').textContent = 'An error occurred. Please try again.';
            document.getElementById('verification-error').style.display = 'block';
        });
    });

    // JavaScript to toggle password visibility
    document.getElementById('toggleRegisterPassword').addEventListener('click', function () {
        const passwordField = document.getElementById('registerPassword');
        const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordField.setAttribute('type', type);
        this.classList.toggle('fa-eye-slash');
    });

    document.getElementById('toggleConfirmRegisterPassword').addEventListener('click', function () {
        const confirmPasswordField = document.getElementById('confirmRegisterPassword');
        const type = confirmPasswordField.getAttribute('type') === 'password' ? 'text' : 'password';
        confirmPasswordField.setAttribute('type', type);
        this.classList.toggle('fa-eye-slash');
    });

    // Real-time password strength validation
    const pwdInputRealtime = document.getElementById('registerPassword');
    const pwdErrRealtime = document.getElementById('password-error');
    if (pwdInputRealtime && pwdErrRealtime) {
        const strongPwdRe = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]).{8,}$/;
        pwdInputRealtime.addEventListener('input', function() {
            const ok = strongPwdRe.test(pwdInputRealtime.value || '');
            if (!ok) {
                pwdInputRealtime.classList.add('is-invalid');
                pwdErrRealtime.textContent = 'Must include uppercase, lowercase, number, special, min 8 chars.';
                pwdErrRealtime.classList.add('show');
                pwdErrRealtime.style.display = 'block';
            } else {
                pwdInputRealtime.classList.remove('is-invalid');
                pwdErrRealtime.textContent = '';
                pwdErrRealtime.classList.remove('show');
                pwdErrRealtime.style.display = 'none';
            }
        });
    }

    // Add ID picture preview functionality
    // Client-side selected files store (max 2)
    const selectedIdFiles = [];
    const idInput = document.getElementById('idPicture');
    const previewContainer = document.getElementById('idPreviewContainer');
    const previewList = document.getElementById('idPreviewList');

    function renderIdPreviews() {
        previewList.innerHTML = '';
        selectedIdFiles.forEach((item, index) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'preview-wrapper';
            wrapper.style.position = 'relative';
            wrapper.style.cursor = 'pointer';

            const img = document.createElement('img');
            img.src = item.dataUrl;
            img.alt = 'ID Preview';
            img.style.width = '150px';
            img.style.height = '100px';
            img.style.objectFit = 'cover';
            img.style.borderRadius = '8px';
            img.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
            img.style.border = '2px solid #ddd';

            img.addEventListener('click', function() {
                const modal = document.getElementById('idPreviewModal');
                const modalImage = document.getElementById('modalImage');
                modalImage.src = item.dataUrl;
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            });

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-preview';
            removeBtn.textContent = '×';
            removeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                selectedIdFiles.splice(index, 1);
                // Keep the real file input empty; we will build FormData manually
                idInput.value = '';
                renderIdPreviews();
            });

            const caption = document.createElement('div');
            caption.className = 'click-to-enlarge';
            caption.textContent = 'Click to enlarge';

            wrapper.appendChild(img);
            wrapper.appendChild(removeBtn);
            wrapper.appendChild(caption);
            previewList.appendChild(wrapper);
        });

        previewContainer.style.display = selectedIdFiles.length ? 'block' : 'none';
    }

    idInput.addEventListener('change', function(e) {
        const files = Array.from(e.target.files || []);
        if (!files.length) return;

        for (const file of files) {
            if (selectedIdFiles.length >= 2) break;
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file');
                continue;
            }
            if (file.size > 5 * 1024 * 1024) {
                alert('File size should not exceed 5MB');
                continue;
            }
            const reader = new FileReader();
            reader.onload = function(ev) {
                selectedIdFiles.push({ file, dataUrl: ev.target.result });
                // Populate consent modal with the last added image
                const consentPreview = document.getElementById('consentPreview');
                if (consentPreview) {
                    consentPreview.src = ev.target.result;
                }
                renderIdPreviews();
                openConsentModal();
            };
            reader.readAsDataURL(file);
        }

        // Clear the input so re-selecting the same file triggers change
        idInput.value = '';
    });

    // Function to open modal with a specific image src
    window.openModal = function(src) {
        const modal = document.getElementById('idPreviewModal');
        const modalImage = document.getElementById('modalImage');
        const fallbackSrc = (typeof selectedIdFiles !== 'undefined' && selectedIdFiles.length) ? selectedIdFiles[0].dataUrl : '';
        modalImage.src = src || fallbackSrc;
        if (!modalImage.src) return; // nothing to show
        modal.style.display = 'block';
        
        // Prevent body scrolling when modal is open
        document.body.style.overflow = 'hidden';
    }

    // Function to close modal
    window.closeModal = function() {
        const modal = document.getElementById('idPreviewModal');
        modal.style.display = 'none';
        
        // Restore body scrolling
        document.body.style.overflow = 'auto';
    }

    // Close modal when clicking outside the image
    document.getElementById('idPreviewModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // Consent modal controls
    function openConsentModal() {
        const modal = document.getElementById('idConsentModal');
        const checkbox = document.getElementById('consentCheckbox');
        const proceed = document.getElementById('consentProceed');
        if (checkbox) {
            checkbox.checked = false;
        }
        if (proceed) {
            proceed.disabled = true;
        }
        if (modal) {
            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
    }
    function closeConsentModal() {
        const modal = document.getElementById('idConsentModal');
        if (modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }
    const consentModal = document.getElementById('idConsentModal');
    if (consentModal) {
        consentModal.addEventListener('click', function(e) {
            if (e.target === this) {
                // Treat outside click as cancel
                document.getElementById('consentCancel')?.click();
            }
        });
    }
    const consentCheckbox = document.getElementById('consentCheckbox');
    const consentProceed = document.getElementById('consentProceed');
    const consentCancel = document.getElementById('consentCancel');
    if (consentCheckbox && consentProceed) {
        consentCheckbox.addEventListener('change', function() {
            consentProceed.disabled = !this.checked;
        });
    }
    if (consentProceed) {
        consentProceed.addEventListener('click', function() {
            closeConsentModal();
        });
    }
    if (consentCancel) {
        consentCancel.addEventListener('click', function() {
            // Revert last selection if user cancels consent
            selectedIdFiles.pop();
            renderIdPreviews();
            closeConsentModal();
        });
    }
    // Deprecated single-preview remover removed; thumbnails have per-item remove buttons
});
</script>
{% endblock %}
