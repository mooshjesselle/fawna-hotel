{% extends "base.html" %}

{% block title %}Login{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
<style>
    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
        padding: 12px;
        margin-bottom: 15px;
        border-radius: 4px;
        animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .alert-success i {
        margin-right: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <h2>{{ 'Admin Login' if user_type == 'admin' else 'User Login' }}</h2>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                {% if user_type == 'user' and category == 'success' %}
                    <div class="alert alert-{{ category }}">
                        <i class="fas fa-check-circle"></i>
                        {{ message }}
                    </div>
                {% elif category != 'success' %}
                    <div class="alert alert-{{ category }} {% if category == 'danger' %}error-shake{% endif %}">
                        {% if category == 'danger' %}
                            <i class="fas fa-exclamation-circle"></i>
                        {% elif category == 'warning' %}
                            <i class="fas fa-exclamation-triangle"></i>
                        {% elif category == 'info' %}
                            <i class="fas fa-info-circle"></i>
                        {% endif %}
                        {{ message }}
                    </div>
                {% endif %}
            {% endfor %}
        {% endif %}
        {% endwith %}

        <form method="POST">
            {{ form.csrf_token }}
            
            <div class="form-group">
                <label class="form-label">Email</label>
                {{ form.email(class="form-control", placeholder="Enter your email address") }}
                {% if form.email.errors %}
                    {% for error in form.email.errors %}
                        <span class="text-danger">{{ error }}</span>
                    {% endfor %}
                {% endif %}
            </div>
            
  <div class="form-group">
    <label class="form-label">Password</label>
    <div class="input-group">
        {{ form.password(class="form-control", placeholder="Enter your password", id="password") }}
        <div class="input-group-append">
            <span class="input-group-text bg-white border-left-0" style="height:51px;">
                <i class="fa fa-eye" id="togglePassword" style="cursor: pointer;"></i>
            </span>
        </div>
    </div>
    {% if form.password.errors %}
        {% for error in form.password.errors %}
            <span class="text-danger">{{ error }}</span>
        {% endfor %}
    {% endif %}
</div>

<script>
    // JavaScript to toggle password visibility
    document.getElementById('togglePassword').addEventListener('click', function () {
        const passwordField = document.getElementById('password');
        const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordField.setAttribute('type', type);
        this.classList.toggle('fa-eye-slash');
    });
</script>

            <div class="remember-forgot-container">
                <label class="form-check">
                    {{ form.remember(class="form-check-input") }}
                    <span class="form-check-label">Remember me</span>
                </label>
                {% if user_type != 'admin' %}
                <a href="{{ url_for('forgot_password') }}" class="forgot-password">Forgot Password?</a>
                {% endif %}
            </div>
            
            <button type="submit" class="login-button">Login</button>
        </form>
        
        {% if user_type != 'admin' %}
        <div class="text-center mt-3">
            Don't have an account? <a class="register-here" id="openTermsModal" href="{{ url_for('register') }}">Register here</a>
        </div>
        {% endif %}

        <!-- Terms & Conditions Modal (shown before registration) -->
        <div class="modal fade" id="termsModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header" style="background-color:#6D4C41;color:#fff;">
                        <h5 class="modal-title"><i class="fas fa-file-contract me-2"></i>Terms and Conditions</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body" style="max-height:60vh; overflow:auto;">
                        <p><strong>Purpose and Legal Basis</strong></p>
                        <p>
                            To create an account and prevent fraud, you will be asked to provide a valid government-issued ID for identity verification.
                            FAWNA Hotel processes your personal data in accordance with the Data Privacy Act of 2012 (Republic Act No. 10173) and its Implementing Rules and Regulations (IRR). We use your data only for legitimate purposes such as account creation, guest safety and security, and compliance with applicable laws and lawful requests from authorities.
                        </p>
                        <p><strong>What We Collect</strong></p>
                        <ul>
                            <li>Personal details you submit (e.g., full name, contact number, and email address).</li>
                            <li>ID details and image you upload (e.g., ID type and visible identifiers on the ID).</li>
                            <li>Submission metadata (e.g., upload timestamp and file type) to help ensure integrity and security.</li>
                        </ul>
                        <p><strong>How We Use and Protect Your Data</strong></p>
                        <ul>
                            <li>Verify your identity to protect guests and prevent fraudulent or abusive activity.</li>
                            <li>Facilitate your account registration and future transactions with FAWNA Hotel.</li>
                            <li>Comply with applicable laws and respond to lawful requests by competent authorities.</li>
                            <li>Store your ID image and related data with reasonable and appropriate organizational, physical, and technical safeguards, and retain only as long as necessary for the stated purposes or as permitted by law.</li>
                        </ul>
                        <p><strong>Your Consent and Responsibilities</strong></p>
                        <p>
                            By continuing, you confirm that the ID you submit is genuine and belongs to you, and you consent to FAWNA Hotelâ€™s secure processing of your personal data for identity verification and fraud prevention, consistent with our Privacy Policy and RA 10173.
                            You may exercise your data subject rights under RA 10173 (e.g., the right to access or correct) by contacting us through our official channels.
                        </p>
                        <p>
                            If you do not agree, you may cancel and return to the login page.
                        </p>
                        <div class="form-check mt-3">
                            <input class="form-check-input" type="checkbox" id="termsCheckbox">
                            <label class="form-check-label" for="termsCheckbox">
                                I have read and agree to the Terms & Conditions.
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer justify-content-center border-0">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="acceptTerms" style="background:#6D4C41;border:none;" disabled>I Agree</button>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/flash-messages.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Intercept Register link to show Terms & Conditions modal first
        var openTermsLink = document.getElementById('openTermsModal');
        var registerHref = openTermsLink ? openTermsLink.getAttribute('href') : null;
        if (openTermsLink) {
            openTermsLink.addEventListener('click', function(e) {
                e.preventDefault();
                var modalEl = document.getElementById('termsModal');
                if (modalEl && typeof bootstrap !== 'undefined') {
                    var modal = new bootstrap.Modal(modalEl);
                    modal.show();
                } else if (registerHref) {
                    // Fallback if modal isn't available
                    window.location.href = registerHref;
                }
            });
        }

        var acceptBtn = document.getElementById('acceptTerms');
        var termsCheckbox = document.getElementById('termsCheckbox');
        if (termsCheckbox && acceptBtn) {
            termsCheckbox.addEventListener('change', function() {
                acceptBtn.disabled = !this.checked;
            });
        }
        if (acceptBtn) {
            acceptBtn.addEventListener('click', function() {
                if (registerHref) window.location.href = registerHref;
            });
        }

        // Function to fade out and remove an element
        function fadeOut(element) {
            element.style.transition = 'opacity 500ms ease';
            element.style.opacity = '0';
            setTimeout(() => {
                if (element && element.parentNode) {
                    element.parentNode.removeChild(element);
                }
            }, 500);
        }

        // Handle pending approval message
        const pendingMessage = document.querySelector('.alert-warning');
        if (pendingMessage && pendingMessage.textContent.includes('pending approval')) {
            setTimeout(() => fadeOut(pendingMessage), 3000);
        }
    });
</script>
{% endblock %} 