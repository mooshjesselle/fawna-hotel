{% extends "base.html" %}

{% block title %}{{ room.room_type.name }} - Room {{ room.room_number }}{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-md-8">
            <h1>{{ room.room_type.name }}</h1>
            <p class="text-muted">Room {{ room.room_number }}, Floor {{ room.floor }}</p>
            
            {% if room.image %}
            <div class="room-image mb-4">
                <img src="{{ url_for('static', filename=room.image) }}" alt="{{ room.room_type.name }}" class="img-fluid rounded">
            </div>
            {% endif %}
            
            <div class="room-description mb-4">
                <h3>Description</h3>
                <p>{{ room.room_type.description }}</p>
            </div>
            
            {% if room.amenities %}
            <div class="room-amenities mb-4">
                <h3>Amenities</h3>
                <ul class="list-group">
                    {% for amenity in room.amenities %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-{{ amenity.icon if amenity.icon else 'check' }} me-2"></i>
                            {{ amenity.name }}
                        </div>
                        {% if amenity.additional_cost > 0 %}
                        <span class="badge bg-primary rounded-pill">+₱{{ "%.2f"|format(amenity.additional_cost) }}</span>
                        {% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            <!-- Room Reviews Summary -->
            <div class="room-reviews mb-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h3>Guest Reviews</h3>
                    <a href="{{ url_for('room_reviews', room_id=room.id) }}" class="btn btn-outline-secondary btn-sm">
                        View All Reviews
                    </a>
                </div>
                
                {% if comments %}
                    <div class="d-flex align-items-center mb-3">
                        <div class="rating me-2">
                            {% for i in range(5) %}
                                {% if i < avg_rating|int %}
                                    <span>★</span>
                                {% else %}
                                    <span style="color:#ddd">☆</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <span class="fw-bold">{{ "%.1f"|format(avg_rating) }}</span>
                        <span class="text-muted ms-2">({{ comments|length }} reviews)</span>
                    </div>
                    
                    <!-- Display a few recent reviews -->
                    {% for comment in comments[:2] %}
                    <div class="comment-card">
                        <div class="d-flex justify-content-between">
                            <h5>{{ comment.author.name }}</h5>
                            <small class="text-muted">{{ comment.created_at.strftime('%B %d, %Y') }}</small>
                        </div>
                        <div class="rating mb-2">
                            {% for i in range(5) %}
                                {% if i < comment.rating %}
                                    <span>★</span>
                                {% else %}
                                    <span style="color:#ddd">☆</span>
                                {% endif %}
                            {% endfor %}
                        </div>
                        <p>{{ comment.content }}</p>
                    </div>
                    {% endfor %}
                    
                    {% if comments|length > 2 %}
                    <div class="text-center mt-3">
                        <a href="{{ url_for('room_reviews', room_id=room.id) }}" class="btn btn-outline-primary">
                            View All {{ comments|length }} Reviews
                        </a>
                    </div>
                    {% endif %}
                {% else %}
                    <p class="text-muted">No reviews yet for this room.</p>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card booking-card sticky-top" style="top: 20px; z-index: 100;">
                <div class="card-header">
                    <h3>Book This Room</h3>
                </div>
                <div class="card-body">
                    <h4 class="price mb-3">₱{{ "%.2f"|format(room.room_type.price_per_night) }} <span class="text-muted">per night</span></h4>
                    
                    <p><strong>Max Occupancy:</strong> {{ room.occupancy_limit }} persons</p>
                    
                    <form action="{{ url_for('book_room', room_id=room.id) }}" method="POST">
                        <div class="mb-3">
                            <label for="check_in" class="form-label">Check-in Date</label>
                            <input type="date" class="form-control" id="check_in" name="check_in" required>
                        </div>
                        <div class="mb-3">
                            <label for="check_out" class="form-label">Check-out Date</label>
                            <input type="date" class="form-control" id="check_out" name="check_out" required>
                        </div>
                        
                        <div id="price-calculation" class="d-none mb-3">
                            <table class="table table-sm">
                                <tr>
                                    <td>Base Rate:</td>
                                    <td>₱{{ "%.2f"|format(room.room_type.price_per_night) }} x <span id="nights">0</span> nights</td>
                                    <td class="text-end">₱<span id="base-price">0.00</span></td>
                                </tr>
                                <tr class="fw-bold">
                                    <td colspan="2">Total:</td>
                                    <td class="text-end">₱<span id="total-price">0.00</span></td>
                                </tr>
                            </table>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100" {% if not room.is_available %}disabled{% endif %}>
                            {% if room.is_available %}Book Now{% else %}Not Available{% endif %}
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkInInput = document.getElementById('check_in');
    const checkOutInput = document.getElementById('check_out');
    const priceCalc = document.getElementById('price-calculation');
    const nightsEl = document.getElementById('nights');
    const basePriceEl = document.getElementById('base-price');
    const totalPriceEl = document.getElementById('total-price');
    const pricePerNight = parseFloat("{{ room.room_type.price_per_night }}");
    
    // Set min dates
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);
    
    function formatDate(date) {
        return date.toISOString().split('T')[0];
    }
    
    checkInInput.min = formatDate(today);
    checkOutInput.min = formatDate(tomorrow);
    
    // When check-in changes, update check-out min date
    checkInInput.addEventListener('change', function() {
        const checkInDate = new Date(this.value);
        const minCheckOutDate = new Date(checkInDate);
        minCheckOutDate.setDate(checkInDate.getDate() + 1);
        
        checkOutInput.min = formatDate(minCheckOutDate);
        
        // If check-out is before new min date, update it
        if (new Date(checkOutInput.value) <= checkInDate) {
            checkOutInput.value = formatDate(minCheckOutDate);
        }
        
        calculatePrice();
    });
    
    checkOutInput.addEventListener('change', calculatePrice);
    
    function calculatePrice() {
        if (checkInInput.value && checkOutInput.value) {
            const checkInDate = new Date(checkInInput.value);
            const checkOutDate = new Date(checkOutInput.value);
            
            // Calculate nights
            const nights = Math.ceil((checkOutDate - checkInDate) / (1000 * 60 * 60 * 24));
            
            if (nights > 0) {
                const basePrice = nights * pricePerNight;
                
                nightsEl.textContent = nights;
                basePriceEl.textContent = basePrice.toFixed(2);
                totalPriceEl.textContent = basePrice.toFixed(2);
                
                priceCalc.classList.remove('d-none');
                return;
            }
        }
        
        priceCalc.classList.add('d-none');
    }
});
</script>
{% endblock %} 