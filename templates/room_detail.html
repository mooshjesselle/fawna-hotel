{% extends 'base.html' %}

{% block title %}{{ room.room_type.name }} - Room {{ room.room_number }}{% endblock %}

{% block content %}
<style>
    /* Style for disabled dates */
    input[type="date"]::-webkit-calendar-picker-indicator {
        cursor: pointer;
    }
    
    /* Custom styles for the date inputs */
    .date-input-container {
        position: relative;
    }
    
    .date-input-container input[type="date"] {
        background-color: #fff;
    }
    
    .date-input-container input[type="date"]:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
    }

    /* Styles for calendar picker */
    input[type="date"]::-webkit-calendar-picker-indicator {
        opacity: 1;
        cursor: pointer;
    }

    /* Style for the input text */
    input[type="date"] {
        color: #333 !important;
        background-color: #fff !important;
    }

    /* Style for disabled dates in calendar */
    input[type="date"]::-webkit-datetime-edit {
        color: #333;
    }

    /* Styles for unavailable dates */
    input[type="date"][id="check_in"] {
        color: #999;
        background-color: #f8f9fa;
    }

    input[type="date"][id="check_in"]::-webkit-calendar-picker-indicator {
        filter: grayscale(1);
    }

    input[type="date"][id="check_out"] {
        color: #999;
        background-color: #f8f9fa;
    }

    input[type="date"][id="check_out"]::-webkit-calendar-picker-indicator {
        filter: grayscale(1);
    }
    
    /* Custom radio button styling */
    .form-check-input[type="radio"] {
        border-color: #6D4C41;
    }
    
    .form-check-input[type="radio"]:checked {
        background-color: #6D4C41;
        border-color: #6D4C41;
    }
    
    .form-check-input:focus {
        border-color: #6D4C41;
        box-shadow: 0 0 0 0.25rem rgba(109, 76, 65, 0.25);
    }
    
    /* Payment option styling */
    .payment-option {
        padding: 12px;
        border-radius: 8px;
        transition: background-color 0.2s ease;
        cursor: pointer;
        margin-bottom: 10px !important;
    }
    
    .payment-option:hover {
        background-color: rgba(109, 76, 65, 0.05);
    }
    
    .payment-option.selected {
        background-color: rgba(109, 76, 65, 0.1);
    }
    
    .payment-option label {
        cursor: pointer;
        width: 100%;
    }

    .price-highlight {
        background: #ffe082;
        transition: background 0.3s;
    }

    #price-breakdown { font-size: 1em; }
    #price-breakdown .fw-bold { color: #6D4C41; }
    #price-breakdown hr { border-top: 1px solid #e0cfa3; }
    .sticky-booking-form {
        position: sticky;
        top: 90px;
        z-index: 10;
    }
    .book-now-top-btn {
        display: inline-block;
        margin-bottom: 16px;
        background: #6D4C41;
        color: #fff;
        font-weight: 600;
        border: none;
        border-radius: 6px;
        padding: 10px 24px;
        font-size: 1.1rem;
        transition: background 0.2s;
    }
    .book-now-top-btn:hover {
        background: #8D674A;
        color: #fff;
    }
    .container.py-5 { padding-top: 1.5rem !important; padding-bottom: 1.5rem !important; }
    #reset-unavailable-date-filter {
        background-color: #6D4C41;
        color: #fff;
        border: none;
        transition: background 0.2s;
    }
    #reset-unavailable-date-filter:hover, #reset-unavailable-date-filter:focus {
        background-color: #8D674A;
        color: #fff;
    }
    /* Reviews layout tweaks */
    
    .rating-display { display: inline-flex; gap: 6px; }
    @media (max-width: 576px) {
        .review-item .d-flex.justify-content-between {
            gap: 8px; flex-wrap: nowrap;
        }
        .review-item .rating-display { display: inline-flex; flex-direction: row; gap: 4px; }
    }
</style>

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="container mt-3">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="container py-5">
    <div class="row">
        <!-- Room Image and Details -->
        <div class="col-lg-8">
            <div class="card mb-4 border-0 shadow-sm" style="margin-top: 20px;">
                <div class="card-body p-0">
                    <div class="position-relative">
                        {% if room.image %}
                        <img src="{{ url_for('static', filename=room.image) }}" class="card-img-top" alt="{{ room.room_type.name }}" style="height: 300px; object-fit: cover;">
                        {% else %}
                        <div class="default-room-image" style="height: 300px; background-color: #f8f9fa; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-bed fa-4x text-muted"></i>
                        </div>
                        {% endif %}
                        <div class="position-absolute top-0 end-0 p-3">
                       <span class="badge" style="background-color: #6D4C41; color: white; font-size: 1.2rem;">₱{{ "{:,.2f}".format(room.room_type.price_per_night) }} / night</span>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h2 class="card-title mb-0">{{ room.room_type.name }} - Room {{ room.room_number }}</h2>
                            <div class="rating-display">
                                <div class="stars">
                                    {% for i in range(5) %}
                                        {% if i < avg_rating|int %}
                                        <i class="fas fa-star text-warning"></i>
                                        {% elif i < avg_rating %}
                                        <i class="fas fa-star-half-alt text-warning"></i>
                                        {% else %}
                                        <i class="far fa-star text-warning"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                                <span class="rating-value">{{ avg_rating|round(1) }}</span>
                                <span class="rating-count">({{ review_count }} reviews)</span>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h5>Room Description</h5>
                            <p>{{ room.room_type.description }}</p>
                        </div>

                        <div class="mb-3">
                            <h5 class="mb-2">Amenities</h5>
                            <div class="row g-2" style="min-height: 40px;">
                                {% if room.amenities %}
                                    {% for amenity in room.amenities %}
                                    <div class="col-md-4 col-6">
                                        <div class="d-flex align-items-center bg-light rounded p-2">
                                            <i class="fas fa-{{ amenity.icon }}" style="color: #6D4C41; font-size: 1rem; width: 24px;"></i>
                                            <span style="color: #333; font-weight: 500; font-size: 0.9rem; margin-left: 8px;">{{ amenity.name }}</span>
                                            {% if amenity.additional_cost > 0 %}
                                            <span class="badge bg-light text-dark ms-1" style="font-size: 0.7rem;">
                                                +₱{{ "%.2f"|format(amenity.additional_cost) }}
                                            </span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Booking Schedule -->
                        {% if current_user.is_authenticated and room.bookings and room.bookings|selectattr('status', 'equalto', 'approved')|list %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">Booking Schedule</h5>
                            </div>
                            <div class="card-body">
                                <!-- Unavailable Dates button inside the card -->
                                {% if unavailable_dates and unavailable_dates|length > 0 %}
                                <button type="button" class="btn w-100" style="background-color: #6D4C41; color: #fff; font-weight: 600;" data-bs-toggle="modal" data-bs-target="#unavailableDatesModal">
                                    <i class="fas fa-calendar-times me-2"></i>Unavailable Dates
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <!-- Move Unavailable Dates button here -->
                        {% if unavailable_dates and unavailable_dates|length > 0 %}
                        <div class="mb-3">
                            <!-- Unavailable Dates Modal -->
                            <div class="modal fade" id="unavailableDatesModal" tabindex="-1" aria-labelledby="unavailableDatesModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-dialog-scrollable">
                                    <div class="modal-content">
                                        <div class="modal-header" style="background-color: #6D4C41; color: #fff;">
                                            <h5 class="modal-title" id="unavailableDatesModalLabel"><i class="fas fa-calendar-times me-2"></i>Unavailable Dates</h5>
                                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body">
                                            <!-- Date Filter -->
                                            <div class="mb-3 d-flex align-items-center gap-2">
                                                <input type="date" id="unavailable-date-filter" class="form-control" placeholder="dd/mm/yyyy" />
                                                <button type="button" id="reset-unavailable-date-filter" class="btn btn-outline-secondary">Reset</button>
                                            </div>
                                            <!-- Booking Ranges List -->
                                            <div id="booking-ranges-list">
                                                <table class="table table-bordered table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Check In</th>
                                                            <th>Check Out</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for booking in booking_ranges %}
                                                        <tr class="booking-range-item">
                                                            <td>{{ booking.check_in.strftime('%d/%m/%Y') }}</td>
                                                            <td>{{ booking.check_out.strftime('%d/%m/%Y') }}</td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div id="no-bookings-msg" class="alert alert-info mt-3" style="display:none;">No bookings found for the selected date.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}
                        
                        <!-- Room Details Section (Moved from sidebar) -->
                        <div class="card shadow-sm mb-4">
                            <div class="card-header" style="background-color: #6D4C41; color: white;">
                                <h5 class="mb-0">Room Details</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Room Type:</span>
                                                <span class="fw-bold">{{ room.room_type.name }}</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Room Number:</span>
                                                <span class="fw-bold">{{ room.room_number }}</span>
                                            </li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <ul class="list-group list-group-flush">
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Price per Night:</span>
                                              <span class="fw-bold">₱{{ "{:,.2f}".format(room.room_type.price_per_night) }}</span>
                                            </li>
                                            <li class="list-group-item d-flex justify-content-between">
                                                <span>Max Capacity:</span>
                                                <span class="fw-bold">{{ room.occupancy_limit }} persons</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar with booking form -->
        <div class="col-lg-4">
            <div class="sticky-booking-form">
            <div class="card shadow-sm mb-4" style="margin-top: 20px;">
                <div class="card-header text-white" style="background-color: #6D4C41;">
                    <h4 class="mb-0">Book This Room</h4>
                </div>
                <div class="card-body">
                    {% if current_user.is_authenticated %}
                        {% set user_bookings = room.bookings|selectattr('user_id', 'equalto', current_user.id)|selectattr('status', 'in', ['pending', 'approved'])|list %}
                        {% if user_bookings %}
                            <div class="alert alert-warning mt-2">
                                <strong>Notice:</strong> You already have a pending or approved booking for this room:
                                <ul>
                                    {% for b in user_bookings %}
                                        <li>{{ b.check_in_date.strftime('%B %d, %Y') }} to {{ b.check_out_date.strftime('%B %d, %Y') }} ({{ b.status|capitalize }})</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        {% endif %}
                        <div id="booking-form-container">
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            // Create array of booked date ranges
                            const bookedDateRanges = [
                                {% for booking in room.bookings if booking.status == 'approved' %}
                                {
                                    checkIn: '{{ booking.check_in_date.strftime("%Y-%m-%d") }}',
                                    checkOut: '{{ booking.check_out_date.strftime("%Y-%m-%d") }}'
                                },
                                {% endfor %}
                            ];

                            // Sort booked ranges by check-in date
                            bookedDateRanges.sort((a, b) => a.checkIn.localeCompare(b.checkIn));

                            const today = new Date();
                            today.setHours(0, 0, 0, 0); // Reset time part
                            const tomorrow = new Date(today);
                            tomorrow.setDate(today.getDate() + 1);
                            
                            const checkIn = document.getElementById('check_in');
                            const checkOut = document.getElementById('check_out');
                            
                            if (checkIn && checkOut) {
                                // Format dates to YYYY-MM-DD
                                const formatDate = date => {
                                    const year = date.getFullYear();
                                    const month = String(date.getMonth() + 1).padStart(2, '0');
                                    const day = String(date.getDate()).padStart(2, '0');
                                    return `${year}-${month}-${day}`;
                                };

                                // Parse date string to Date object
                                const parseDate = dateStr => {
                                    const [year, month, day] = dateStr.split('-').map(Number);
                                    return new Date(year, month - 1, day);
                                };

                                // Check if a date range overlaps with booked dates
                                const isDateRangeBooked = (startDate, endDate) => {
                                    const start = formatDate(startDate);
                                    const end = formatDate(endDate);
                                    
                                    return bookedDateRanges.some(range => {
                                        return (start < range.checkOut && end > range.checkIn);
                                    });
                                };

                                // Set minimum dates for inputs
                                const todayStr = formatDate(today);
                                checkIn.min = todayStr;
                                checkOut.min = formatDate(tomorrow);

                                // Handle date selection for check-in
                                checkIn.addEventListener('input', function() {
                                    const selectedDate = parseDate(this.value);
                                    
                                    // Validate selected date is not in the past
                                    if (selectedDate < today) {
                                        alert("Cannot select a past date. Please choose a date from today onwards.");
                                        this.value = todayStr;
                                        return;
                                    }

                                    // Set minimum check-out date to day after check-in
                                    const minCheckOut = new Date(selectedDate);
                                    minCheckOut.setDate(selectedDate.getDate() + 1);
                                    checkOut.min = formatDate(minCheckOut);

                                    // If check-out date is before new minimum, update it
                                    const checkOutDate = checkOut.value ? parseDate(checkOut.value) : null;
                                    if (!checkOutDate || checkOutDate <= selectedDate) {
                                        checkOut.value = formatDate(minCheckOut);
                                    }

                                    // Check if selected range is available
                                    if (checkOut.value) {
                                        const endDate = parseDate(checkOut.value);
                                        if (isDateRangeBooked(selectedDate, endDate)) {
                                            alert("Selected dates overlap with an existing booking. Please choose different dates.");
                                            this.value = '';
                                            checkOut.value = '';
                                            return;
                                        }
                                    }

                                    calculatePrice();
                                });

                                // Handle date selection for check-out
                                checkOut.addEventListener('input', function() {
                                    if (!checkIn.value) {
                                        alert("Please select a check-in date first.");
                                        this.value = '';
                                        return;
                                    }

                                    const startDate = parseDate(checkIn.value);
                                    const selectedDate = parseDate(this.value);

                                    // Validate check-out is after check-in
                                    if (selectedDate <= startDate) {
                                        alert("Check-out date must be after check-in date.");
                                        const nextDay = new Date(startDate);
                                        nextDay.setDate(startDate.getDate() + 1);
                                        this.value = formatDate(nextDay);
                                        return;
                                    }

                                    // Check if selected range is available
                                    if (isDateRangeBooked(startDate, selectedDate)) {
                                        alert("Selected dates overlap with an existing booking. Please choose different dates.");
                                        this.value = '';
                                        return;
                                    }

                                    calculatePrice();
                                });

                                // Initialize with today's date if available
                                if (!isDateRangeBooked(today, tomorrow)) {
                                    checkIn.value = todayStr;
                                    checkOut.value = formatDate(tomorrow);
                                    calculatePrice();
                                }
                            }
                        });
                    </script>
                    <form id="booking-form" method="POST" action="{{ url_for('create_booking') }}" enctype="multipart/form-data">
                        <!-- Hidden Fields -->
                        <input type="hidden" name="room_id" value="{{ room.id }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <!-- Check In Date -->
                        <div class="mb-3">
                            <label for="check_in" class="form-label">Check In</label>
                            <input type="date" class="form-control" id="check_in" name="check_in" required>
                        </div>
                        
                        <!-- Check Out Date -->
                        <div class="mb-3">
                            <label for="check_out" class="form-label">Check Out</label>
                            <input type="date" class="form-control" id="check_out" name="check_out" required>
                        </div>
                        
                        <!-- Number of Guests -->
                        <div class="mb-3">
                            <label for="guests" class="form-label">Number of Guests</label>
                            <select class="form-select" id="guests" name="guests" required>
                                {% for i in range(1, room.occupancy_limit + 1) %}
                                <option value="{{ i }}">{{ i }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Amenity Selection -->
                        {% if room.amenities %}
                        <div class="mb-3">
                            <label class="form-label">Select Amenities (optional)</label>
                            <div class="row">
                                {% for amenity in room.amenities %}
                                <div class="col-12">
                                    <div class="form-check">
                                        <input class="form-check-input amenity-checkbox" type="checkbox" name="amenities" value="{{ amenity.id }}" id="amenity{{ amenity.id }}" data-cost="{{ amenity.additional_cost }}">
                                        <label class="form-check-label" for="amenity{{ amenity.id }}">
                                            <i class="fas fa-{{ amenity.icon }}"></i> {{ amenity.name }}
                                            {% if amenity.additional_cost > 0 %}
                                        <span class="text-muted">(+₱{{ "{:,.2f}".format(amenity.additional_cost) }}/night)</span>   
                                            {% endif %}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Payment Method -->
                        <div class="mb-3">
                                    <label class="form-label fw-bold">Select Payment Method</label>
                                    <div class="card mb-3 border-0 shadow-sm">
                                        <div class="card-body">
                                            <div class="form-check mb-3 payment-option">
                                <input class="form-check-input" type="radio" name="payment_method" id="pay_on_site" value="pay_on_site" checked>
                                <label class="form-check-label" for="pay_on_site">
                                                    <i class="fas fa-money-bill-wave me-2" style="color: #6D4C41;"></i><strong>Pay on Site</strong>
                                                    <p class="text-muted small mb-0 ms-4">Pay the full amount at the hotel reception during check-in.</p>
                                </label>
                            </div>
                                            <div class="form-check mb-2 payment-option">
                                                <input class="form-check-input" type="radio" name="payment_method" id="qr_payment" value="qr_payment">
                                                <label class="form-check-label" for="qr_payment">
                                                    <i class="fas fa-qrcode me-2" style="color: #6D4C41;"></i><strong>Pay via QR Code</strong>
                                                    <p class="text-muted small mb-0 ms-4">Secure your booking by paying now via GCash or PayMaya.</p>
                                </label>
                                            </div>
                                            <div id="qr-payment-info" class="ms-4 mt-2 d-none">
                                                <div class="text-center mt-3">
                                                    <button type="button" class="btn w-100" style="background-color: #6D4C41; color: white; border: none;" id="show-qr-codes">
                                                        <i class="fas fa-qrcode me-2"></i>Scan QR Code to Pay
                                                    </button>
                                                </div>
                                                <div class="form-text mt-1">
                                                    <i class="fas fa-info-circle me-1"></i> After payment, upload proof to confirm your booking.
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="payment-options-note" class="alert alert-info">
                                        <div class="d-flex">
                                            <div class="me-3">
                                                <i class="fas fa-info-circle fa-2x"></i>
                                            </div>
                                            <div>
                                                <h6 class="alert-heading">Payment Information</h6>
                                                <p class="mb-0" id="pay-site-note">
                                                    Your booking will be reserved immediately. Payment will be collected at check-in.
                                                </p>
                                                <p class="mb-0 d-none" id="qr-payment-note">
                                                    For QR code payment, scan the code using your mobile app, complete the payment, then upload a screenshot as proof.
                                                </p>
                                            </div>
                                        </div>
                            </div>
                        </div>
                        
                                <!-- Payment Proof Upload Section (initially hidden) -->
                                <div id="payment-proof-section" class="mb-3 d-none">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-header bg-light">
                                            <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Payment Proof</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="payment_app" class="form-label">Payment App Used</label>
                                                <select class="form-select" id="payment_app" name="payment_app">
                                                    <option value="">Select payment app</option>
                                                    <option value="gcash">GCash</option>
                                                    <option value="paymaya">PayMaya</option>
                                                </select>
                            </div>
                            <div class="mb-3">
                                                <label for="payment_reference" class="form-label">Reference Number</label>
                                <input type="text" class="form-control" id="payment_reference" name="payment_reference" 
                                                    pattern="[0-9A-Za-z]{10,15}" 
                                                    maxlength="15">
                                                <div class="form-text">Enter the reference number from your transaction</div>
                            </div>
                            <div class="mb-3">
                                <label for="payment_screenshot" class="form-label">Payment Screenshot</label>
                                <input type="file" class="form-control" id="payment_screenshot" name="payment_screenshot" accept="image/*">
                                                <div class="form-text">Upload a clear screenshot showing the transaction details</div>
                                            </div>
                                        </div>
                            </div>
                        </div>
                        
                        <!-- Total Price Display and Breakdown -->
                        <div class="alert alert-info mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold">Total Price:</span>
                                <span class="fw-bold" style="font-size:1.3em;">₱<span id="total_price">0.00</span></span>
                            </div>
                            <input type="hidden" name="total_price" id="total_price_input" value="0">
                            <div id="price-breakdown" class="mt-3" style="background:#fffbe7; border-radius:8px; padding:12px;">
                                <div class="d-flex justify-content-between"><span>Nights:</span><span id="breakdown-nights">1</span></div>
                                <div class="d-flex justify-content-between"><span>Room Price per Night:</span><span>₱<span id="breakdown-base">0.00</span></span></div>
                                <div id="breakdown-amenities"></div>
                                <hr class="my-2">
                                <div class="d-flex justify-content-between fw-bold"><span>Total:</span><span>₱<span id="breakdown-total">0.00</span></span></div>
                            </div>
                        </div>
                        
                        <!-- Submit Button -->
                        <button type="submit" class="btn w-100" style="background-color: #6D4C41; color: white;">
                            Book Now
                        </button>
                    </form>
                </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-lock fa-4x mb-3" style="color: #6D4C41;"></i>
                            <h5 class="mb-3">Login Required to Book</h5>
                            <p class="text-muted mb-4">You need to be logged in to make a booking.</p>
                            <a href="{{ url_for('login') }}" class="btn btn-lg w-100" style="background-color: #6D4C41; color: white;">
                                <i class="fas fa-sign-in-alt me-2"></i>Login to Book
                            </a>
            </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    
  <div class="d-flex justify-content-center">
    <div class="card shadow-sm" style=" width: 100%; margin-top: 20px;">
                <div class="card-header text-white" style="background-color: #6D4C41;">
                    <h4 class="mb-0">Guest Reviews ({{ review_count }})</h4>
                </div>
                <div class="card-body">
                    {% if comments %}
                        {% for comment in comments %}
                        <div class="review-item mb-4 pb-4 border-bottom">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <h5 class="mb-0">{{ comment.user }}</h5>
                                    <small class="text-muted">{{ comment.date }}</small>
                                </div>
                                <div class="rating-display">
                                    {% for i in range(5) %}
                                        {% if i < comment.rating %}
                                        <i class="fas fa-star text-warning"></i>
                                        {% else %}
                                        <i class="far fa-star text-warning"></i>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                            <p class="mb-0">{{ comment.content }}</p>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="far fa-comment-alt fa-4x text-muted mb-3"></i>
                            <h5>No Reviews Yet</h5>
                            <p class="text-muted">
                                {% if current_user.is_authenticated %}
                                    {% set has_completed_stay = false %}
                                    {% for booking in room.bookings %}
                                        {% if booking.user_id == current_user.id and booking.status == 'approved' and not booking.comments %}
                                            {% set has_completed_stay = true %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if has_completed_stay %}
                                        <a href="{{ url_for('add_comment', booking_id=booking.id) }}" class="btn btn-primary mt-3">
                                            <i class="fas fa-star me-2"></i>Write a Review
                                        </a>
                                    {% else %}
                                        Book a stay to share your experience!
                                    {% endif %}
                                {% else %}
                                    <a href="{{ url_for('login') }}" class="text-primary">Log in</a> to share your experience!
                                {% endif %}
                            </p>
                        </div>
                    {% endif %}
                </div>
                </div>
  
</div>

<!-- Booking Success Modal -->
<div class="modal fade" id="bookingSuccessModal" tabindex="-1" aria-labelledby="bookingSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #6D4C41; color: white;">
                <h5 class="modal-title" id="bookingSuccessModalLabel">Booking Successful!</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                </div>
                <h4 class="mb-3">Thank you for your booking!</h4>
                <p class="mb-3" id="booking-success-message">
                    Your booking request has been successfully submitted. 
                </p>
                <div id="payment-status-message" class="alert alert-info">
                    <p class="mb-0" id="payment-site-message">
                        Your room is now reserved. Payment will be collected during check-in.
                    </p>
                    <p class="mb-0 d-none" id="payment-qr-message">
                        Our team will verify your payment and confirm your booking. You'll receive a confirmation email shortly.
                    </p>
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <a href="{{ url_for('dashboard') }}" class="btn" style="background-color: #6D4C41; color: white;">Go to Dashboard</a>
            </div>
        </div>
    </div>
</div>

<!-- QR Code Payment Modal -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-labelledby="qrCodeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #6D4C41; color: white;">
                <h5 class="modal-title" id="qrCodeModalLabel">
                    <i class="fas fa-qrcode me-2"></i>Secure Payment Via QR Code
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-4">
                    <div class="d-flex">
                        <div class="me-3">
                            <i class="fas fa-shield-alt fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="alert-heading">Secure Payment Process</h6>
                            <ol class="mb-0">
                                <li>Scan the QR code below using your preferred payment app</li>
                                <li>Complete the payment of <strong>₱<span class="modal-amount">0.00</span></strong></li>
                                <li>Take a screenshot of your payment confirmation</li>
                                <li>Upload the screenshot and reference number when you return to the booking form</li>
                            </ol>
                        </div>
                    </div>
                </div>
                
                <div class="row g-4">
                    <!-- GCash QR Code -->
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header text-white" style="background-color: #007EFF;">
                                <div class="d-flex align-items-center">
                                    <img src="{{ url_for('static', filename='images/gcash-logo.png') }}" alt="GCash" style="height: 30px; margin-right: 10px;">
                                    <h5 class="mb-0">GCash QR Code</h5>
                                </div>
                            </div>
                            <div class="card-body text-center p-4">
                                <div class="qr-code-container mb-3">
                                    <img src="{{ url_for('static', filename='images/gcash-qr.jpg') }}" alt="GCash QR Code" class="img-fluid" style="max-width: 200px;">
                                </div>
                                <div class="payment-details">
                                    <p class="fw-bold mb-1">Amount: ₱<span class="modal-amount">0.00</span></p>
                                    <p class="mb-1">Account: FAWNA HOTEL</p>
                                    <p class="mb-0">Number: 09932670873</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PayMaya QR Code -->
                    <div class="col-md-6">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-header text-white" style="background-color: #5a0ca5;">
                                <div class="d-flex align-items-center">
                                    <img src="{{ url_for('static', filename='images/paymaya-logo.png') }}" alt="PayMaya" style="height: 30px; margin-right: 10px;">
                                    <h5 class="mb-0">PayMaya QR Code</h5>
                                </div>
                            </div>
                            <div class="card-body text-center p-4">
                                <div class="qr-code-container mb-3">
                                    <img src="{{ url_for('static', filename='images/paymaya-qr.jpg') }}" alt="PayMaya QR Code" class="img-fluid" style="max-width: 200px;">
                                </div>
                                <div class="payment-details">
                                    <p class="fw-bold mb-1">Amount: ₱<span class="modal-amount">0.00</span></p>
                                    <p class="mb-1">Account: FAWNA HOTEL</p>
                                    <p class="mb-0">Number: 09932670873</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn" id="return-to-form" data-bs-dismiss="modal" style="background-color: #6D4C41; color: white;">
                    I've Completed Payment
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

            </div>
        </div>
    </div>
</div>

<!-- Unavailable Dates Filter Script (calendar only) -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const unavailableDateFilter = document.getElementById('unavailable-date-filter');
    const resetBtn = document.getElementById('reset-unavailable-date-filter');
    const bookingRangesList = document.getElementById('booking-ranges-list');
    const noBookingsMsg = document.getElementById('no-bookings-msg');
    if (!unavailableDateFilter || !bookingRangesList) return;
    const originalBookingItems = Array.from(bookingRangesList.querySelectorAll('.booking-range-item'));

    // Helper to convert YYYY-MM-DD to DD/MM/YYYY
    function ymdToDMY(ymd) {
        const [year, month, day] = ymd.split('-');
        return `${day}/${month}/${year}`;
    }

    // Helper to convert DD/MM/YYYY to a Date object
    function dmyToDate(dmy) {
        const [day, month, year] = dmy.split('/');
        return new Date(`${year}-${month}-${day}`);
    }

    // Prepare booking data for DD/MM/YYYY comparison
    const bookingData = originalBookingItems.map(item => {
        const text = item.textContent;
        const match = text.match(/(\d{2}\/\d{2}\/\d{4}) to (\d{2}\/\d{2}\/\d{4})/);
        if (match) {
            const checkIn = match[1];
            const checkOut = match[2];
            return { item, checkIn, checkOut };
        }
        return null;
    }).filter(Boolean);

    function filterBookingsByDate(dateStr) {
        originalBookingItems.forEach(item => item.style.display = 'none');
        let anyShown = false;
        if (!dateStr) {
            originalBookingItems.forEach(item => item.style.display = '');
            anyShown = originalBookingItems.length > 0;
        } else {
            const dmy = ymdToDMY(dateStr);
            const [selDay, selMonth] = dmy.split('/'); // Ignore year for this match
            bookingData.forEach(({ item, checkIn, checkOut }) => {
                const checkInDate = dmyToDate(checkIn);
                const checkOutDate = dmyToDate(checkOut);
                let d = new Date(checkInDate);
                let found = false;
                while (d < checkOutDate) {
                    const dDay = String(d.getDate()).padStart(2, '0');
                    const dMonth = String(d.getMonth() + 1).padStart(2, '0');
                    if (dDay === selDay && dMonth === selMonth) {
                        item.style.display = '';
                        anyShown = true;
                        found = true;
                        break;
                    }
                    d.setDate(d.getDate() + 1);
                }
                if (!found) {
                    item.style.display = 'none';
                }
            });
        }
        if (noBookingsMsg) {
            noBookingsMsg.style.display = anyShown ? 'none' : '';
        }
    }

    unavailableDateFilter.addEventListener('input', function() {
        filterBookingsByDate(this.value);
    });
    filterBookingsByDate('');

    if (resetBtn) {
        resetBtn.addEventListener('click', function() {
            unavailableDateFilter.value = '';
            filterBookingsByDate('');
        });
    }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('booking-form');
    const checkIn = document.getElementById('check_in');
    const checkOut = document.getElementById('check_out');
    const pricePerNight = {{ room.room_type.price_per_night }};
    const totalPriceDisplay = document.getElementById('total_price');
    const totalPriceInput = document.getElementById('total_price_input');
    
    // Payment method elements
    const paymentMethodInputs = document.querySelectorAll('input[name="payment_method"]');
    const qrPaymentInfo = document.getElementById('qr-payment-info');
    const paySiteNote = document.getElementById('pay-site-note');
    const qrPaymentNote = document.getElementById('qr-payment-note');
    const paymentProofSection = document.getElementById('payment-proof-section');
    
    // Set minimum dates
    const today = new Date();
    const tomorrow = new Date(today);
    tomorrow.setDate(today.getDate() + 1);
    
    if (checkIn && checkOut) {
    checkIn.min = today.toISOString().split('T')[0];
    checkOut.min = tomorrow.toISOString().split('T')[0];
    }
    
    // Calculate total price
    function formatPrice(num) {
        return parseFloat(num).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
    }
    function calculatePrice() {
        const checkIn = document.getElementById('check_in');
        const checkOut = document.getElementById('check_out');
        const guests = document.getElementById('guests');
        const amenityCheckboxes = document.querySelectorAll('.amenity-checkbox');
        const nightsElem = document.getElementById('breakdown-nights');
        const baseElem = document.getElementById('breakdown-base');
        const totalElem = document.getElementById('breakdown-total');
        const totalPriceElem = document.getElementById('total_price');
        const totalPriceInput = document.getElementById('total_price_input');
        const breakdownAmenities = document.getElementById('breakdown-amenities');

        if (!checkIn.value || !checkOut.value) return;
        const start = new Date(checkIn.value);
        const end = new Date(checkOut.value);
        const nights = (end - start) / (1000 * 60 * 60 * 24);
        if (nights <= 0) return;
        nightsElem.textContent = nights;

        // Use promo discount if available
        let basePrice = {{ room.room_type.price_per_night|float }};
        {% if promo and promo.discount_percentage > 0 %}
        basePrice = basePrice * (1 - {{ promo.discount_percentage|float }} / 100);
        {% endif %}
        baseElem.textContent = basePrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

        // Calculate amenities cost
        let amenitiesTotal = 0;
        breakdownAmenities.innerHTML = '';
        amenityCheckboxes.forEach(function(cb) {
            if (cb.checked) {
                const cost = parseFloat(cb.getAttribute('data-cost')) || 0;
                amenitiesTotal += cost * nights;
                if (cost > 0) {
                    breakdownAmenities.innerHTML += `<div class='d-flex justify-content-between'><span>${cb.nextElementSibling.innerText}</span><span>₱${(cost * nights).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span></div>`;
                }
            }
        });

        // Calculate total
        const total = basePrice * nights + amenitiesTotal;
        totalElem.textContent = total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        totalPriceElem.textContent = total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
        totalPriceInput.value = total.toFixed(2);
    }
    
    // Event listeners for date changes
    if (checkIn && checkOut) {
    checkIn.addEventListener('change', function() {
        const nextDay = new Date(this.value);
        nextDay.setDate(nextDay.getDate() + 1);
        checkOut.min = nextDay.toISOString().split('T')[0];
        if (checkOut.value && new Date(checkOut.value) <= new Date(this.value)) {
            checkOut.value = nextDay.toISOString().split('T')[0];
        }
        calculatePrice();
    });
    
    checkOut.addEventListener('change', calculatePrice);
    }
    
    // Toggle payment options display
    paymentMethodInputs.forEach(input => {
        input.addEventListener('change', function() {
            const isQrPayment = this.value === 'qr_payment';
            
            // Show/hide QR payment info
            if (qrPaymentInfo) {
                qrPaymentInfo.classList.toggle('d-none', !isQrPayment);
            }
            
            // Show/hide payment notes
            if (paySiteNote && qrPaymentNote) {
                paySiteNote.classList.toggle('d-none', isQrPayment);
                qrPaymentNote.classList.toggle('d-none', !isQrPayment);
            }
            
            // Show/hide payment proof section
            if (paymentProofSection) {
                paymentProofSection.classList.toggle('d-none', !isQrPayment);
            }
            
            // Toggle required attributes for payment fields
            if (paymentProofSection) {
                const inputs = paymentProofSection.querySelectorAll('input, select');
                inputs.forEach(field => {
                    field.required = isQrPayment;
                });
            }
        });
    });
    
    // Show QR modal
    const showQrButton = document.getElementById('show-qr-codes');
    if (showQrButton) {
        showQrButton.addEventListener('click', function() {
            // Update amounts in QR modal
            const totalPrice = document.getElementById('total_price').textContent;
            document.querySelectorAll('.modal-amount').forEach(el => {
                el.textContent = totalPrice;
            });
            
            const qrModal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
            qrModal.show();
        });
    }
    
    // Handle QR modal return to form
    const returnToFormButton = document.getElementById('return-to-form');
    if (returnToFormButton) {
        returnToFormButton.addEventListener('click', function() {
            // Focus on the payment app dropdown to guide user
            const paymentAppSelect = document.getElementById('payment_app');
            if (paymentAppSelect) {
                setTimeout(() => {
                    paymentAppSelect.focus();
                }, 500);
            }
        });
    }
    
    // Update payment app selection
    const paymentAppSelect = document.getElementById('payment_app');
    if (paymentAppSelect) {
        paymentAppSelect.addEventListener('change', function() {
            const referenceInput = document.getElementById('payment_reference');
            if (referenceInput) {
                if (this.value === 'gcash') {
                    referenceInput.pattern = "[0-9]{13}";
                    referenceInput.maxLength = "13";
                    referenceInput.title = "Please enter exactly 13 digits for the GCash reference number";
                    referenceInput.placeholder = "13-digit reference number";
                } else if (this.value === 'paymaya') {
                    referenceInput.pattern = "[0-9A-Za-z]{10,15}";
                    referenceInput.maxLength = "15";
                    referenceInput.title = "Please enter the PayMaya reference number (10-15 characters)";
                    referenceInput.placeholder = "PayMaya reference number";
                }
            }
        });
    }
    
    // Form submission with validation
    if (form) {
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = form.querySelector('button[type="submit"]');
        const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;
        
            // Additional validation for QR payment
            if (paymentMethod === 'qr_payment') {
                const paymentApp = document.getElementById('payment_app').value;
            const reference = document.getElementById('payment_reference').value;
            const screenshot = document.getElementById('payment_screenshot').files[0];
            
                if (!paymentApp) {
                    alert('Please select the payment app you used');
                    return;
                }
                
                if (!reference) {
                    alert('Please enter the reference number from your payment');
                return;
            }
            
            if (!screenshot) {
                    alert('Please upload a screenshot of your payment confirmation');
                return;
            }
            
            if (!['image/jpeg', 'image/png', 'image/gif'].includes(screenshot.type)) {
                alert('Please upload a valid image file (JPG, PNG, or GIF)');
                return;
            }
        }
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
        
        const formData = new FormData(this);
        
        fetch(this.action, {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                    // Update success modal based on payment method
                    const paymentSiteMessage = document.getElementById('payment-site-message');
                    const paymentQrMessage = document.getElementById('payment-qr-message');
                    
                    if (paymentSiteMessage && paymentQrMessage) {
                        if (paymentMethod === 'pay_on_site') {
                            paymentSiteMessage.classList.remove('d-none');
                            paymentQrMessage.classList.add('d-none');
                        } else if (paymentMethod === 'qr_payment') {
                            paymentSiteMessage.classList.add('d-none');
                            paymentQrMessage.classList.remove('d-none');
                        }
                    }
                    
                // Show success modal
                const successModal = new bootstrap.Modal(document.getElementById('bookingSuccessModal'));
                successModal.show();
                
                    // Redirect to dashboard after 5 seconds
                setTimeout(() => {
                        window.location.href = data.redirect || '/dashboard';
                    }, 5000);
            } else {
                alert(data.error || 'An error occurred while processing your booking.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Book Now';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing your booking. Please try again.');
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Book Now';
        });
    });
    }
    
    // Add event listeners for amenity checkboxes
    document.querySelectorAll('.amenity-checkbox').forEach(cb => {
        cb.addEventListener('change', calculatePrice);
    });
    
    // Initial calculation
    calculatePrice();

    // Filter functionality
    const roomTypeFilter = document.getElementById('roomTypeFilter');
    const statusFilter = document.getElementById('statusFilter');
    const dateFilter = document.getElementById('dateFilter');
    
    // Load saved filters from localStorage if they exist
    if (localStorage.getItem('dashboard_roomType')) {
        roomTypeFilter.value = localStorage.getItem('dashboard_roomType');
    }
    
    if (localStorage.getItem('dashboard_status')) {
        statusFilter.value = localStorage.getItem('dashboard_status');
    }
    
    if (localStorage.getItem('dashboard_date')) {
        dateFilter.value = localStorage.getItem('dashboard_date');
    }

    // Prevent double submission
    if (form) {
        form.addEventListener('submit', function(e) {
            const btn = form.querySelector('button[type="submit"]');
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Processing...';
            }
        });
    }
});
</script>
{% endblock %} 