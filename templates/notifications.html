{% extends "base.html" %}

{% block title %}Notifications - Fawna Hotel{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="notifications-page">
                <!-- Page Header -->
                <div class="notifications-header">
                    <div class="d-flex flex-column align-items-start">
                        <div class="header-title">
                            <h1 class="page-title">
                                <i class="fas fa-bell me-2"></i>
                                Notifications
                            </h1>
                        </div>
                        <div class="notification-actions actions-below">
                            <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#markAllReadModalPage">
                                <i class="fas fa-check-double me-1"></i>
                                Mark All Read
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="clearAllNotifications()">
                                <i class="fas fa-trash me-1"></i>
                                Clear All
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Notifications List -->
                <div class="notifications-container">
                    <div id="notificationsList" class="notifications-list">
                        <!-- Loading state -->
                        <div class="loading-state" id="loadingState">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">Loading notifications...</p>
                        </div>

                        <!-- Empty state -->
                        <div class="empty-state" id="emptyState" style="display: none;">
                            <div class="empty-icon">
                                <i class="fas fa-bell-slash"></i>
                            </div>
                            <h3>No notifications</h3>
                            <p>You're all caught up! Check back later for new updates.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Detail Modal (for desktop) -->
<div class="modal fade" id="notificationDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Notification Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="notificationDetailContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Mark All Read Confirmation Modal (page-specific to avoid ID conflict) -->
<div class="modal fade" id="markAllReadModalPage" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mark All as Read</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to mark all notifications as read?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmMarkAllAsReadPage()">Mark All Read</button>
            </div>
        </div>
    </div>
</div>

<style>
.notifications-page {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.notifications-header {
    background: linear-gradient(135deg, #6D4C41 0%, #8D6E63 100%);
    color: white;
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    box-shadow: 0 4px 20px rgba(109, 76, 65, 0.3);
}

.page-title {
    font-size: 2.5rem;
    font-weight: 700;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.page-subtitle {
    font-size: 1.1rem;
    margin: 8px 0 0 0;
    opacity: 0.9;
}

 .notification-actions {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
 }

 .notification-actions .btn {
     border-color: rgba(255,255,255,0.3);
     color: white;
     background: rgba(255,255,255,0.1);
     backdrop-filter: blur(10px);
     transition: all 0.3s ease;
    font-size: 0.75rem;
    padding: 6px 10px;
 }

/* Right-side vertical actions in header */
.actions-below { margin-top: 10px; }

.notification-actions .btn:hover {
    background: rgba(255,255,255,0.2);
    border-color: rgba(255,255,255,0.5);
    transform: translateY(-2px);
}

.notifications-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    overflow: hidden;
}

.notifications-list {
    min-height: 400px;
}

.loading-state, .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 60px 20px;
    text-align: center;
}

.empty-icon {
    font-size: 4rem;
    color: #ddd;
    margin-bottom: 20px;
}

.empty-state h3 {
    color: #666;
    margin-bottom: 10px;
}

.empty-state p {
    color: #999;
    font-size: 1.1rem;
}

.notification-item-full {
    padding: 12px 16px;
    border-bottom: 1px solid #eee;
    transition: background-color 0.2s ease;
    cursor: pointer;
    position: relative;
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.notification-item-full:hover {
    background-color: #f9f6f2;
}

.notification-item-full.unread {
    background-color: #fff5ec;
}

.notification-item-full.unread::before {
    content: '';
    position: absolute;
    top: 50%;
    right: 20px;
    transform: translateY(-50%);
    width: 8px;
    height: 8px;
    background-color: #e64a19;
    border-radius: 50%;
}


.notification-icon-full {
    font-size: 1.1rem;
    color: #6D4C41;
    padding-top: 2px;
}

.notification-details-full {
    flex: 1;
}

.notification-title-full {
    color: #2d2d2d;
    font-weight: 600;
    margin-bottom: 2px;
    font-size: 0.98rem;
}

.notification-message-full {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 2px;
    line-height: 1.35;
}

.notification-meta-full {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
}

.notification-time-full {
    color: #999;
    font-size: 0.8rem;
}

.notification-type-full {
    font-size: 0.8rem;
    padding: 4px 8px;
    border-radius: 12px;
    background-color: #e3f2fd;
    color: #1976d2;
    text-transform: uppercase;
    font-weight: 500;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .notifications-page {
        padding: 15px;
    }
    
    .notifications-header {
        padding: 20px;
        margin-bottom: 20px;
    }
    
    .page-title {
        font-size: 0.9rem;
    }
    
    /* Ensure right-side actions are vertical on mobile */
    .actions-right {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 8px !important;
        width: 160px;
    }
    .actions-right .btn {
        font-size: 0.72rem;
        padding: 4px 8px;
        width: 100%;
    }
    
    .notification-item-full {
        padding: 15px;
    }
    
    .notification-content-full { gap: 10px; }
    .notification-icon-full { font-size: 1rem; }
    .notification-title-full { font-size: 0.95rem; }
    .notification-message-full { font-size: 0.85rem; }
    .notification-time-full { font-size: 0.75rem; }
    
    .notification-meta-full {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
}

/* Dark mode support */
@media (prefers-color-scheme: dark) {
    .notifications-container {
        background: #fff;
    }
    
    .notification-item-full {
        border-bottom-color: #444;
    }
    
    .notification-item-full:hover {
    background-color: #c7c6c6; /* your hover */
    border-left: 3px solid #cfc9c4; /* matching accent */
}

.notification-item-full.unread {
    background-color: #d8d3cd; /* unread */
    color: #a8a29e; /* matching text */
}


}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadNotifications();
    // Ensure profile dropdown works on this page
    const profileSection = document.querySelector('.profile-section');
    const profileDropdown = document.getElementById('profileDropdown');
    if (profileSection && profileDropdown) {
        const profileLink = profileSection.querySelector('a');
        if (profileLink && !profileLink.__fhv3Bound) {
            profileLink.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                profileDropdown.classList.toggle('show');
            });
            document.addEventListener('click', function(e) {
                if (!profileSection.contains(e.target)) {
                    profileDropdown.classList.remove('show');
                }
            });
            profileLink.__fhv3Bound = true;
        }
    }
});

function loadNotifications() {
    const loadingState = document.getElementById('loadingState');
    const emptyState = document.getElementById('emptyState');
    const notificationsList = document.getElementById('notificationsList');
    
    fetch('/notifications?per_page=50')
        .then(response => response.json())
        .then(data => {
            loadingState.style.display = 'none';
            
            if (data.notifications.length === 0) {
                emptyState.style.display = 'flex';
                return;
            }
            
            emptyState.style.display = 'none';
            
            // Clear existing notifications
            const existingNotifications = notificationsList.querySelectorAll('.notification-item-full');
            existingNotifications.forEach(item => item.remove());
            
            data.notifications.forEach(notification => {
                const notificationElement = createNotificationElement(notification);
                notificationsList.appendChild(notificationElement);
            });
        })
        .catch(error => {
            console.error('Error loading notifications:', error);
            loadingState.innerHTML = `
                <div class="text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <p>Failed to load notifications. Please try again.</p>
                </div>
            `;
        });
}

function createNotificationElement(notification) {
    const div = document.createElement('div');
    div.className = `notification-item-full ${notification.is_read ? '' : 'unread'}`;
    div.setAttribute('data-notification-id', notification.id);
    
    const icon = getNotificationIcon(notification.type);
    const timeAgo = formatTimestamp(notification.created_at);
    
    div.innerHTML = `
        <div class="notification-icon-full">
            <i class="fas ${icon}"></i>
        </div>
        <div class="notification-details-full">
            <div class="notification-title-full">${notification.title}</div>
            <div class="notification-message-full">${notification.message}</div>
            <div class="notification-meta-full">
                <div class="notification-time-full">${timeAgo}</div>
                <div class="notification-type-full">${notification.type}</div>
            </div>
        </div>
    `;
    
    div.addEventListener('click', () => {
        if (window.innerWidth > 768) {
            // Desktop: show modal
            showNotificationDetail(notification);
        } else {
            // Mobile: navigate to detail page or show full content
            showNotificationDetail(notification);
        }
        
        if (!notification.is_read) {
            markNotificationAsRead(notification.id);
        }
    });
    
    return div;
}

function showNotificationDetail(notification) {
    // For now, show modal on both desktop and mobile
    // You can modify this to navigate to a detail page on mobile if needed
    const modalContent = `
        <div class="notification-detail">
            <div class="detail-header">
                <div class="detail-icon">
                    <i class="fas ${getNotificationIcon(notification.type)}"></i>
                </div>
                <div class="detail-meta">
                    <h4>${notification.title}</h4>
                    <p class="detail-time">${formatTimestamp(notification.created_at)}</p>
                </div>
            </div>
            <div class="detail-content">
                <p>${notification.message}</p>
            </div>
        </div>
    `;
    
    document.getElementById('notificationDetailContent').innerHTML = modalContent;
    const modal = new bootstrap.Modal(document.getElementById('notificationDetailModal'));
    modal.show();
}

function markNotificationAsRead(notificationId) {
    fetch(`/notifications/${notificationId}/read`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the notification element
            const notificationElement = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (notificationElement) {
                notificationElement.classList.remove('unread');
                notificationElement.querySelector('.notification-icon-full').style.background = '#f5f5f5';
            }
        }
    })
    .catch(error => console.error('Error marking notification as read:', error));
}

function confirmMarkAllAsReadPage() {
    // Blur the currently focused element to avoid aria-hidden/focus conflict
    if (document.activeElement && typeof document.activeElement.blur === 'function') {
        document.activeElement.blur();
    }

    const modalEl = document.getElementById('markAllReadModalPage');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (!modalEl || !modal) {
        // Fallback: just proceed
        return markAllAsReadPage();
    }

    // Wait until the modal is fully hidden before proceeding
    const onHidden = () => {
        modalEl.removeEventListener('hidden.bs.modal', onHidden);
        markAllAsReadPage();
    };
    modalEl.addEventListener('hidden.bs.modal', onHidden, { once: true });
    modal.hide();
}

function markAllAsReadPage() {
    const csrf = document.querySelector('meta[name="csrf-token"]');
    fetch('/notifications/read-all', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf ? csrf.content : ''
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) return response.json().then(d => { throw new Error(d && d.error ? d.error : 'Request failed'); });
        return response.json();
    })
    .then(data => {
        if (data && data.success) {
            const unreadNotifications = document.querySelectorAll('.notification-item-full.unread');
            unreadNotifications.forEach(el => el.classList.remove('unread'));
            loadNotifications();
            showToast('All notifications marked as read', 'success');
        } else {
            showToast('Failed to mark notifications as read', 'error');
        }
    })
    .catch(() => {
        showToast('Failed to mark notifications as read', 'error');
    });
}

// Ensure mobile hamburger works on this page too
document.addEventListener('DOMContentLoaded', function() {
    const toggler = document.getElementById('navbar-toggler');
    const menu = document.getElementById('navbar-menu');
    if (toggler && menu && !toggler.__fhv3Bound) {
        toggler.addEventListener('click', function(e) {
            e.stopPropagation();
            menu.classList.toggle('active');
        });
        document.addEventListener('click', function(e) {
            if (menu.classList.contains('active') && !menu.contains(e.target) && e.target !== toggler) {
                menu.classList.remove('active');
            }
        });
        toggler.__fhv3Bound = true;
    }
});

function clearAllNotifications() {
    if (confirm('Are you sure you want to clear all notifications? This action cannot be undone.')) {
        fetch('/notifications/clear-all', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Reload notifications
                loadNotifications();
                showToast('All notifications cleared', 'success');
            }
        })
        .catch(error => {
            console.error('Error clearing notifications:', error);
            showToast('Failed to clear notifications', 'error');
        });
    }
}

function getNotificationIcon(type) {
    const icons = {
        'booking': 'fa-calendar-check',
        'system': 'fa-cog',
        'payment': 'fa-credit-card',
        'promo': 'fa-tag',
        'room': 'fa-bed',
        'default': 'fa-bell'
    };
    return icons[type] || icons['default'];
}

function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diff = now - date;
    
    const seconds = Math.floor(diff / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    const days = Math.floor(hours / 24);
    
    if (days > 0) {
        return `${days} day${days > 1 ? 's' : ''} ago`;
    } else if (hours > 0) {
        return `${hours} hour${hours > 1 ? 's' : ''} ago`;
    } else if (minutes > 0) {
        return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
    } else {
        return 'Just now';
    }
}

function showToast(message, type = 'info') {
    // Create a simple toast notification
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#4caf50' : type === 'error' ? '#f44336' : '#2196f3'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 9999;
        font-weight: 500;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
