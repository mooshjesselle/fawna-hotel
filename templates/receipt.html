{% extends "base.html" %}

{% block content %}
<div class="container{% if not request.args.get('modal') %} mt-4{% endif %} receipt-container">
    <!-- Special style to hide navbar and footer when loaded in modal or PDF mode -->
    {% if request.args.get('modal') or request.args.get('pdf') %}
    <style>
        /* Reset all margins and paddings */
        * {
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Exception for table cells and certain elements that need padding */
        td, th, .table-responsive, .p-4 {
            padding: 4px !important;
        }
        
        .d-flex, .receipt-main {
            padding: 2px !important;
        }
        
        .mb-4, .my-4, .mt-4, .py-4, .pt-4 {
            margin: 0 !important;
            padding: 0 !important;
        }
        
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            height: auto !important;
            overflow: auto !important;
        }
        
        .navbar, .footer, header, footer, .btn-primary, .admin-sidebar, .admin-header {
            display: none !important;
        }
        
        body {
            background: white !important;
        }
        
        .container, .receipt-container {
            max-width: 100% !important;
            width: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        
        .receipt-main {
            box-shadow: none !important;
            border-radius: 0 !important;
            margin: 0 !important;
            max-width: 100% !important;
        }
        
        h1 {
            margin: 0 !important;
            padding: 0 !important;
            font-size: 1.5rem !important;
        }
        
        .admin-main {
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .text-center {
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Allow table cells to have proper spacing but reduced */
        table, tr, td, th {
            border-spacing: 0 !important;
            padding: 3px !important;
        }
        
        /* Hide the print button div in modal view */
        .no-print {
            display: none !important;
        }
        
        /* Ensure content starts at absolute top */
        #content, main {
            padding: 0 !important;
            margin: 0 !important;
        }

        /* Reduce spacing in the information sections */
        .table-borderless td {
            padding: 2px !important;
        }

        /* Make text slightly smaller in modal */
        .table, .text-muted, .fw-bold {
            font-size: 0.9rem !important;
        }
    </style>
    {% endif %}

    {% if request.args.get('pdf') %}
    <style>
        /* Special styles for PDF-only mode */
        body {
            background: white !important;
            width: 100% !important;
            height: 100% !important;
            overflow: visible !important;
        }
        
        .receipt-main {
            font-size: 1.1rem !important;
            padding: 15px !important;
        }
        
        .receipt-main h1 {
            font-size: 1.8rem !important;
            margin-bottom: 15px !important;
        }
        
        .receipt-main .table {
            font-size: 1.1rem !important;
        }
        
        .receipt-main .text-muted {
            font-size: 1rem !important;
        }
        
        /* Ensure the receipt is centered and properly sized for PDF */
        .receipt-container {
            display: flex !important;
            justify-content: center !important;
            align-items: flex-start !important;
            padding: 15px !important;
        }
    </style>
    {% endif %}

    <div class="receipt-main bg-white p-4 shadow-sm" style="max-width: 900px; margin: 0 auto; font-family: 'Segoe UI', Arial, sans-serif;">
        <!-- Print button (hidden on print and in modal) -->
        {% if not request.args.get('modal') and not request.args.get('pdf') %}
        <div class="text-end mb-4 no-print">
            <button onclick="window.print()" class="btn btn-primary">
                <i class="fas fa-print"></i> Print Receipt
            </button>
        </div>
        {% endif %}

        <!-- RECEIPT TITLE -->
        <div class="text-center{% if not request.args.get('modal') and not request.args.get('pdf') %} mb-4{% endif %}">
            <h1 style="letter-spacing: 2px; font-weight: 600; color: #6D4C41;">RECEIPT</h1>
        </div>

        <!-- Top Info Row: Flexbox for side-by-side layout -->
        <div class="d-flex flex-row flex-wrap justify-content-between{% if not request.args.get('modal') and not request.args.get('pdf') %} mb-4{% endif %}" style="gap: {% if request.args.get('modal') or request.args.get('pdf') %}0.5rem{% else %}2rem{% endif %};">
            <div style="min-width: 300px; flex: 1 1 300px;">
                <table class="table table-borderless mb-0" style="font-size: {% if request.args.get('modal') or request.args.get('pdf') %}0.95rem{% else %}1rem{% endif %};">
                    <tr>
                        <td class="fw-bold" style="width: 130px;">TRANSACTION ID</td>
                        <td>{{ '%06d' % booking.id }}</td>
                    </tr>
                    <tr>
                        <td class="fw-bold">RECEIPT DATE</td>
                        <td>{{ approval_date }}</td>
                    </tr>
                    <tr>
                        <td class="fw-bold">PAYMENT METHOD</td>
                        <td>
                            {% if booking.payment_method == 'pay_on_site' %}
                                Pay on Site
                            {% elif booking.payment_method == 'gcash' %}
                                GCash
                            {% elif booking.payment_method == 'paymaya' %}
                                PayMaya
                            {% elif booking.payment_method == 'qr_payment' %}
                                QR Payment
                            {% else %}
                                {{ booking.payment_method|title }}
                            {% endif %}
                        </td>
                    </tr>
                    <tr><td colspan="2" style="height: {% if request.args.get('modal') or request.args.get('pdf') %}5px{% else %}10px{% endif %};"></td></tr>
                    <tr><td class="fw-bold" colspan="2">PAID BY: </td></tr>
                    <tr>
                        <td class="fw-bold">Name</td>
                        <td>{{ booking.user.name }}</td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Phone</td>
                        <td>{{ booking.user.phone }}</td>
                    </tr>
                    <tr>
                        <td class="fw-bold">Email</td>
                        <td>{{ booking.user.email }}</td>
                    </tr>
                </table>
            </div>
            <div style="min-width: 260px; flex: 1 1 260px; text-align: left;">
                <div class="fw-bold" style="font-size: 1.1rem; color: #6D4C41;">Fawna Hotel</div>
                <div><span class="fw-bold">Address:</span> Fawna Hotel, Santa Cruz, Laguna</div>
                <div><span class="fw-bold">Contact:</span> +63 993 267 0873</div>
                <div><span class="fw-bold">Email:</span> fawnahotel@gmail.com</div>
            </div>
        </div>

        <!-- Table of Charges -->
        <div class="table-responsive{% if not request.args.get('modal') and not request.args.get('pdf') %} mb-4{% endif %}">
            <table class="table table-bordered align-middle" style="font-size: {% if request.args.get('modal') or request.args.get('pdf') %}0.9rem{% else %}1rem{% endif %};">
                <thead class="table-light">
                    <tr>
                        <th>DESCRIPTION</th>
                        <th style="width: 120px;">UNIT COST</th>
                        <th style="width: 100px;">QUANTITY</th>
                        <th style="width: 120px;">AMOUNT</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Room: {{ booking.room.room_type.name }} (Room {{ booking.room.room_number }})<br>
                            <small>Check-in: {{ check_in }}<br>Check-out: {{ check_out }}</small>
                        </td>
                        <td>₱{{ '%.2f'|format(price_per_night) }}</td>
                        <td>{{ nights }}</td>
                        <td>₱{{ '%.2f'|format(room_total) }}</td>
                    </tr>
                    {% if booking.selected_amenities %}
                        {% for amenity in booking.selected_amenities %}
                            {% set amenity_cost = (amenity.additional_cost or 0) * nights %}
                            {% if amenity_cost > 0 %}
                            <tr>
                                <td>Amenity: {{ amenity.name }}</td>
                                <td>₱{{ '%.2f'|format(amenity.additional_cost or 0) }}</td>
                                <td>{{ nights }}</td>
                                <td>₱{{ '%.2f'|format(amenity_cost) }}</td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="text-end">Room Subtotal</td>
                        <td>₱{{ '%.2f'|format(room_total) }}</td>
                    </tr>
                    {% if amenities_total and amenities_total > 0 %}
                    <tr>
                        <td colspan="3" class="text-end">Amenities</td>
                        <td>₱{{ '%.2f'|format(amenities_total) }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td colspan="3" class="text-end">VAT rate (%)</td>
                        <td>0%</td>
                    </tr>
                    <tr>
                        <td colspan="3" class="text-end">VAT</td>
                        <td>₱0.00</td>
                    </tr>
                    <tr style="background: #f7f3e8; font-weight: bold;">
                        <td colspan="3" class="text-end">Total</td>
                        <td>₱{{ '%.2f'|format(total_price) }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Additional Information -->
        <div{% if not request.args.get('modal') and not request.args.get('pdf') %} class="mt-4"{% endif %} style="font-size: {% if request.args.get('modal') or request.args.get('pdf') %}0.85rem{% else %}0.97rem{% endif %};">
            <div class="fw-bold{% if not request.args.get('modal') and not request.args.get('pdf') %} mb-1{% endif %}">ADDITIONAL INFORMATION</div>
            <div class="text-muted">Check-in: 2:00 PM | Check-out: 12:00 NN. Please bring a valid ID upon arrival. For house rules and more, visit our website.</div>
        </div>
    </div>
</div>

<style>
    /* Hide header/footer and print button on print */
    @media print {
        .no-print, .navbar, .footer, header, footer {
            display: none !important;
        }
        .receipt-main {
            box-shadow: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        body {
            background: white !important;
        }
        .container {
            max-width: 100% !important;
            padding: 0 !important;
        }
    }
    
    /* Special styles for PDF generation */
    .receipt-container {
        width: 100%;
        overflow: visible !important;
    }
    
    .receipt-main {
        overflow: visible !important;
        page-break-inside: avoid;
        width: 100%;
        max-width: 100% !important;
    }
    
    .receipt-main th, .receipt-main td {
        vertical-align: middle;
    }
    
    /* Fixed width for the PAID BY section to prevent layout issues */
    .receipt-main .table-borderless td:first-child {
        width: 130px !important;
        min-width: 130px !important;
    }
    
    .receipt-main th {
        background: #f7f3e8;
        color: #6D4C41;
        font-weight: 600;
    }
    
    .receipt-main .fw-bold {
        color: #6D4C41;
    }
    
    /* Ensure flex row does not stack on print or desktop */
    @media (min-width: 600px), print {
        .receipt-main .d-flex {
            flex-wrap: nowrap !important;
        }
    }
    
    /* Tables should never be cut across pages */
    table {
        page-break-inside: avoid;
    }
    
    /* For PDF generation, ensure all content is visible */
    @media screen {
        body.pdf-mode, 
        body.pdf-mode .receipt-container, 
        body.pdf-mode .receipt-main {
            width: 100% !important;
            max-width: 100% !important;
            overflow: visible !important;
        }
    }

    /* Additional adjustments for modal view to prevent content overflow */
    @media screen and (max-width: 768px) {
        .receipt-main {
            transform: scale(0.95);
            transform-origin: top center;
        }
    }
    
    /* Fix for modal shifting after PDF download */
    .modal {
        position: fixed !important;
        left: 0 !important;
        right: 0 !important;
        margin: 0 auto !important;
    }
    
    .modal-dialog {
        margin: 1.75rem auto !important;
    }
</style>

<!-- Additional styles for PDF generation to ensure content is larger -->
<style>
    @media print, screen and (min-width: 768px) {
        .receipt-main {
            font-size: 1.1rem !important;
        }
        
        .receipt-main h1 {
            font-size: 1.8rem !important;
        }
        
        .receipt-main .table {
            font-size: 1.1rem !important;
        }
        
        .receipt-main .text-muted {
            font-size: 1rem !important;
        }
    }
</style>

{% if request.args.get('modal') %}
<script>
    // Script to ensure no margins in iframe
    document.addEventListener('DOMContentLoaded', function() {
        document.body.style.margin = '0';
        document.body.style.padding = '0';
        document.documentElement.style.margin = '0';
        document.documentElement.style.padding = '0';
        
        // Add class for PDF generation if this is in a modal
        if (window.location.href.includes('modal=1')) {
            document.body.classList.add('pdf-mode');
        }
    });
</script>
{% endif %}

{% if request.args.get('pdf') %}
<script>
    // Script for PDF-only mode
    document.addEventListener('DOMContentLoaded', function() {
        document.body.style.margin = '0';
        document.body.style.padding = '0';
        document.documentElement.style.margin = '0';
        document.documentElement.style.padding = '0';
        document.body.classList.add('pdf-mode');
        document.title = 'Receipt-{{ booking.id }}';
        
        // Auto-download PDF if requested
        if (window.location.href.includes('autodownload=1')) {
            // Load html2pdf if needed
            if (typeof html2pdf === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
                script.onload = function() {
                    generatePDFAndDownload();
                };
                document.head.appendChild(script);
            } else {
                generatePDFAndDownload();
            }
        }
        
        function generatePDFAndDownload() {
            // Match admin page settings exactly
            const options = {
                margin: 10,
                filename: 'Receipt-{{ booking.id }}.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            const receiptContent = document.querySelector('.receipt-main');
            
            // Generate PDF and close window after download starts
            html2pdf().from(receiptContent).set(options).save().then(() => {
                // Close the window after a delay to allow download to start
                setTimeout(() => {
                    window.close();
                }, 1000);
            });
        }
    });
</script>
{% endif %}
{% endblock %} 